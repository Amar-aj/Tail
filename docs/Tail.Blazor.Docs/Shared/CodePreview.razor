@namespace Tail.Blazor.Docs.Shared
@inject IJSRuntime JS

<div class="@GetContainerClasses()">
    @if (!string.IsNullOrEmpty(Title))
    {
        <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200 dark:border-gray-700">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">@Title</h4>
            @if (ShowCopyButton)
            {
                <button 
                    type="button"
                    class="@GetCopyButtonClasses()"
                    @onclick="CopyToClipboard"
                    title="Copy code">
                    @if (copied)
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span class="ml-1">Copied!</span>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="ml-1">Copy</span>
                    }
                </button>
            }
        </div>
    }
    
    @if (ShowPreview)
    {
        <div class="@GetPreviewClasses()">
            @if (PreviewContent != null)
            {
                @PreviewContent
            }
            else
            {
                @ChildContent
            }
        </div>
    }
    
    @if (ShowCode)
    {
        <div class="relative">
            @if (!ShowPreview && ShowCopyButton)
            {
                <button 
                    type="button"
                    class="@GetInlineCodeCopyClasses()"
                    @onclick="CopyToClipboard"
                    title="Copy code">
                    @if (copied)
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    }
                </button>
            }
            <pre class="@GetCodeClasses()"><code class="@GetCodeLanguageClass()">@Code</code></pre>
        </div>
    }
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string Code { get; set; } = string.Empty;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? PreviewContent { get; set; }
    [Parameter] public bool ShowPreview { get; set; } = true;
    [Parameter] public bool ShowCode { get; set; } = true;
    [Parameter] public bool ShowCopyButton { get; set; } = true;
    [Parameter] public string Language { get; set; } = "razor";
    [Parameter] public string? CssClass { get; set; }
    
    private bool copied = false;
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden mb-6" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetPreviewClasses()
    {
        return "p-6 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700";
    }
    
    private string GetCodeClasses()
    {
        return "bg-gray-900 text-gray-100 p-4 overflow-x-auto text-sm rounded-none m-0";
    }
    
    private string GetCodeLanguageClass()
    {
        return $"language-{Language}";
    }
    
    private string GetCopyButtonClasses()
    {
        var classes = new List<string>
        {
            "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md",
            "transition-colors duration-200"
        };
        
        if (copied)
        {
            classes.Add("bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300");
        }
        else
        {
            classes.Add("bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300");
            classes.Add("hover:bg-gray-200 dark:hover:bg-gray-600");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetInlineCodeCopyClasses()
    {
        var classes = new List<string>
        {
            "absolute top-2 right-2 p-2 rounded-md",
            "bg-gray-700 hover:bg-gray-600 text-gray-300",
            "transition-colors duration-200"
        };
        
        if (copied)
        {
            classes.Add("bg-green-700 hover:bg-green-600");
        }
        
        return string.Join(" ", classes);
    }
    
    private async Task CopyToClipboard()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", Code);
            copied = true;
            StateHasChanged();
            
            // Reset after 2 seconds
            await Task.Delay(2000);
            copied = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to copy: {ex.Message}");
        }
    }
}
