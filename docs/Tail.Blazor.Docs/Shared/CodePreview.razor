@namespace Tail.Blazor.Docs.Shared
@inject IJSRuntime JS

<div class="@GetContainerClasses()">
    @if (!string.IsNullOrEmpty(Title))
    {
        <div class="flex items-center justify-between mb-3 pb-2 border-b" style="border-color: var(--color-border)">
            <h4 class="text-sm font-semibold" style="color: var(--color-text-primary)">@Title</h4>
            @if (ShowCopyButton)
            {
                <button 
                    type="button"
                    class="@GetCopyButtonClasses()"
                    style="@GetCopyButtonStyles()"
                    @onclick="CopyToClipboard"
                    title="Copy code">
                    @if (copied)
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span class="ml-1">Copied!</span>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="ml-1">Copy</span>
                    }
                </button>
            }
        </div>
    }
    
    @if (ShowPreview)
    {
        <div class="@GetPreviewClasses()" style="@GetPreviewStyles()">
            @if (PreviewContent != null)
            {
                @PreviewContent
            }
            else
            {
                @ChildContent
            }
        </div>
    }
    
    @if (ShowCode)
    {
        <div class="relative">
            @if (!ShowPreview && ShowCopyButton)
            {
                <button 
                    type="button"
                    class="@GetInlineCodeCopyClasses()"
                    style="@GetInlineCodeCopyStyles()"
                    @onclick="CopyToClipboard"
                    title="Copy code">
                    @if (copied)
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    }
                    else
                    {
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    }
                </button>
            }
            <pre class="@GetCodeClasses()" style="@GetCodeStyles()"><code class="@GetCodeLanguageClass()">@Code</code></pre>
        </div>
    }
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string Code { get; set; } = string.Empty;
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? PreviewContent { get; set; }
    [Parameter] public bool ShowPreview { get; set; } = true;
    [Parameter] public bool ShowCode { get; set; } = true;
    [Parameter] public bool ShowCopyButton { get; set; } = true;
    [Parameter] public string Language { get; set; } = "razor";
    [Parameter] public string? CssClass { get; set; }
    
    private bool copied = false;
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "rounded-lg border overflow-hidden mb-6" };
        classes.Add("border-[var(--color-border)]");
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetPreviewClasses()
    {
        return "p-6 border-b";
    }
    
    private string GetPreviewStyles()
    {
        return "background-color: var(--color-surface); border-color: var(--color-border);";
    }
    
    private string GetCodeClasses()
    {
        return "p-4 overflow-x-auto text-sm rounded-none m-0";
    }
    
    private string GetCodeStyles()
    {
        return "background-color: var(--color-surface-inverse, #1f2937); color: var(--color-text-on-inverse, #f3f4f6);";
    }
    
    private string GetCodeLanguageClass()
    {
        return $"language-{Language}";
    }
    
    private string GetCopyButtonClasses()
    {
        var classes = new List<string>
        {
            "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md",
            "transition-colors duration-200"
        };
        
        return string.Join(" ", classes);
    }
    
    private string GetCopyButtonStyles()
    {
        if (copied)
        {
            return "background-color: var(--color-success-light, #d1fae5); color: var(--color-success-dark, #065f46);";
        }
        return "background-color: var(--color-surface-secondary, #f3f4f6); color: var(--color-text-secondary, #6b7280);";
    }
    
    private string GetInlineCodeCopyClasses()
    {
        return "absolute top-2 right-2 p-2 rounded-md transition-colors duration-200";
    }
    
    private string GetInlineCodeCopyStyles()
    {
        if (copied)
        {
            return "background-color: var(--color-success, #10b981); color: var(--color-text-on-primary, white);";
        }
        return "background-color: var(--color-surface-inverse, #374151); color: var(--color-text-on-inverse, #d1d5db);";
    }
    
    private async Task CopyToClipboard()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", Code);
            copied = true;
            StateHasChanged();
            
            // Reset after 2 seconds
            await Task.Delay(2000);
            copied = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to copy: {ex.Message}");
        }
    }
}
