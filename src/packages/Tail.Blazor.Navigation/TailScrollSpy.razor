@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Navigation
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Tail.Blazor.Navigation.Models
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetContainerClasses()" style="@GetContainerStyle()" @attributes="AdditionalAttributes">
    <nav class="@GetNavClasses()" style="@GetNavStyle()">
        @foreach (var item in Items)
        {
            <a 
                href="#@item.TargetId"
                class="@GetItemClasses(item)"
                style="@GetItemStyle(item)"
                @onclick="(e) => HandleItemClick(e, item)"
                @onclick:preventDefault="true">
                @if (!string.IsNullOrEmpty(item.Icon))
                {
                    <span class="mr-2">@item.Icon</span>
                }
                <span>@item.Label</span>
            </a>
        }
    </nav>
</div>

@code {
    [Parameter] public List<ScrollSpyItem> Items { get; set; } = new();
    [Parameter] public ScrollSpyMode Mode { get; set; } = ScrollSpyMode.Smooth;
    [Parameter] public ScrollSpyHighlightStyle HighlightStyle { get; set; } = ScrollSpyHighlightStyle.Underline;
    [Parameter] public int ScrollOffset { get; set; } = 0; // Offset in pixels for scroll position
    [Parameter] public int Threshold { get; set; } = 50; // Percentage of element visible to activate
    [Parameter] public bool ShowActiveIndicator { get; set; } = true;
    [Parameter] public EventCallback<ScrollSpyItem> OnItemActivated { get; set; }

    private string scrollSpyId = $"scrollspy-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private ScrollSpyItem? activeItem;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Navigation/scrollspy.js");
                await jsModule.InvokeVoidAsync("initializeScrollSpy", scrollSpyId, DotNetObjectReference.Create(this), Items.Select(i => i.TargetId).ToArray(), ScrollOffset, Threshold);
            }
            catch { }
        }
    }

    private async Task HandleItemClick(MouseEventArgs e, ScrollSpyItem item)
    {
        if (jsModule == null) return;

        try
        {
            var offset = item.Offset ?? ScrollOffset;
            await jsModule.InvokeVoidAsync("scrollToElement", item.TargetId, offset, Mode.ToString());
        }
        catch { }
    }

    [JSInvokable]
    public void OnSectionActivated(string targetId)
    {
        var item = Items.FirstOrDefault(i => i.TargetId == targetId);
        if (item != null && item != activeItem)
        {
            // Update active state
            foreach (var i in Items)
            {
                i.IsActive = false;
            }
            item.IsActive = true;
            activeItem = item;

            if (OnItemActivated.HasDelegate)
            {
                OnItemActivated.InvokeAsync(item);
            }

            StateHasChanged();
        }
    }

    // Styling methods
    private string GetContainerClasses() => "sticky top-0 z-50";
    private string GetContainerStyle() => "background-color: var(--color-surface); border-bottom: 1px solid var(--color-border);";

    private string GetNavClasses() => "flex space-x-1 overflow-x-auto py-2 px-4";
    private string GetNavStyle() => "";

    private string GetItemClasses(ScrollSpyItem item)
    {
        var classes = new List<string> { "px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 whitespace-nowrap" };
        
        if (item.IsActive && ShowActiveIndicator)
        {
            classes.Add(HighlightStyle switch
            {
                ScrollSpyHighlightStyle.Underline => "border-b-2",
                ScrollSpyHighlightStyle.Background => "bg-opacity-20",
                ScrollSpyHighlightStyle.Border => "border-2",
                ScrollSpyHighlightStyle.Badge => "relative",
                _ => ""
            });
        }

        return string.Join(" ", classes);
    }

    private string GetItemStyle(ScrollSpyItem item)
    {
        var styles = new List<string>();

        if (item.IsActive && ShowActiveIndicator)
        {
            switch (HighlightStyle)
            {
                case ScrollSpyHighlightStyle.Underline:
                    styles.Add("border-color: var(--color-primary);");
                    styles.Add("color: var(--color-primary);");
                    break;
                case ScrollSpyHighlightStyle.Background:
                    styles.Add("background-color: color-mix(in srgb, var(--color-primary) 20%, transparent);");
                    styles.Add("color: var(--color-primary);");
                    break;
                case ScrollSpyHighlightStyle.Border:
                    styles.Add("border-color: var(--color-primary);");
                    styles.Add("color: var(--color-primary);");
                    break;
                case ScrollSpyHighlightStyle.Badge:
                    styles.Add("color: var(--color-primary);");
                    break;
            }
        }
        else
        {
            styles.Add("color: var(--color-text-secondary);");
            styles.Add("hover:color: var(--color-text-primary);");
        }

        return string.Join(" ", styles);
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.InvokeVoidAsync("disposeScrollSpy", scrollSpyId);
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

