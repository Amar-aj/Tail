@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Navigation
@using Microsoft.AspNetCore.Components.Web
@using Tail.Blazor.Navigation.Models

<div class="@GetContainerClasses()" style="@GetContainerStyle()" @attributes="AdditionalAttributes">
    <!-- Trigger Button -->
    <button
        type="button"
        class="@GetTriggerClasses()"
        style="@GetTriggerStyle()"
        @onclick="ToggleMenu"
        @onmouseenter="HandleMouseEnter"
        aria-expanded="@IsOpen.ToString().ToLower()"
        aria-haspopup="true">
        @if (!string.IsNullOrEmpty(TriggerIcon))
        {
            <span class="mr-2">@TriggerIcon</span>
        }
        <span>@TriggerText</span>
        @if (ShowArrow)
        {
            <svg class="@GetArrowClasses()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        }
    </button>

    <!-- Mega Menu Dropdown -->
    @if (IsOpen)
    {
        <div 
            class="@GetMenuClasses()"
            style="@GetMenuStyle()"
            @onmouseleave="HandleMouseLeave">
            <div class="@GetMenuContentClasses()" style="@GetMenuContentStyle()">
                @if (Columns != null && Columns.Any())
                {
                    <div class="@GetColumnsContainerClasses()">
                        @foreach (var column in Columns)
                        {
                            <div class="@GetColumnClasses()" style="@GetColumnStyle(column)">
                                <!-- Column Header -->
                                @if (!string.IsNullOrEmpty(column.Title))
                                {
                                    <div class="@GetColumnHeaderClasses()" style="@GetColumnHeaderStyle()">
                                        @if (!string.IsNullOrEmpty(column.Icon))
                                        {
                                            <span class="mr-2">@column.Icon</span>
                                        }
                                        <h3 class="@GetColumnTitleClasses()" style="@GetColumnTitleStyle()">@column.Title</h3>
                                    </div>
                                }

                                <!-- Custom Content -->
                                @if (column.CustomContent != null)
                                {
                                    <div class="@GetCustomContentClasses()">
                                        @column.CustomContent
                                    </div>
                                }

                                <!-- Column Items -->
                                @if (column.Items != null && column.Items.Any())
                                {
                                    <ul class="@GetItemsListClasses()">
                                        @foreach (var item in column.Items)
                                        {
                                            <li class="@GetItemClasses(item)">
                                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                                {
                                                    <div class="@GetItemImageClasses()">
                                                        <img src="@item.ImageUrl" alt="@item.Text" class="w-full h-32 object-cover rounded-md mb-2" />
                                                    </div>
                                                }
                                                <a
                                                    href="@item.Href"
                                                    class="@GetItemLinkClasses(item)"
                                                    style="@GetItemLinkStyle(item)"
                                                    @onclick="() => HandleItemClick(item)"
                                                    @onclick:preventDefault="@(!string.IsNullOrEmpty(item.Href))">
                                                    <div class="flex items-start">
                                                        @if (!string.IsNullOrEmpty(item.Icon))
                                                        {
                                                            <span class="@GetItemIconClasses()">@item.Icon</span>
                                                        }
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2">
                                                                <span class="@GetItemTextClasses()" style="@GetItemTextStyle()">@item.Text</span>
                                                                @if (item.IsNew)
                                                                {
                                                                    <span class="@GetNewBadgeClasses()" style="@GetNewBadgeStyle()">New</span>
                                                                }
                                                                @if (item.IsHot)
                                                                {
                                                                    <span class="@GetHotBadgeClasses()" style="@GetHotBadgeStyle()">Hot</span>
                                                                }
                                                                @if (!string.IsNullOrEmpty(item.Badge))
                                                                {
                                                                    <span class="@GetBadgeClasses()" style="@GetBadgeStyle()">@item.Badge</span>
                                                                }
                                                            </div>
                                                            @if (!string.IsNullOrEmpty(item.Description))
                                                            {
                                                                <p class="@GetItemDescriptionClasses()" style="@GetItemDescriptionStyle()">@item.Description</p>
                                                            }
                                                        </div>
                                                    </div>
                                                </a>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        }
                    </div>
                }
                else if (CustomContent != null)
                {
                    <div class="@GetCustomContentClasses()">
                        @CustomContent
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string TriggerText { get; set; } = "Menu";
    [Parameter] public string? TriggerIcon { get; set; }
    [Parameter] public List<MegaMenuColumn>? Columns { get; set; }
    [Parameter] public RenderFragment? CustomContent { get; set; }
    [Parameter] public MegaMenuPlacement Placement { get; set; } = MegaMenuPlacement.Bottom;
    [Parameter] public MegaMenuAlignment Alignment { get; set; } = MegaMenuAlignment.Left;
    [Parameter] public bool ShowArrow { get; set; } = true;
    [Parameter] public bool ShowMenuOnHover { get; set; } = false;
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback<MegaMenuItem> OnItemClick { get; set; }

    private void ToggleMenu()
    {
        IsOpen = !IsOpen;
        IsOpenChanged.InvokeAsync(IsOpen);
    }

    private void HandleMouseEnter()
    {
        if (ShowMenuOnHover)
        {
            OpenMenu();
        }
    }

    private void HandleMouseLeave()
    {
        if (ShowMenuOnHover)
        {
            CloseMenu();
        }
    }

    private void OpenMenu()
    {
        if (!IsOpen)
        {
            IsOpen = true;
            IsOpenChanged.InvokeAsync(true);
        }
    }

    private void CloseMenu()
    {
        if (IsOpen)
        {
            IsOpen = false;
            IsOpenChanged.InvokeAsync(false);
        }
    }

    private async Task HandleItemClick(MegaMenuItem item)
    {
        if (item.Disabled) return;

        await item.OnClick.InvokeAsync(item);
        if (OnItemClick.HasDelegate)
        {
            await OnItemClick.InvokeAsync(item);
        }

        // Close menu after click (unless ShowMenuOnHover is true)
        if (!ShowMenuOnHover)
        {
            CloseMenu();
        }
    }

    // Styling methods
    private string GetContainerClasses() => "relative inline-block";
    private string GetContainerStyle() => "";

    private string GetTriggerClasses()
    {
        var classes = new List<string> { "flex items-center px-4 py-2 rounded-md transition-colors duration-150" };
        if (IsOpen)
        {
            classes.Add("bg-blue-50 dark:bg-blue-900/20");
        }
        else
        {
            classes.Add("hover:bg-gray-100 dark:hover:bg-gray-800");
        }
        return string.Join(" ", classes);
    }

    private string GetTriggerStyle() => "color: var(--color-text-primary);";

    private string GetArrowClasses() => $"w-4 h-4 ml-2 transition-transform duration-200 {(IsOpen ? "rotate-180" : "")}";

    private string GetMenuClasses()
    {
        var classes = new List<string> { "absolute z-50 mt-2 rounded-lg shadow-xl border transition-all duration-200" };
        classes.Add(Placement == MegaMenuPlacement.Top ? "bottom-full mb-2" : "top-full");
        return string.Join(" ", classes);
    }

    private string GetMenuStyle()
    {
        var alignment = Alignment switch
        {
            MegaMenuAlignment.Left => "left: 0;",
            MegaMenuAlignment.Right => "right: 0;",
            MegaMenuAlignment.Center => "left: 50%; transform: translateX(-50%);",
            MegaMenuAlignment.FullWidth => "left: 0; right: 0; width: 100vw;",
            _ => "left: 0;"
        };
        return $"background-color: var(--color-surface); border-color: var(--color-border); box-shadow: var(--shadow-lg); {alignment}";
    }

    private string GetMenuContentClasses() => "p-6";
    private string GetMenuContentStyle() => "";

    private string GetColumnsContainerClasses() => "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
    private string GetColumnClasses() => "min-w-0";
    private string GetColumnStyle(MegaMenuColumn column)
    {
        var totalWidth = Columns?.Sum(c => c.Width) ?? 1;
        var widthPercent = (column.Width / (double)totalWidth) * 100;
        return $"width: {widthPercent}%;";
    }

    private string GetColumnHeaderClasses() => "flex items-center mb-4 pb-2 border-b";
    private string GetColumnHeaderStyle() => "border-color: var(--color-border);";
    private string GetColumnTitleClasses() => "text-lg font-semibold";
    private string GetColumnTitleStyle() => "color: var(--color-text-primary);";

    private string GetCustomContentClasses() => "";
    private string GetItemsListClasses() => "space-y-2";
    private string GetItemClasses(MegaMenuItem item) => item.Disabled ? "opacity-50 cursor-not-allowed" : "";
    private string GetItemImageClasses() => "mb-2";
    private string GetItemLinkClasses(MegaMenuItem item)
    {
        var classes = new List<string> { "block p-3 rounded-md transition-colors duration-150" };
        if (!item.Disabled)
        {
            classes.Add("hover:bg-gray-100 dark:hover:bg-gray-800");
        }
        return string.Join(" ", classes);
    }

    private string GetItemLinkStyle(MegaMenuItem item) => "";
    private string GetItemIconClasses() => "mr-3 text-xl flex-shrink-0";
    private string GetItemTextClasses() => "font-medium";
    private string GetItemTextStyle() => "color: var(--color-text-primary);";
    private string GetItemDescriptionClasses() => "text-sm mt-1";
    private string GetItemDescriptionStyle() => "color: var(--color-text-secondary);";
    private string GetNewBadgeClasses() => "px-2 py-0.5 rounded text-xs font-medium";
    private string GetNewBadgeStyle() => "background-color: var(--color-success); color: white;";
    private string GetHotBadgeClasses() => "px-2 py-0.5 rounded text-xs font-medium";
    private string GetHotBadgeStyle() => "background-color: var(--color-danger); color: white;";
    private string GetBadgeClasses() => "px-2 py-0.5 rounded text-xs font-medium";
    private string GetBadgeStyle() => "background-color: var(--color-surface-2); color: var(--color-text-primary); border: 1px solid var(--color-border);";
}

