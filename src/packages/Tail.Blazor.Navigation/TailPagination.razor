@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Navigation
@using Microsoft.AspNetCore.Components.Web

<nav class="@GetPaginationClasses()" aria-label="Pagination" @attributes="AdditionalAttributes">
    <div class="@GetContainerClasses()">
        <!-- Page Size Selector -->
        @if (ShowPageSizeSelector)
        {
            <div class="@GetPageSizeClasses()">
                <label class="@GetPageSizeLabelClasses()">Items per page:</label>
                <select 
                    class="@GetPageSizeSelectClasses()"
                    style="@GetPageSizeSelectStyle()"
                    @bind="PageSize"
                    @bind:after="OnPageSizeChanged">
                    @foreach (var size in PageSizeOptions)
                    {
                        <option value="@size">@size</option>
                    }
                </select>
            </div>
        }
        
        <!-- Info Display -->
        @if (ShowInfo)
        {
            <div class="@GetInfoClasses()" style="@GetInfoStyle()">
                Showing <strong>@GetStartItem()</strong> to <strong>@GetEndItem()</strong> of <strong>@TotalItems</strong> items
            </div>
        }
        
        <!-- Navigation Buttons -->
        <div class="@GetNavigationClasses()">
            <button
                type="button"
                class="@GetButtonClasses()"
                style="@GetButtonStyle()"
                @onclick="GoToFirstPage"
                disabled="@(CurrentPage == 1)"
                aria-label="First page">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                </svg>
            </button>
            <button
                type="button"
                class="@GetButtonClasses()"
                style="@GetButtonStyle()"
                @onclick="GoToPreviousPage"
                disabled="@(CurrentPage == 1)"
                aria-label="Previous page">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            
            <!-- Page Numbers -->
            <div class="@GetPagesClasses()">
                @foreach (var pageNumber in GetVisiblePages())
                {
                    @if (pageNumber == -1)
                    {
                        <span class="@GetEllipsisClasses()">...</span>
                    }
                    else
                    {
                        <button
                            type="button"
                            class="@GetPageButtonClasses(pageNumber)"
                            style="@GetPageButtonStyle(pageNumber)"
                            @onclick="() => GoToPage(pageNumber)"
                            aria-label="Page @pageNumber"
                            aria-current="@(pageNumber == CurrentPage ? "page" : null)">
                            @pageNumber
                        </button>
                    }
                }
            </div>
            
            <!-- Jump to Page -->
            @if (ShowJumpToPage)
            {
                <div class="@GetJumpToPageClasses()">
                    <label class="@GetJumpToPageLabelClasses()">Go to:</label>
                    <input 
                        type="number"
                        class="@GetJumpToPageInputClasses()"
                        style="@GetJumpToPageInputStyle()"
                        min="1"
                        max="@TotalPages"
                        value="@jumpToPageValue"
                        @oninput="HandleJumpInput"
                        @onkeydown="HandleJumpKeyDown" />
                </div>
            }
            
            <button
                type="button"
                class="@GetButtonClasses()"
                style="@GetButtonStyle()"
                @onclick="GoToNextPage"
                disabled="@(CurrentPage >= TotalPages)"
                aria-label="Next page">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <button
                type="button"
                class="@GetButtonClasses()"
                style="@GetButtonStyle()"
                @onclick="GoToLastPage"
                disabled="@(CurrentPage >= TotalPages)"
                aria-label="Last page">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>
</nav>

@code {
    [Parameter] public int CurrentPage { get; set; } = 1;
    [Parameter] public EventCallback<int> CurrentPageChanged { get; set; }
    [Parameter] public int TotalPages { get; set; } = 1;
    [Parameter] public int TotalItems { get; set; } = 0;
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public EventCallback<int> PageSizeChanged { get; set; }
    [Parameter] public bool ShowInfo { get; set; } = true;
    [Parameter] public bool ShowPageSizeSelector { get; set; } = true;
    [Parameter] public bool ShowJumpToPage { get; set; } = true;
    [Parameter] public List<int> PageSizeOptions { get; set; } = new() { 10, 25, 50, 100 };
    [Parameter] public int MaxVisiblePages { get; set; } = 5;

    private string? jumpToPageValue;

    protected override void OnInitialized()
    {
        jumpToPageValue = CurrentPage.ToString();
    }

    private async Task OnPageSizeChanged()
    {
        // Reset to first page when page size changes
        CurrentPage = 1;
        if (PageSizeChanged.HasDelegate)
        {
            await PageSizeChanged.InvokeAsync(PageSize);
        }
        if (CurrentPageChanged.HasDelegate)
        {
            await CurrentPageChanged.InvokeAsync(CurrentPage);
        }
    }

    private void HandleJumpInput(ChangeEventArgs e)
    {
        jumpToPageValue = e.Value?.ToString();
    }

    private async Task HandleJumpKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(jumpToPageValue))
        {
            if (int.TryParse(jumpToPageValue, out var page) && page >= 1 && page <= TotalPages)
            {
                await GoToPage(page);
            }
        }
    }

    private int GetStartItem()
    {
        return TotalItems == 0 ? 0 : (CurrentPage - 1) * PageSize + 1;
    }

    private int GetEndItem()
    {
        return Math.Min(CurrentPage * PageSize, TotalItems);
    }

    private List<int> GetVisiblePages()
    {
        var pages = new List<int>();
        
        if (TotalPages <= MaxVisiblePages)
        {
            for (int i = 1; i <= TotalPages; i++)
            {
                pages.Add(i);
            }
        }
        else
        {
            if (CurrentPage <= 3)
            {
                for (int i = 1; i <= 4; i++) pages.Add(i);
                pages.Add(-1); // Ellipsis
                pages.Add(TotalPages);
            }
            else if (CurrentPage >= TotalPages - 2)
            {
                pages.Add(1);
                pages.Add(-1); // Ellipsis
                for (int i = TotalPages - 3; i <= TotalPages; i++) pages.Add(i);
            }
            else
            {
                pages.Add(1);
                pages.Add(-1); // Ellipsis
                for (int i = CurrentPage - 1; i <= CurrentPage + 1; i++) pages.Add(i);
                pages.Add(-1); // Ellipsis
                pages.Add(TotalPages);
            }
        }
        
        return pages;
    }

    private async Task GoToPage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= TotalPages && pageNumber != CurrentPage)
        {
            CurrentPage = pageNumber;
            jumpToPageValue = CurrentPage.ToString();
            if (CurrentPageChanged.HasDelegate)
            {
                await CurrentPageChanged.InvokeAsync(CurrentPage);
            }
        }
    }

    private async Task GoToFirstPage()
    {
        await GoToPage(1);
    }

    private async Task GoToPreviousPage()
    {
        await GoToPage(CurrentPage - 1);
    }

    private async Task GoToNextPage()
    {
        await GoToPage(CurrentPage + 1);
    }

    private async Task GoToLastPage()
    {
        await GoToPage(TotalPages);
    }

    // Styling methods using global CSS variables
    private string GetPaginationClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }

    private string GetContainerClasses()
    {
        return "flex flex-col sm:flex-row items-center justify-between gap-4";
    }

    private string GetPageSizeClasses()
    {
        return "flex items-center gap-2";
    }

    private string GetPageSizeLabelClasses()
    {
        return "text-sm";
    }

    private string GetPageSizeSelectClasses()
    {
        return "px-3 py-1.5 rounded-lg border text-sm";
    }

    private string GetPageSizeSelectStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text-primary);
        ";
    }

    private string GetInfoClasses()
    {
        return "text-sm";
    }

    private string GetInfoStyle()
    {
        return "color: var(--color-text-secondary);";
    }

    private string GetNavigationClasses()
    {
        return "flex items-center gap-2";
    }

    private string GetButtonClasses()
    {
        return "px-3 py-2 rounded-lg border transition-colors disabled:opacity-50 disabled:cursor-not-allowed";
    }

    private string GetButtonStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text-primary);
        ";
    }

    private string GetPagesClasses()
    {
        return "flex items-center gap-1";
    }

    private string GetEllipsisClasses()
    {
        return "px-2 py-2 text-sm";
    }

    private string GetPageButtonClasses(int pageNumber)
    {
        var classes = new List<string> { "px-4 py-2 text-sm font-medium rounded-lg transition-colors" };
        
        if (pageNumber == CurrentPage)
        {
            classes.Add("text-white");
        }
        else
        {
            classes.Add("border");
        }
        
        return string.Join(" ", classes);
    }

    private string GetPageButtonStyle(int pageNumber)
    {
        if (pageNumber == CurrentPage)
        {
            return "background-color: var(--color-primary);";
        }
        else
        {
            return @"
                background-color: var(--color-surface);
                border-color: var(--color-border);
                color: var(--color-text-primary);
            ";
        }
    }

    private string GetJumpToPageClasses()
    {
        return "flex items-center gap-2";
    }

    private string GetJumpToPageLabelClasses()
    {
        return "text-sm";
    }

    private string GetJumpToPageInputClasses()
    {
        return "w-16 px-2 py-1.5 rounded-lg border text-sm text-center";
    }

    private string GetJumpToPageInputStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text-primary);
        ";
    }
}

