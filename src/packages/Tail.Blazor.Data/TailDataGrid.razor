@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data
@typeparam TItem
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetGridClasses()" @attributes="AdditionalAttributes">
    @if (ShowHeader)
    {
        <div class="@GetHeaderClasses()">
            <div class="flex items-center justify-between mb-4">
                @if (Title != null)
                {
                    <h3 class="text-lg font-semibold" style="color: var(--color-text-primary)">@Title</h3>
                }
                <div class="flex items-center gap-2">
                    @if (ShowSearch)
                    {
                        <input 
                            type="text" 
                            class="px-3 py-2 border rounded-lg"
                            style="background-color: var(--color-surface); border-color: var(--color-border); color: var(--color-text-primary)"
                            placeholder="Search..." 
                            @bind="searchText"
                            @bind:event="oninput" />
                    }
                    @if (AllowExport)
                    {
                        <button 
                            type="button"
                            class="px-3 py-2 text-sm font-medium rounded-lg transition-colors"
                            style="background-color: var(--color-primary); color: white;"
                            @onclick="ExportToExcel">
                            ðŸ“¥ Export Excel
                        </button>
                    }
                </div>
            </div>
        </div>
    }
    
    <div class="overflow-x-auto" id="@gridId">
        <table class="@GetTableClasses()">
            <thead class="@GetTheadClasses()" style="@GetTheadStyle()">
                @* Group Header Row *@
                @if (HasColumnGroups)
                {
                    <tr>
                        @if (SelectionMode != SelectionMode.None)
                        {
                            <th class="@GetThClasses()" rowspan="2" style="width: 40px;"></th>
                        }
                        @foreach (var group in ColumnGroups)
                        {
                            <th class="@GetGroupHeaderClasses()" colspan="@group.ColSpan" style="@GetGroupHeaderStyle()">
                                @group.Name
                            </th>
                        }
                    </tr>
                }
                <tr>
                    @if (SelectionMode != SelectionMode.None)
                    {
                        <th class="@GetThClasses()" style="width: 40px; color: var(--color-text-secondary)">
                            @if (SelectionMode == SelectionMode.Multiple)
                            {
                                <input 
                                    type="checkbox" 
                                    checked="@IsAllSelected()"
                                    @onchange="ToggleSelectAll" />
                            }
                        </th>
                    }
                    @foreach (var column in Columns)
                    {
                        <th class="@GetThClasses()" style="@GetColumnStyle(column); color: var(--color-text-secondary)">
                            @if (column.HeaderTemplate != null)
                            {
                                @column.HeaderTemplate(column)
                            }
                            else
                            {
                                <div class="flex items-center space-x-2">
                                    <span>@column.Title</span>
                                    @if (column.Sortable && Sortable)
                                    {
                                        <button 
                                            type="button"
                                            class="p-1 rounded"
                                            style="@GetSortButtonStyle()"
                                            @onclick="() => SortBy(column.Property)">
                                            @if (CurrentSortColumn == column.Property)
                                            {
                                                @if (CurrentSortDirection == SortDirection.Ascending)
                                                {
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z" />
                                                    </svg>
                                                }
                                                else
                                                {
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M5 8a1 1 0 102 0v5.586l1.293-1.293a1 1 0 001.414 1.414l-3 3a1 1 0 00-1.414 0l-3-3a1 1 0 001.414-1.414L5 13.586V8zM15 12a1 1 0 10-2 0V6.414l-1.293 1.293a1 1 0 01-1.414-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L15 6.414V12z" />
                                                    </svg>
                                                }
                                            }
                                            else
                                            {
                                                <svg class="w-4 h-4" style="color: var(--color-text-secondary); opacity: 0.5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z" />
                                                </svg>
                                            }
                                        </button>
                                    }
                                </div>
                            }
                        </th>
                    }
                </tr>
            </thead>
            <tbody class="@GetTbodyClasses()" style="@GetTbodyStyle()">
                @if (FilteredItems != null && FilteredItems.Any())
                {
                    @foreach (var item in GetDisplayItems())
                    {
                        <tr class="@GetRowClasses(item)" style="@GetRowStyle(item)" @onclick="async () => await HandleRowClick(item)">
                            @if (SelectionMode != SelectionMode.None)
                            {
                                <td class="@GetTdClasses()">
                                    @if (SelectionMode == SelectionMode.Multiple)
                                    {
                                        <input 
                                            type="checkbox" 
                                            checked="@IsSelected(item)"
                                            @onchange="() => ToggleSelection(item)"
                                            @onclick:stopPropagation="true" />
                                    }
                                    else
                                    {
                                        <input 
                                            type="radio" 
                                            name="grid-selection"
                                            checked="@IsSelected(item)"
                                            @onchange="() => SelectItem(item)"
                                            @onclick:stopPropagation="true" />
                                    }
                                </td>
                            }
                            @foreach (var column in Columns)
                            {
                                <td class="@GetTdClasses(column) @column.CssClass" style="@GetTdStyle(column)">
                                    @if (column.Editable && isEditing && ReferenceEquals(editingCellItem, item) && editingCellColumn == column.Property)
                                    {
                                        <input 
                                            type="text"
                                            class="w-full px-2 py-1 border rounded"
                                            style="background-color: var(--color-surface); border-color: var(--color-primary); color: var(--color-text-primary)"
                                            @bind="editingValue"
                                            @bind:event="oninput"
                                            @onkeydown="(e) => HandleCellKeyDown(e, item, column)"
                                            @onblur="() => SaveCellEdit(item, column)"
                                            @onclick:stopPropagation="true"
                                            @ref="editingInputRef" />
                                    }
                                    else if (column.CellTemplate != null)
                                    {
                                        @column.CellTemplate(item)
                                    }
                                    else
                                    {
                                        <span @ondblclick="() => StartCellEdit(item, column)" style="color: var(--color-text-primary);">
                                            @GetCellValue(item, column.Property)
                                        </span>
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(Columns.Count + (SelectionMode != SelectionMode.None ? 1 : 0))" class="@GetEmptyClasses()" style="color: var(--color-text-secondary)">
                            @if (EmptyTemplate != null)
                            {
                                @EmptyTemplate
                            }
                            else
                            {
                                <p>No data available</p>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    @if (ShowPager && TotalPages > 1)
    {
        <div class="mt-4">
            <TailPager 
                CurrentPage="@CurrentPage"
                TotalPages="@TotalPages"
                TotalItems="@TotalItems"
                PageSize="@PageSize"
                ShowInfo="@ShowPagerInfo"
                CurrentPageChanged="OnPageChanged" />
        </div>
    }
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<DataGridColumn> Columns { get; set; } = new();
    [Parameter] public string? Title { get; set; }
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowSearch { get; set; } = false;
    [Parameter] public bool ShowPager { get; set; } = true;
    [Parameter] public bool ShowPagerInfo { get; set; } = true;
    [Parameter] public bool Sortable { get; set; } = true;
    [Parameter] public bool Filterable { get; set; } = true;
    [Parameter] public SelectionMode SelectionMode { get; set; } = SelectionMode.None;
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public bool Virtualized { get; set; } = false;
    [Parameter] public bool AllowExport { get; set; } = false;
    [Parameter] public bool AllowInlineEdit { get; set; } = true;
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }
    [Parameter] public EventCallback<List<TItem>> SelectedItemsChanged { get; set; }
    [Parameter] public EventCallback<(TItem Item, string Column, object? NewValue)> OnCellEdited { get; set; }
    
    private string gridId = $"datagrid-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private int CurrentPage { get; set; } = 1;
    private TItem? editingCellItem;
    private string? editingCellColumn;
    private bool isEditing => editingCellItem != null && !string.IsNullOrEmpty(editingCellColumn);
    private string? editingValue;
    private ElementReference? editingInputRef;
    private int TotalPages => (int)Math.Ceiling((double)TotalItems / PageSize);
    private int TotalItems => FilteredItems?.Count() ?? 0;
    private string? searchText;
    private string? CurrentSortColumn;
    private SortDirection CurrentSortDirection = SortDirection.None;
    private HashSet<TItem> SelectedItemsSet = new();
    
    private IEnumerable<TItem>? FilteredItems
    {
        get
        {
            if (Items == null) return null;
            
            var filtered = Items.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(searchText) && Filterable)
            {
                filtered = filtered.Where(item => 
                    Columns.Any(col => 
                        GetCellValue(item, col.Property)?.ToString()?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true));
            }
            
            if (!string.IsNullOrEmpty(CurrentSortColumn) && CurrentSortDirection != SortDirection.None)
            {
                var property = typeof(TItem).GetProperty(CurrentSortColumn);
                if (property != null)
                {
                    if (CurrentSortDirection == SortDirection.Ascending)
                    {
                        filtered = filtered.OrderBy(x => property.GetValue(x));
                    }
                    else
                    {
                        filtered = filtered.OrderByDescending(x => property.GetValue(x));
                    }
                }
            }
            
            return filtered.ToList();
        }
    }
    
    private IEnumerable<TItem> GetDisplayItems()
    {
        if (FilteredItems == null) return Enumerable.Empty<TItem>();
        
        if (ShowPager)
        {
            return FilteredItems.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
        }
        
        return FilteredItems;
    }
    
    private string GetGridClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetHeaderClasses() => "mb-4";
    private string GetTableClasses() => "min-w-full";
    private string GetTheadClasses() => "";
    private string GetTheadStyle() => "background-color: color-mix(in srgb, var(--color-border) 30%, var(--color-surface)); border-bottom: 1px solid var(--color-border)";
    private string GetTbodyClasses() => "";
    private string GetTbodyStyle() => "background-color: var(--color-surface); border-top: 1px solid var(--color-border)";
    private string GetThClasses() => "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider";
    private string GetTdClasses(DataGridColumn? column = null)
    {
        var classes = new List<string> { "px-6 py-4 whitespace-nowrap text-sm" };
        if (column?.Frozen == true)
        {
            classes.Add("sticky left-0 z-10");
        }
        return string.Join(" ", classes);
    }
    
    private string GetTdStyle(DataGridColumn? column = null)
    {
        var styles = new List<string> { "color: var(--color-text-primary)" };
        if (column?.Frozen == true)
        {
            styles.Add("background-color: var(--color-surface);");
        }
        return string.Join("; ", styles);
    }
    private string GetRowClasses(TItem item) => $"cursor-pointer border-b {(IsSelected(item) ? "" : "")}";
    
    private string GetRowStyle(TItem item)
    {
        var styles = new List<string> { "border-color: var(--color-border)" };
        
        if (IsSelected(item))
        {
            styles.Add("background-color: color-mix(in srgb, var(--color-primary) 10%, var(--color-surface))");
        }
        else
        {
            styles.Add("background-color: var(--color-surface)");
        }
        
        return string.Join("; ", styles);
    }
    
    private string GetSortButtonStyle() => "background-color: transparent; color: var(--color-primary)";
    private string GetEmptyClasses() => "px-6 py-12 text-center";
    
    private string? GetColumnStyle(DataGridColumn column)
    {
        return !string.IsNullOrEmpty(column.Width) ? $"width: {column.Width};" : null;
    }
    
    private object? GetCellValue(TItem item, string property)
    {
        var prop = typeof(TItem).GetProperty(property);
        return prop?.GetValue(item);
    }
    
    private void SortBy(string column)
    {
        if (CurrentSortColumn == column)
        {
            CurrentSortDirection = CurrentSortDirection switch
            {
                SortDirection.None => SortDirection.Ascending,
                SortDirection.Ascending => SortDirection.Descending,
                _ => SortDirection.None
            };
        }
        else
        {
            CurrentSortColumn = column;
            CurrentSortDirection = SortDirection.Ascending;
        }
        CurrentPage = 1;
    }
    
    private async Task OnPageChanged(int page)
    {
        CurrentPage = page;
        await Task.CompletedTask;
    }
    
    private bool IsSelected(TItem item) => SelectedItemsSet.Contains(item);
    
    private bool IsAllSelected()
    {
        if (FilteredItems == null || !FilteredItems.Any()) return false;
        return GetDisplayItems().All(IsSelected);
    }
    
    private void ToggleSelection(TItem item)
    {
        if (SelectedItemsSet.Contains(item))
        {
            SelectedItemsSet.Remove(item);
        }
        else
        {
            SelectedItemsSet.Add(item);
        }
        NotifySelectionChanged();
    }
    
    private void SelectItem(TItem item)
    {
        SelectedItemsSet.Clear();
        SelectedItemsSet.Add(item);
        NotifySelectionChanged();
    }
    
    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var selectAll = (bool)(e.Value ?? false);
        var displayItems = GetDisplayItems().ToList();
        
        if (selectAll)
        {
            foreach (var item in displayItems)
            {
                SelectedItemsSet.Add(item);
            }
        }
        else
        {
            foreach (var item in displayItems)
            {
                SelectedItemsSet.Remove(item);
            }
        }
        NotifySelectionChanged();
    }
    
    private async void NotifySelectionChanged()
    {
        if (SelectedItemsChanged.HasDelegate)
        {
            await SelectedItemsChanged.InvokeAsync(SelectedItemsSet.ToList());
        }
    }
    
    private async Task HandleRowClick(TItem item)
    {
        if (OnRowClick.HasDelegate)
        {
            await OnRowClick.InvokeAsync(item);
        }
    }
    
    // Column Grouping
    private bool HasColumnGroups => Columns.Any(c => !string.IsNullOrEmpty(c.Group));
    
    private List<ColumnGroup> ColumnGroups
    {
        get
        {
            if (!HasColumnGroups) return new List<ColumnGroup>();
            
            var groups = Columns
                .Where(c => !string.IsNullOrEmpty(c.Group))
                .GroupBy(c => c.Group)
                .Select(g => new ColumnGroup 
                { 
                    Name = g.Key!, 
                    ColSpan = g.Count() 
                })
                .ToList();
            
            // Add ungrouped columns
            var ungrouped = Columns.Where(c => string.IsNullOrEmpty(c.Group)).ToList();
            if (ungrouped.Any())
            {
                groups.Add(new ColumnGroup { Name = "", ColSpan = ungrouped.Count });
            }
            
            return groups;
        }
    }
    
    private string GetGroupHeaderClasses() => "px-6 py-2 text-left text-xs font-semibold uppercase tracking-wider border-b";
    private string GetGroupHeaderStyle() => "background-color: color-mix(in srgb, var(--color-border) 20%, var(--color-surface)); border-color: var(--color-border); color: var(--color-text-secondary)";
    
    // Inline Editing
    private void StartCellEdit(TItem item, DataGridColumn column)
    {
        if (!AllowInlineEdit || !column.Editable) return;
        editingCellItem = item;
        editingCellColumn = column.Property;
        editingValue = GetCellValueString(item, column.Property);
        StateHasChanged();
    }
    
    private async Task SaveCellEdit(TItem item, DataGridColumn column)
    {
        if (!isEditing) return;
        
        var property = typeof(TItem).GetProperty(column.Property);
        if (property != null && property.CanWrite)
        {
            try
            {
                var convertedValue = Convert.ChangeType(editingValue, property.PropertyType);
                property.SetValue(item, convertedValue);
                
                if (OnCellEdited.HasDelegate)
                {
                    await OnCellEdited.InvokeAsync((item, column.Property, convertedValue));
                }
            }
            catch
            {
                // Conversion failed, ignore
            }
        }
        
        editingCellItem = default;
        editingCellColumn = null;
        editingValue = null;
        StateHasChanged();
    }
    
    private async Task HandleCellKeyDown(KeyboardEventArgs e, TItem item, DataGridColumn column)
    {
        if (e.Key == "Enter")
        {
            await SaveCellEdit(item, column);
        }
        else if (e.Key == "Escape")
        {
            editingCellItem = default;
            editingCellColumn = null;
            editingValue = null;
            StateHasChanged();
        }
    }
    
    private string GetCellValueString(TItem item, string property)
    {
        var value = GetCellValue(item, property);
        return value?.ToString() ?? string.Empty;
    }
    
    // Excel Export
    private async Task ExportToExcel()
    {
        if (jsModule == null)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Data/datagrid.js");
            }
            catch
            {
                return;
            }
        }
        
        try
        {
            var data = new List<Dictionary<string, object?>>();
            var headers = Columns.Select(c => c.Title).ToList();
            
            var itemsToExport = FilteredItems ?? Items ?? Enumerable.Empty<TItem>();
            foreach (var item in itemsToExport)
            {
                var row = new Dictionary<string, object?>();
                foreach (var column in Columns)
                {
                    row[column.Title] = GetCellValue(item, column.Property);
                }
                data.Add(row);
            }
            
            await jsModule.InvokeVoidAsync("exportToExcel", Title ?? "DataGrid", headers, data);
        }
        catch
        {
            // Export failed
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && AllowExport)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Data/datagrid.js");
            }
            catch { }
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
    
    private class ColumnGroup
    {
        public string Name { get; set; } = string.Empty;
        public int ColSpan { get; set; }
    }
}

