@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data
@using Tail.Blazor.Data.Models
@typeparam TItem

<div class="@GetContainerClasses()" @attributes="AdditionalAttributes">
    @if (ShowHeader && !string.IsNullOrEmpty(Title))
    {
        <div class="@GetHeaderClasses()">
            <h3 class="@GetTitleClasses()">@Title</h3>
        </div>
    }
    
    <!-- Desktop Table View -->
    <div class="@GetTableContainerClasses()">
        <table class="@GetTableClasses()">
            <thead class="@GetTheadClasses()" style="@GetTheadStyle()">
                <tr>
                    @if (SelectionMode != SelectionMode.None)
                    {
                        <th class="@GetThClasses()" style="width: 40px;">
                            @if (SelectionMode == SelectionMode.Multiple)
                            {
                                <input 
                                    type="checkbox" 
                                    checked="@IsAllSelected()"
                                    @onchange="ToggleSelectAll" />
                            }
                        </th>
                    }
                    @foreach (var column in Columns)
                    {
                        <th class="@GetThClasses()" style="@GetColumnStyle(column)">
                            @if (column.HeaderTemplate != null)
                            {
                                @column.HeaderTemplate(column)
                            }
                            else
                            {
                                <div class="flex items-center space-x-2">
                                    <span>@column.Title</span>
                                    @if (column.Sortable && Sortable)
                                    {
                                        <button 
                                            type="button"
                                            class="p-1 rounded hover:bg-opacity-10 transition-colors"
                                            style="color: var(--color-text-secondary); hover:background-color: var(--color-surface-2);"
                                            @onclick="() => SortBy(column.Property)">
                                            @GetSortIcon(column.Property)
                                        </button>
                                    }
                                </div>
                            }
                        </th>
                    }
                </tr>
            </thead>
            <tbody class="@GetTbodyClasses()" style="@GetTbodyStyle()">
                @if (FilteredItems != null && FilteredItems.Any())
                {
                    @foreach (var item in GetDisplayItems())
                    {
                        <tr class="@GetRowClasses(item)" style="@GetRowStyle(item)" @onclick="async () => await HandleRowClick(item)">
                            @if (SelectionMode != SelectionMode.None)
                            {
                                <td class="@GetTdClasses()">
                                    @if (SelectionMode == SelectionMode.Multiple)
                                    {
                                        <input 
                                            type="checkbox" 
                                            checked="@IsSelected(item)"
                                            @onchange="() => ToggleSelection(item)"
                                            @onclick:stopPropagation="true" />
                                    }
                                    else
                                    {
                                        <input 
                                            type="radio" 
                                            name="table-selection"
                                            checked="@IsSelected(item)"
                                            @onchange="() => SelectItem(item)"
                                            @onclick:stopPropagation="true" />
                                    }
                                </td>
                            }
                            @foreach (var column in Columns)
                            {
                                <td class="@GetTdClasses()" style="@GetColumnStyle(column)">
                                    @if (column.CellTemplate != null)
                                    {
                                        @column.CellTemplate(item)
                                    }
                                    else
                                    {
                                        @GetCellValue(item, column.Property)
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(Columns.Count + (SelectionMode != SelectionMode.None ? 1 : 0))" class="@GetEmptyClasses()">
                            @if (EmptyTemplate != null)
                            {
                                @EmptyTemplate
                            }
                            else
                            {
                                <p class="text-center py-8" style="color: var(--color-text-secondary);">No data available</p>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Card View -->
    <div class="@GetCardContainerClasses()">
        @if (FilteredItems != null && FilteredItems.Any())
        {
            @foreach (var item in GetDisplayItems())
            {
                <div class="@GetCardClasses(item)" style="@GetCardStyle(item)" @onclick="async () => await HandleRowClick(item)">
                    @if (SelectionMode != SelectionMode.None)
                    {
                        <div class="@GetCardHeaderClasses()">
                            @if (SelectionMode == SelectionMode.Multiple)
                            {
                                <input 
                                    type="checkbox" 
                                    checked="@IsSelected(item)"
                                    @onchange="() => ToggleSelection(item)"
                                    @onclick:stopPropagation="true" />
                            }
                            else
                            {
                                <input 
                                    type="radio" 
                                    name="table-selection-mobile"
                                    checked="@IsSelected(item)"
                                    @onchange="() => SelectItem(item)"
                                    @onclick:stopPropagation="true" />
                            }
                        </div>
                    }
                    <div class="@GetCardBodyClasses()">
                        @if (CardTemplate != null)
                        {
                            @CardTemplate(item)
                        }
                        else
                        {
                            @foreach (var column in Columns)
                            {
                                <div class="@GetCardRowClasses()">
                                    <span class="@GetCardLabelClasses()">@column.Title:</span>
                                    <span class="@GetCardValueClasses()">
                                        @if (column.CellTemplate != null)
                                        {
                                            @column.CellTemplate(item)
                                        }
                                        else
                                        {
                                            @GetCellValue(item, column.Property)
                                        }
                                    </span>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="@GetEmptyCardClasses()">
                @if (EmptyTemplate != null)
                {
                    @EmptyTemplate
                }
                else
                {
                    <p class="text-center py-8" style="color: var(--color-text-secondary);">No data available</p>
                }
            </div>
        }
    </div>
    
    @if (ShowPager && TotalPages > 1)
    {
        <div class="mt-4">
            <TailPager 
                CurrentPage="@CurrentPage"
                TotalPages="@TotalPages"
                TotalItems="@TotalItems"
                PageSize="@PageSize"
                ShowInfo="@ShowPagerInfo"
                CurrentPageChanged="OnPageChanged" />
        </div>
    }
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<DataGridColumn> Columns { get; set; } = new();
    [Parameter] public string? Title { get; set; }
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowPager { get; set; } = true;
    [Parameter] public bool ShowPagerInfo { get; set; } = true;
    [Parameter] public bool Sortable { get; set; } = true;
    [Parameter] public SelectionMode SelectionMode { get; set; } = SelectionMode.None;
    [Parameter] public int PageSize { get; set; } = 10;
    [Parameter] public string Breakpoint { get; set; } = "md"; // sm, md, lg, xl
    [Parameter] public RenderFragment<TItem>? CardTemplate { get; set; }
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }
    [Parameter] public EventCallback<List<TItem>> SelectedItemsChanged { get; set; }
    
    private int CurrentPage { get; set; } = 1;
    private int TotalPages => (int)Math.Ceiling((double)TotalItems / PageSize);
    private int TotalItems => FilteredItems?.Count() ?? 0;
    private string? searchText;
    private string? CurrentSortColumn;
    private SortDirection CurrentSortDirection = SortDirection.None;
    private HashSet<TItem> SelectedItemsSet = new();
    
    private IEnumerable<TItem>? FilteredItems
    {
        get
        {
            if (Items == null) return null;
            
            var filtered = Items.AsEnumerable();
            
            // Apply search filter if search text exists
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                filtered = filtered.Where(item =>
                {
                    foreach (var column in Columns)
                    {
                        var value = GetCellValue(item, column.Property)?.ToString() ?? "";
                        if (value.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                            return true;
                    }
                    return false;
                });
            }
            
            // Apply sorting
            if (!string.IsNullOrEmpty(CurrentSortColumn) && CurrentSortDirection != SortDirection.None)
            {
                filtered = CurrentSortDirection == SortDirection.Ascending
                    ? filtered.OrderBy(item => GetCellValue(item, CurrentSortColumn))
                    : filtered.OrderByDescending(item => GetCellValue(item, CurrentSortColumn));
            }
            
            return filtered;
        }
    }
    
    private IEnumerable<TItem> GetDisplayItems()
    {
        if (FilteredItems == null) return Enumerable.Empty<TItem>();
        
        if (ShowPager)
        {
            return FilteredItems.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
        }
        
        return FilteredItems;
    }
    
    private void SortBy(string column)
    {
        if (CurrentSortColumn == column)
        {
            CurrentSortDirection = CurrentSortDirection switch
            {
                SortDirection.None => SortDirection.Ascending,
                SortDirection.Ascending => SortDirection.Descending,
                _ => SortDirection.None
            };
        }
        else
        {
            CurrentSortColumn = column;
            CurrentSortDirection = SortDirection.Ascending;
        }
        
        CurrentPage = 1; // Reset to first page on sort
    }
    
    private RenderFragment GetSortIcon(string column)
    {
        if (CurrentSortColumn != column)
        {
            return builder =>
            {
                builder.OpenElement(0, "svg");
                builder.AddAttribute(1, "class", "w-4 h-4");
                builder.AddAttribute(2, "style", "color: var(--color-text-secondary); opacity: 0.5");
                builder.AddAttribute(3, "fill", "currentColor");
                builder.AddAttribute(4, "viewBox", "0 0 20 20");
                builder.OpenElement(5, "path");
                builder.AddAttribute(6, "d", "M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12zM15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z");
                builder.CloseElement();
                builder.CloseElement();
            };
        }
        
        return CurrentSortDirection == SortDirection.Ascending
            ? builder =>
            {
                builder.OpenElement(0, "svg");
                builder.AddAttribute(1, "class", "w-4 h-4");
                builder.AddAttribute(2, "fill", "currentColor");
                builder.AddAttribute(3, "viewBox", "0 0 20 20");
                builder.OpenElement(4, "path");
                builder.AddAttribute(5, "d", "M5 12a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L5 6.414V12z");
                builder.CloseElement();
                builder.CloseElement();
            }
            : builder =>
            {
                builder.OpenElement(0, "svg");
                builder.AddAttribute(1, "class", "w-4 h-4");
                builder.AddAttribute(2, "fill", "currentColor");
                builder.AddAttribute(3, "viewBox", "0 0 20 20");
                builder.OpenElement(4, "path");
                builder.AddAttribute(5, "d", "M15 8a1 1 0 10-2 0v5.586l-1.293-1.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L15 13.586V8z");
                builder.CloseElement();
                builder.CloseElement();
            };
    }
    
    private bool IsSelected(TItem item)
    {
        return SelectedItemsSet.Contains(item);
    }
    
    private bool IsAllSelected()
    {
        if (FilteredItems == null || !FilteredItems.Any()) return false;
        return FilteredItems.All(IsSelected);
    }
    
    private void ToggleSelection(TItem item)
    {
        if (SelectedItemsSet.Contains(item))
        {
            SelectedItemsSet.Remove(item);
        }
        else
        {
            SelectedItemsSet.Add(item);
        }
        
        if (SelectedItemsChanged.HasDelegate)
        {
            SelectedItemsChanged.InvokeAsync(SelectedItemsSet.ToList());
        }
    }
    
    private void SelectItem(TItem item)
    {
        SelectedItemsSet.Clear();
        SelectedItemsSet.Add(item);
        
        if (SelectedItemsChanged.HasDelegate)
        {
            SelectedItemsChanged.InvokeAsync(SelectedItemsSet.ToList());
        }
    }
    
    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if (FilteredItems == null) return;
        
        var isChecked = (bool)(e.Value ?? false);
        
        if (isChecked)
        {
            foreach (var item in FilteredItems)
            {
                SelectedItemsSet.Add(item);
            }
        }
        else
        {
            foreach (var item in FilteredItems)
            {
                SelectedItemsSet.Remove(item);
            }
        }
        
        if (SelectedItemsChanged.HasDelegate)
        {
            SelectedItemsChanged.InvokeAsync(SelectedItemsSet.ToList());
        }
    }
    
    private async Task HandleRowClick(TItem item)
    {
        if (OnRowClick.HasDelegate)
        {
            await OnRowClick.InvokeAsync(item);
        }
    }
    
    private async Task OnPageChanged(int page)
    {
        CurrentPage = page;
        await Task.CompletedTask;
    }
    
    private object? GetCellValue(TItem item, string property)
    {
        if (string.IsNullOrEmpty(property)) return null;
        
        try
        {
            var prop = typeof(TItem).GetProperty(property);
            return prop?.GetValue(item);
        }
        catch
        {
            return null;
        }
    }
    
    // Styling methods
    private string GetContainerClasses()
    {
        return "w-full";
    }
    
    private string GetHeaderClasses()
    {
        return "mb-4";
    }
    
    private string GetTitleClasses()
    {
        return "text-lg font-semibold";
    }
    
    private string GetTitleStyle()
    {
        return "color: var(--color-text-primary);";
    }
    
    private string GetTableContainerClasses()
    {
        // Hide on mobile, show on desktop (based on breakpoint)
        var breakpointClass = Breakpoint switch
        {
            "sm" => "hidden sm:block",
            "md" => "hidden md:block",
            "lg" => "hidden lg:block",
            "xl" => "hidden xl:block",
            _ => "hidden md:block"
        };
        
        return $"{breakpointClass} overflow-x-auto";
    }
    
    private string GetTableClasses()
    {
        return "min-w-full divide-y divide-gray-200 dark:divide-gray-700";
    }
    
    private string GetTheadClasses()
    {
        return "bg-gray-50 dark:bg-gray-800";
    }
    
    private string GetTheadStyle()
    {
        return "background-color: var(--color-surface-2);";
    }
    
    private string GetThClasses()
    {
        return "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider";
    }
    
    private string GetColumnStyle(DataGridColumn column)
    {
        return !string.IsNullOrEmpty(column.Width) ? $"width: {column.Width};" : "";
    }
    
    private string GetTbodyClasses()
    {
        return "bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700";
    }
    
    private string GetTbodyStyle()
    {
        return "background-color: var(--color-surface);";
    }
    
    private string GetRowClasses(TItem item)
    {
        var baseClasses = "hover:bg-opacity-50 transition-colors cursor-pointer";
        var selectedClasses = IsSelected(item) ? "ring-2 ring-offset-2" : "";
        return $"{baseClasses} {selectedClasses}";
    }
    
    private string GetRowStyle(TItem item)
    {
        var bgColor = IsSelected(item)
            ? $"background-color: color-mix(in srgb, var(--color-primary) 10%, transparent); border-color: var(--color-primary);"
            : $"background-color: var(--color-surface);";
        
        return $"{bgColor} border: 1px solid transparent;";
    }
    
    private string GetTdClasses()
    {
        return "px-6 py-4 whitespace-nowrap text-sm";
    }
    
    private string GetTdStyle()
    {
        return "color: var(--color-text-primary);";
    }
    
    private string GetEmptyClasses()
    {
        return "px-6 py-4 text-center";
    }
    
    // Card view styling (mobile)
    private string GetCardContainerClasses()
    {
        // Show on mobile, hide on desktop (based on breakpoint)
        var breakpointClass = Breakpoint switch
        {
            "sm" => "block sm:hidden",
            "md" => "block md:hidden",
            "lg" => "block lg:hidden",
            "xl" => "block xl:hidden",
            _ => "block md:hidden"
        };
        
        return $"{breakpointClass} space-y-4";
    }
    
    private string GetCardClasses(TItem item)
    {
        var baseClasses = "rounded-lg border transition-colors cursor-pointer";
        var selectedClasses = IsSelected(item) ? "ring-2 ring-offset-2" : "";
        return $"{baseClasses} {selectedClasses}";
    }
    
    private string GetCardStyle(TItem item)
    {
        var bgColor = IsSelected(item)
            ? $"background-color: color-mix(in srgb, var(--color-primary) 10%, transparent); border-color: var(--color-primary);"
            : $"background-color: var(--color-surface); border-color: var(--color-border);";
        
        return $"{bgColor} box-shadow: var(--shadow-sm); border-radius: var(--radius-lg);";
    }
    
    private string GetCardHeaderClasses()
    {
        return "p-3 border-b flex items-center";
    }
    
    private string GetCardHeaderStyle()
    {
        return "border-color: var(--color-border);";
    }
    
    private string GetCardBodyClasses()
    {
        return "p-4 space-y-2";
    }
    
    private string GetCardRowClasses()
    {
        return "flex justify-between items-start gap-2";
    }
    
    private string GetCardLabelClasses()
    {
        return "text-sm font-medium flex-shrink-0";
    }
    
    private string GetCardLabelStyle()
    {
        return "color: var(--color-text-secondary);";
    }
    
    private string GetCardValueClasses()
    {
        return "text-sm text-right flex-1";
    }
    
    private string GetCardValueStyle()
    {
        return "color: var(--color-text-primary);";
    }
    
    private string GetEmptyCardClasses()
    {
        return "rounded-lg border p-8 text-center";
    }
    
    private string GetEmptyCardStyle()
    {
        return "background-color: var(--color-surface); border-color: var(--color-border);";
    }

}

