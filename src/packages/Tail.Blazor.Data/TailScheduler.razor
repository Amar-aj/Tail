@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data

<div class="@GetSchedulerClasses()" @attributes="AdditionalAttributes">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-4">
            <button 
                type="button"
                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                @onclick="PreviousPeriod">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h3 class="text-lg font-semibold">@GetPeriodTitle()</h3>
            <button 
                type="button"
                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                @onclick="NextPeriod">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <button 
                type="button"
                class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                @onclick="GoToToday">
                Today
            </button>
        </div>
        <div class="flex space-x-2">
            <button 
                type="button"
                class="@GetViewButtonClasses(Models.SchedulerView.Day)"
                @onclick="() => ChangeView(Models.SchedulerView.Day)">
                Day
            </button>
            <button 
                type="button"
                class="@GetViewButtonClasses(Models.SchedulerView.Week)"
                @onclick="() => ChangeView(Models.SchedulerView.Week)">
                Week
            </button>
            <button 
                type="button"
                class="@GetViewButtonClasses(Models.SchedulerView.Month)"
                @onclick="() => ChangeView(Models.SchedulerView.Month)">
                Month
            </button>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        @if (View == Models.SchedulerView.Month)
        {
            @RenderMonthView()
        }
        else if (View == Models.SchedulerView.Week)
        {
            @RenderWeekView()
        }
        else
        {
            @RenderDayView()
        }
    </div>
</div>

@code {
    [Parameter] public List<Models.SchedulerEvent> Events { get; set; } = new();
    [Parameter] public Models.SchedulerView View { get; set; } = Models.SchedulerView.Month;
    [Parameter] public DateTime CurrentDate { get; set; } = DateTime.Today;
    [Parameter] public EventCallback<Models.SchedulerEvent> OnEventClick { get; set; }
    [Parameter] public EventCallback<DateTime> OnDateClick { get; set; }
    [Parameter] public RenderFragment<Models.SchedulerEvent>? EventTemplate { get; set; }
    
    private string GetSchedulerClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetViewButtonClasses(Models.SchedulerView view)
    {
        var baseClasses = "px-4 py-2 text-sm font-medium rounded-lg transition-colors";
        if (View == view)
        {
            return $"{baseClasses} bg-blue-600 text-white";
        }
        return $"{baseClasses} text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700";
    }
    
    private string GetPeriodTitle()
    {
        return View switch
        {
            Models.SchedulerView.Day => CurrentDate.ToString("MMMM d, yyyy"),
            Models.SchedulerView.Week => GetWeekRange(),
            Models.SchedulerView.Month => CurrentDate.ToString("MMMM yyyy"),
            _ => CurrentDate.ToString("MMMM yyyy")
        };
    }
    
    private string GetWeekRange()
    {
        var startOfWeek = CurrentDate.AddDays(-(int)CurrentDate.DayOfWeek);
        var endOfWeek = startOfWeek.AddDays(6);
        return $"{startOfWeek:MMM d} - {endOfWeek:MMM d, yyyy}";
    }
    
    private void ChangeView(Models.SchedulerView view)
    {
        View = view;
    }
    
    private void PreviousPeriod()
    {
        CurrentDate = View switch
        {
            Models.SchedulerView.Day => CurrentDate.AddDays(-1),
            Models.SchedulerView.Week => CurrentDate.AddDays(-7),
            Models.SchedulerView.Month => CurrentDate.AddMonths(-1),
            _ => CurrentDate
        };
    }
    
    private void NextPeriod()
    {
        CurrentDate = View switch
        {
            Models.SchedulerView.Day => CurrentDate.AddDays(1),
            Models.SchedulerView.Week => CurrentDate.AddDays(7),
            Models.SchedulerView.Month => CurrentDate.AddMonths(1),
            _ => CurrentDate
        };
    }
    
    private void GoToToday()
    {
        CurrentDate = DateTime.Today;
    }
    
    private RenderFragment RenderMonthView()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700 border border-gray-200 dark:border-gray-700");
            
            // Day headers
            var dayNames = new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
            foreach (var day in dayNames)
            {
                builder.OpenElement(2, "div");
                builder.AddAttribute(3, "class", "bg-gray-50 dark:bg-gray-800 p-2 text-center text-sm font-medium text-gray-700 dark:text-gray-300");
                builder.AddContent(4, day);
                builder.CloseElement();
            }
            
            // Calendar days
            var firstDay = new DateTime(CurrentDate.Year, CurrentDate.Month, 1);
            var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);
            
            for (int i = 0; i < 42; i++)
            {
                var date = startDate.AddDays(i);
                var isCurrentMonth = date.Month == CurrentDate.Month;
                var dayEvents = Events.Where(e => e.Start.Date == date.Date).ToList();
                
                builder.OpenElement(5, "div");
                builder.AddAttribute(6, "class", $"min-h-24 bg-white dark:bg-gray-900 p-1 {(isCurrentMonth ? "" : "opacity-50")}");
                builder.AddAttribute(7, "onclick", EventCallback.Factory.Create(this, () => OnDateClick.InvokeAsync(date)));
                
                builder.OpenElement(8, "div");
                builder.AddAttribute(9, "class", $"text-sm font-medium mb-1 {(date.Date == DateTime.Today ? "text-blue-600 dark:text-blue-400" : "text-gray-700 dark:text-gray-300")}");
                builder.AddContent(10, date.Day);
                builder.CloseElement();
                
                foreach (var evt in dayEvents.Take(3))
                {
                    builder.OpenElement(11, "div");
                    builder.AddAttribute(12, "class", $"text-xs p-1 mb-1 rounded truncate cursor-pointer hover:opacity-80");
                    builder.AddAttribute(13, "style", $"background-color: {evt.Color ?? "#3b82f6"}; color: white;");
                    builder.AddAttribute(14, "onclick", EventCallback.Factory.Create(this, () => OnEventClick.InvokeAsync(evt)));
                    builder.AddContent(15, evt.Title);
                    builder.CloseElement();
                }
                
                if (dayEvents.Count > 3)
                {
                    builder.OpenElement(16, "div");
                    builder.AddAttribute(17, "class", "text-xs text-gray-500 dark:text-gray-400");
                    builder.AddContent(18, $"+{dayEvents.Count - 3} more");
                    builder.CloseElement();
                }
                
                builder.CloseElement();
            }
            
            builder.CloseElement();
        };
    }
    
    private RenderFragment RenderWeekView()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "grid grid-cols-7 gap-px bg-gray-200 dark:bg-gray-700");
            
            var startOfWeek = CurrentDate.AddDays(-(int)CurrentDate.DayOfWeek);
            var hours = Enumerable.Range(0, 24).ToList();
            
            // Time column
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "bg-gray-50 dark:bg-gray-800 p-2");
            foreach (var hour in hours)
            {
                builder.OpenElement(4, "div");
                builder.AddAttribute(5, "class", "text-xs text-gray-500 dark:text-gray-400 h-12");
                builder.AddContent(6, $"{hour:00}:00");
                builder.CloseElement();
            }
            builder.CloseElement();
            
            // Day columns
            for (int day = 0; day < 7; day++)
            {
                var date = startOfWeek.AddDays(day);
                builder.OpenElement(7, "div");
                builder.AddAttribute(8, "class", "bg-white dark:bg-gray-900");
                
                builder.OpenElement(9, "div");
                builder.AddAttribute(10, "class", "p-2 border-b border-gray-200 dark:border-gray-700 text-center font-medium");
                builder.AddContent(11, date.ToString("ddd M/d"));
                builder.CloseElement();
                
                builder.OpenElement(12, "div");
                builder.AddAttribute(13, "class", "relative");
                foreach (var hour in hours)
                {
                    builder.OpenElement(14, "div");
                    builder.AddAttribute(15, "class", "h-12 border-b border-gray-100 dark:border-gray-800");
                    builder.CloseElement();
                }
                builder.CloseElement();
                
                builder.CloseElement();
            }
            
            builder.CloseElement();
        };
    }
    
    private RenderFragment RenderDayView()
    {
        return builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "grid grid-cols-2 gap-px bg-gray-200 dark:bg-gray-700");
            
            // Time column
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "bg-gray-50 dark:bg-gray-800 p-2");
            var hours = Enumerable.Range(0, 24).ToList();
            foreach (var hour in hours)
            {
                builder.OpenElement(4, "div");
                builder.AddAttribute(5, "class", "text-xs text-gray-500 dark:text-gray-400 h-12");
                builder.AddContent(6, $"{hour:00}:00");
                builder.CloseElement();
            }
            builder.CloseElement();
            
            // Events column
            builder.OpenElement(7, "div");
            builder.AddAttribute(8, "class", "bg-white dark:bg-gray-900 relative");
            var dayEvents = Events.Where(e => e.Start.Date == CurrentDate.Date).OrderBy(e => e.Start).ToList();
            foreach (var evt in dayEvents)
            {
                builder.OpenElement(9, "div");
                builder.AddAttribute(10, "class", "p-2 mb-2 rounded cursor-pointer hover:opacity-80");
                builder.AddAttribute(11, "style", $"background-color: {evt.Color ?? "#3b82f6"}; color: white;");
                builder.AddAttribute(12, "onclick", EventCallback.Factory.Create(this, () => OnEventClick.InvokeAsync(evt)));
                builder.AddContent(13, $"{evt.Start:HH:mm} - {evt.End:HH:mm}");
                builder.AddContent(14, new MarkupString("<br />"));
                builder.AddContent(15, evt.Title);
                builder.CloseElement();
            }
            builder.CloseElement();
            
            builder.CloseElement();
        };
    }
}

