@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data

<div class="@GetTreeClasses()" @attributes="AdditionalAttributes">
    @if (Nodes != null && Nodes.Any())
    {
        @foreach (var node in Nodes)
        {
            @RenderNode(node, 0)
        }
    }
    else if (EmptyTemplate != null)
    {
        @EmptyTemplate
    }
    else
    {
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            No nodes to display
        </div>
    }
</div>

@code {
    [Parameter] public List<Models.TreeNode>? Nodes { get; set; }
    [Parameter] public bool ShowCheckboxes { get; set; } = false;
    [Parameter] public bool AllowDragDrop { get; set; } = false;
    [Parameter] public RenderFragment<Models.TreeNode>? NodeTemplate { get; set; }
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public EventCallback<Models.TreeNode> OnNodeClick { get; set; }
    [Parameter] public EventCallback<Models.TreeNode> OnNodeSelect { get; set; }
    [Parameter] public EventCallback<Models.TreeNode> OnNodeExpand { get; set; }
    
    private string GetTreeClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private RenderFragment RenderNode(Models.TreeNode node, int level)
    {
        return builder =>
        {
            var hasChildren = node.Children != null && node.Children.Any();
            var indent = level * 24;
            
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", $"flex items-center py-1 hover:bg-gray-50 dark:hover:bg-gray-800 rounded px-2 {(node.Selected ? "bg-blue-50 dark:bg-blue-900/20" : "")} {(node.Disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer")}");
            builder.AddAttribute(2, "style", $"padding-left: {indent}px;");
            builder.AddAttribute(3, "onclick", EventCallback.Factory.Create(this, () => HandleNodeClick(node)));
            
            // Expand/Collapse button
            if (hasChildren)
            {
                builder.OpenElement(4, "button");
                builder.AddAttribute(5, "type", "button");
                builder.AddAttribute(6, "class", "mr-2 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded");
                builder.AddAttribute(7, "onclick", EventCallback.Factory.Create(this, () => ToggleNode(node)));
                builder.AddAttribute(8, "onclick:stopPropagation", true);
                
                builder.OpenElement(9, "svg");
                builder.AddAttribute(10, "class", $"w-4 h-4 transition-transform {(node.Expanded ? "rotate-90" : "")}");
                builder.AddAttribute(11, "fill", "none");
                builder.AddAttribute(12, "viewBox", "0 0 24 24");
                builder.AddAttribute(13, "stroke", "currentColor");
                builder.AddContent(14, new MarkupString("<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\" />"));
                builder.CloseElement();
                builder.CloseElement();
            }
            else
            {
                builder.OpenElement(15, "div");
                builder.AddAttribute(16, "class", "w-6");
                builder.CloseElement();
            }
            
            // Checkbox
            if (ShowCheckboxes)
            {
                builder.OpenElement(17, "input");
                builder.AddAttribute(18, "type", "checkbox");
                builder.AddAttribute(19, "checked", node.Selected);
                builder.AddAttribute(20, "class", "mr-2");
                builder.AddAttribute(21, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => ToggleSelection(node, e)));
                builder.AddAttribute(22, "onclick:stopPropagation", true);
                builder.CloseElement();
            }
            
            // Icon
            if (!string.IsNullOrEmpty(node.Icon))
            {
                builder.OpenElement(23, "span");
                builder.AddAttribute(24, "class", "mr-2");
                builder.AddContent(25, node.Icon);
                builder.CloseElement();
            }
            
            // Node content
            if (NodeTemplate != null)
            {
                builder.AddContent(26, NodeTemplate(node));
            }
            else
            {
                builder.OpenElement(27, "span");
                builder.AddAttribute(28, "class", "text-sm text-gray-700 dark:text-gray-300");
                builder.AddContent(29, node.Text);
                builder.CloseElement();
            }
            
            builder.CloseElement();
            
            // Children
            if (hasChildren && node.Expanded)
            {
                foreach (var child in node.Children!)
                {
                    builder.AddContent(30, RenderNode((Models.TreeNode)child, level + 1));
                }
            }
        };
    }
    
    private async Task HandleNodeClick(Models.TreeNode node)
    {
        if (node.Disabled) return;
        
        if (OnNodeClick.HasDelegate)
        {
            await OnNodeClick.InvokeAsync(node);
        }
    }
    
    private async Task ToggleNode(Models.TreeNode node)
    {
        if (node.Disabled) return;
        
        node.Expanded = !node.Expanded;
        
        if (OnNodeExpand.HasDelegate)
        {
            await OnNodeExpand.InvokeAsync(node);
        }
    }
    
    private async Task ToggleSelection(Models.TreeNode node, ChangeEventArgs e)
    {
        if (node.Disabled) return;
        
        node.Selected = (bool)(e.Value ?? false);
        
        if (OnNodeSelect.HasDelegate)
        {
            await OnNodeSelect.InvokeAsync(node);
        }
    }
}

