@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data
@typeparam TItem

<div class="@GetPivotClasses()" @attributes="AdditionalAttributes">
    @if (ShowHeader)
    {
        <div class="mb-4">
            <h3 class="text-lg font-semibold mb-2">@Title</h3>
            <div class="flex flex-wrap gap-2">
                <div>
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Row Fields:</label>
                    <div class="flex flex-wrap gap-2 ml-2">
                        @foreach (var field in AvailableFields)
                        {
                            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="checkbox" 
                                       checked="@selectedRowFields.Contains(field)"
                                       @onchange="@((e) => ToggleRowField(field, e.Value ?? false))"
                                       class="mr-2" />
                                <span>@field</span>
                            </label>
                        }
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Column Fields:</label>
                    <div class="flex flex-wrap gap-2 ml-2">
                        @foreach (var field in AvailableFields)
                        {
                            <label class="flex items-center px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="checkbox" 
                                       checked="@selectedColumnFields.Contains(field)"
                                       @onchange="@((e) => ToggleColumnField(field, e.Value ?? false))"
                                       class="mr-2" />
                                <span>@field</span>
                            </label>
                        }
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Value Fields:</label>
                    <select class="ml-2 px-3 py-2 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-700" @bind="selectedValueField">
                        @foreach (var field in NumericFields)
                        {
                            <option value="@field">@field</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    }
    
    <div class="overflow-x-auto">
        <table class="@GetTableClasses()">
            <thead class="@GetTheadClasses()">
                @RenderPivotHeader()
            </thead>
            <tbody class="@GetTbodyClasses()">
                @RenderPivotBody()
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<string> AvailableFields { get; set; } = new();
    [Parameter] public List<string> NumericFields { get; set; } = new();
    [Parameter] public List<string> RowFields { get; set; } = new();
    [Parameter] public List<string> ColumnFields { get; set; } = new();
    [Parameter] public string? ValueField { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public Func<TItem, object>? ValueSelector { get; set; }
    
    private List<string> selectedRowFields = new();
    private List<string> selectedColumnFields = new();
    private string? selectedValueField;
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (selectedRowFields.Count == 0 && RowFields.Count > 0)
        {
            selectedRowFields = RowFields.ToList();
        }
        if (selectedColumnFields.Count == 0 && ColumnFields.Count > 0)
        {
            selectedColumnFields = ColumnFields.ToList();
        }
        if (string.IsNullOrEmpty(selectedValueField) && !string.IsNullOrEmpty(ValueField))
        {
            selectedValueField = ValueField;
        }
    }
    
    private string GetPivotClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetTableClasses() => "min-w-full divide-y divide-gray-200 dark:divide-gray-700 border border-gray-200 dark:border-gray-700";
    private string GetTheadClasses() => "bg-gray-50 dark:bg-gray-800";
    private string GetTbodyClasses() => "bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700";
    
    private RenderFragment RenderPivotHeader()
    {
        return builder =>
        {
            if (Items == null || !Items.Any()) return;
            
            builder.OpenElement(0, "tr");
            
            // Empty cell for row headers
            foreach (var rowField in selectedRowFields)
            {
                builder.OpenElement(1, "th");
                builder.AddAttribute(2, "class", "px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase border-r border-gray-200 dark:border-gray-700");
                builder.AddContent(3, rowField);
                builder.CloseElement();
            }
            
            // Column headers
            var columnValues = GetColumnValues().ToList();
            foreach (var colValue in columnValues)
            {
                builder.OpenElement(4, "th");
                builder.AddAttribute(5, "class", "px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase border-r border-gray-200 dark:border-gray-700");
                builder.AddContent(6, colValue);
                builder.CloseElement();
            }
            
            // Total column
            builder.OpenElement(7, "th");
            builder.AddAttribute(8, "class", "px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase bg-gray-100 dark:bg-gray-800");
            builder.AddContent(9, "Total");
            builder.CloseElement();
            
            builder.CloseElement();
        };
    }
    
    private RenderFragment RenderPivotBody()
    {
        return builder =>
        {
            if (Items == null || !Items.Any())
            {
                builder.OpenElement(0, "tr");
                builder.OpenElement(1, "td");
                builder.AddAttribute(2, "colspan", selectedRowFields.Count + GetColumnValues().Count() + 1);
                builder.AddAttribute(3, "class", "px-4 py-8 text-center text-gray-500 dark:text-gray-400");
                builder.AddContent(4, "No data available");
                builder.CloseElement();
                builder.CloseElement();
                return;
            }
            
            var rowValues = GetRowValues().ToList();
            var columnValues = GetColumnValues().ToList();
            
            foreach (var rowValue in rowValues)
            {
                builder.OpenElement(5, "tr");
                
                // Row header
                foreach (var (rowField, index) in selectedRowFields.Select((f, i) => (f, i)))
                {
                    builder.OpenElement(6, "td");
                    builder.AddAttribute(7, "class", "px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-700");
                    builder.AddContent(8, rowValue.Split('|')[index]);
                    builder.CloseElement();
                }
                
                // Data cells
                double rowTotal = 0;
                foreach (var colValue in columnValues)
                {
                    var value = GetPivotValue(rowValue, colValue);
                    rowTotal += value;
                    
                    builder.OpenElement(9, "td");
                    builder.AddAttribute(10, "class", "px-4 py-3 text-sm text-gray-900 dark:text-gray-100 text-center border-r border-gray-200 dark:border-gray-700");
                    builder.AddContent(11, value.ToString("N2"));
                    builder.CloseElement();
                }
                
                // Row total
                builder.OpenElement(12, "td");
                builder.AddAttribute(13, "class", "px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100 text-center bg-gray-50 dark:bg-gray-800");
                builder.AddContent(14, rowTotal.ToString("N2"));
                builder.CloseElement();
                
                builder.CloseElement();
            }
            
            // Grand total row
            builder.OpenElement(15, "tr");
            builder.AddAttribute(16, "class", "bg-gray-100 dark:bg-gray-800 font-medium");
            
            foreach (var rowField in selectedRowFields)
            {
                builder.OpenElement(17, "td");
                builder.AddAttribute(18, "class", "px-4 py-3 text-sm text-gray-900 dark:text-gray-100 border-r border-gray-200 dark:border-gray-700");
                builder.AddContent(19, "Total");
                builder.CloseElement();
            }
            
            double grandTotal = 0;
            foreach (var colValue in columnValues)
            {
                var colTotal = GetColumnTotal(colValue);
                grandTotal += colTotal;
                
                builder.OpenElement(20, "td");
                builder.AddAttribute(21, "class", "px-4 py-3 text-sm text-gray-900 dark:text-gray-100 text-center border-r border-gray-200 dark:border-gray-700");
                builder.AddContent(22, colTotal.ToString("N2"));
                builder.CloseElement();
            }
            
            builder.OpenElement(23, "td");
            builder.AddAttribute(24, "class", "px-4 py-3 text-sm text-gray-900 dark:text-gray-100 text-center");
            builder.AddContent(25, grandTotal.ToString("N2"));
            builder.CloseElement();
            
            builder.CloseElement();
        };
    }
    
    private IEnumerable<string> GetRowValues()
    {
        if (Items == null || !selectedRowFields.Any()) return Enumerable.Empty<string>();
        
        return Items
            .Select(item => string.Join("|", selectedRowFields.Select(f => GetFieldValue(item, f))))
            .Distinct()
            .OrderBy(x => x);
    }
    
    private IEnumerable<string> GetColumnValues()
    {
        if (Items == null || !selectedColumnFields.Any()) return Enumerable.Empty<string>();
        
        return Items
            .Select(item => string.Join("|", selectedColumnFields.Select(f => GetFieldValue(item, f))))
            .Distinct()
            .OrderBy(x => x);
    }
    
    private string GetFieldValue(TItem item, string field)
    {
        var prop = typeof(TItem).GetProperty(field);
        return prop?.GetValue(item)?.ToString() ?? "";
    }
    
    private double GetPivotValue(string rowValue, string colValue)
    {
        if (Items == null || string.IsNullOrEmpty(selectedValueField)) return 0;
        
        var rowParts = rowValue.Split('|');
        var colParts = colValue.Split('|');
        
        var matchingItems = Items.Where(item =>
        {
            var matchesRow = selectedRowFields.Select((f, i) => GetFieldValue(item, f) == rowParts[i]).All(x => x);
            var matchesCol = selectedColumnFields.Select((f, i) => GetFieldValue(item, f) == colParts[i]).All(x => x);
            return matchesRow && matchesCol;
        });
        
        if (ValueSelector != null)
        {
            return matchingItems.Sum(item => Convert.ToDouble(ValueSelector(item)));
        }
        
        var prop = typeof(TItem).GetProperty(selectedValueField);
        return matchingItems.Sum(item => Convert.ToDouble(prop?.GetValue(item) ?? 0));
    }
    
    private double GetColumnTotal(string colValue)
    {
        if (Items == null || string.IsNullOrEmpty(selectedValueField)) return 0;
        
        var colParts = colValue.Split('|');
        var matchingItems = Items.Where(item =>
        {
            return selectedColumnFields.Select((f, i) => GetFieldValue(item, f) == colParts[i]).All(x => x);
        });
        
        if (ValueSelector != null)
        {
            return matchingItems.Sum(item => Convert.ToDouble(ValueSelector(item)));
        }
        
        var prop = typeof(TItem).GetProperty(selectedValueField);
        return matchingItems.Sum(item => Convert.ToDouble(prop?.GetValue(item) ?? 0));
    }
    
    private void ToggleRowField(string field, object? isChecked)
    {
        var checkedValue = isChecked is bool b ? b : false;
        if (checkedValue)
        {
            if (!selectedRowFields.Contains(field))
                selectedRowFields.Add(field);
        }
        else
        {
            selectedRowFields.Remove(field);
        }
        StateHasChanged();
    }
    
    private void ToggleColumnField(string field, object? isChecked)
    {
        var checkedValue = isChecked is bool b ? b : false;
        if (checkedValue)
        {
            if (!selectedColumnFields.Contains(field))
                selectedColumnFields.Add(field);
        }
        else
        {
            selectedColumnFields.Remove(field);
        }
        StateHasChanged();
    }
}

