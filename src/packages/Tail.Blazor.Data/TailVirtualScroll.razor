@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Data
@typeparam TItem
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetContainerClasses()" style="@GetContainerStyle()" @attributes="AdditionalAttributes">
    <div 
        id="@scrollContainerId"
        class="@GetScrollContainerClasses()"
        style="@GetScrollContainerStyle()"
        @onscroll="HandleScroll"
        @onscroll:throttle="50">
        <!-- Spacer for items before visible range -->
        <div style="height: @(startOffset)px;"></div>
        
        <!-- Visible items -->
        @if (VisibleItems != null && VisibleItems.Any())
        {
            @foreach (var item in VisibleItems)
            {
                <div class="@GetItemClasses()" style="@GetItemStyle()" @key="GetItemKey(item)">
                    @ItemTemplate(item)
                </div>
            }
        }
        else if (EmptyTemplate != null)
        {
            <div class="@GetEmptyClasses()">
                @EmptyTemplate
            </div>
        }
        else if (Items == null || !Items.Any())
        {
            <div class="@GetEmptyClasses()">
                <p style="color: var(--color-text-secondary);">No items to display</p>
            </div>
        }
        
        <!-- Spacer for items after visible range -->
        <div style="height: @(endOffset)px;"></div>
    </div>
    
    @if (ShowScrollInfo)
    {
        <div class="@GetInfoClasses()" style="@GetInfoStyle()">
            Showing @(startIndex + 1)-@(endIndex) of @TotalItems items
        </div>
    }
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public RenderFragment<TItem> ItemTemplate { get; set; } = default!;
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public Func<TItem, string>? KeySelector { get; set; }
    [Parameter] public int ItemHeight { get; set; } = 50; // Fixed item height in pixels
    [Parameter] public int Overscan { get; set; } = 5; // Number of items to render outside viewport
    [Parameter] public int ContainerHeight { get; set; } = 400; // Container height in pixels
    [Parameter] public bool ShowScrollInfo { get; set; } = false;
    [Parameter] public EventCallback<int> OnVisibleRangeChanged { get; set; }

    private string scrollContainerId = $"virtual-scroll-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private double scrollTop = 0;
    private int startIndex = 0;
    private int endIndex = 0;
    private double startOffset = 0;
    private double endOffset = 0;
    private List<TItem>? VisibleItems { get; set; }
    private List<TItem>? itemsList;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Data/virtualscroll.js");
                await jsModule.InvokeVoidAsync("initializeVirtualScroll", scrollContainerId, DotNetObjectReference.Create(this));
            }
            catch
            {
                // JavaScript module not available
            }
        }

        if (firstRender || itemsList == null)
        {
            await UpdateItemsList();
        }

        await UpdateVisibleRange();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Items != null)
        {
            await UpdateItemsList();
        }
    }

    private async Task UpdateItemsList()
    {
        itemsList = Items?.ToList() ?? new List<TItem>();
        await UpdateVisibleRange();
    }

    private async Task UpdateVisibleRange()
    {
        if (itemsList == null || !itemsList.Any())
        {
            VisibleItems = new List<TItem>();
            startIndex = 0;
            endIndex = 0;
            startOffset = 0;
            endOffset = 0;
            return;
        }

        var totalItems = itemsList.Count;
        var containerHeight = ContainerHeight;
        var itemHeight = ItemHeight;
        
        // Calculate visible range
        var visibleStart = Math.Max(0, (int)(scrollTop / itemHeight) - Overscan);
        var visibleEnd = Math.Min(totalItems - 1, (int)((scrollTop + containerHeight) / itemHeight) + Overscan);
        
        startIndex = visibleStart;
        endIndex = visibleEnd;
        
        // Get visible items
        VisibleItems = itemsList.Skip(visibleStart).Take(visibleEnd - visibleStart + 1).ToList();
        
        // Calculate offsets
        startOffset = visibleStart * itemHeight;
        endOffset = (totalItems - visibleEnd - 1) * itemHeight;
        
        if (OnVisibleRangeChanged.HasDelegate)
        {
            await OnVisibleRangeChanged.InvokeAsync(VisibleItems.Count);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleScroll(EventArgs e)
    {
        if (jsModule == null) return;

        try
        {
            scrollTop = await jsModule.InvokeAsync<double>("getScrollTop", scrollContainerId);
            await UpdateVisibleRange();
        }
        catch
        {
            // Error getting scroll position
        }
    }

    [JSInvokable]
    public void OnScroll(double newScrollTop)
    {
        scrollTop = newScrollTop;
        InvokeAsync(async () =>
        {
            await UpdateVisibleRange();
        });
    }

    private string GetItemKey(TItem item)
    {
        return KeySelector?.Invoke(item) ?? item?.GetHashCode().ToString() ?? Guid.NewGuid().ToString();
    }

    private int TotalItems => itemsList?.Count ?? 0;

    // Styling methods
    private string GetContainerClasses()
    {
        return "w-full";
    }

    private string GetContainerStyle()
    {
        return "";
    }

    private string GetScrollContainerClasses()
    {
        return "overflow-y-auto";
    }

    private string GetScrollContainerStyle()
    {
        return $"height: {ContainerHeight}px;";
    }

    private string GetItemClasses()
    {
        return "";
    }

    private string GetItemStyle()
    {
        return $"min-height: {ItemHeight}px;";
    }

    private string GetEmptyClasses()
    {
        return "flex items-center justify-center py-12";
    }

    private string GetInfoClasses()
    {
        return "mt-2 text-sm text-center";
    }

    private string GetInfoStyle()
    {
        return "color: var(--color-text-muted);";
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.InvokeVoidAsync("disposeVirtualScroll", scrollContainerId);
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

