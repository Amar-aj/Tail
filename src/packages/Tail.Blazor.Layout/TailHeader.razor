@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Layout
@using Tail.Blazor.Core.Theme
@inject ThemeService ThemeService

    <header class="@GetHeaderClasses()" style="@GetHeaderStyle()">
    <div class="@GetContainerClasses()">
        <div class="@GetHeaderContentClasses()">
            <!-- Left: Logo and Menu Toggle -->
            <div class="flex items-center gap-4">
                @if (ShowMenuToggle)
                {
                    <button 
                        type="button"
                        class="@GetMenuToggleClasses()"
                        style="@GetMenuToggleStyle()"
                        @onclick="ToggleMenu"
                        aria-label="Toggle menu">
                        <svg class="@GetIconSizeClasses()" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            @if (IsMenuOpen)
                            {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            }
                            else
                            {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            }
                        </svg>
                    </button>
                }
                
                @if (LogoTemplate != null)
                {
                    <div class="flex items-center">
                        @LogoTemplate
                    </div>
                }
                else if (!string.IsNullOrEmpty(AppName))
                {
                    <div class="flex items-center">
                        <h1 class="@GetAppNameClasses()" style="color: var(--color-text-primary)">@AppName</h1>
                    </div>
                }
            </div>

            <!-- Center: Navigation or Custom Content -->
            <div class="hidden md:flex flex-1 justify-center px-4">
                @if (CenterContent != null)
                {
                    @CenterContent
                }
            </div>

            <!-- Right: Avatar, Theme Toggle, and Actions -->
            <div class="flex items-center gap-3">
                @if (ActionsTemplate != null)
                {
                    @ActionsTemplate
                }
                
                @if (ShowThemeToggle)
                {
                    <button 
                        type="button"
                        class="@GetIconButtonClasses()"
                        style="@GetIconButtonStyle()"
                        @onclick="ToggleTheme"
                        aria-label="Toggle theme">
                        @if (ThemeService.CurrentSettings.Mode == "Dark")
                        {
                            <svg class="@GetIconSizeClasses()" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" />
                            </svg>
                        }
                        else
                        {
                            <svg class="@GetIconSizeClasses()" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                            </svg>
                        }
                    </button>
                }
                
                @if (ShowAvatar && !string.IsNullOrEmpty(UserName))
                {
                    <div class="relative" @onclick="ToggleUserMenu">
                        <button 
                            type="button"
                            class="@GetAvatarButtonClasses()"
                            style="@GetAvatarButtonStyle()"
                            aria-label="User menu">
                            @if (!string.IsNullOrEmpty(AvatarUrl))
                            {
                                <img src="@AvatarUrl" alt="@UserName" class="w-full h-full rounded-full object-cover" />
                            }
                            else
                            {
                                <span class="text-sm font-medium" style="color: white">
                                    @GetInitials(UserName)
                                </span>
                            }
                        </button>
                        
                        @if (IsUserMenuOpen)
                        {
                            <div class="absolute right-0 mt-2 w-48 rounded-lg shadow-lg z-50" 
                                 style="@GetDropdownStyle()"
                                 @onclick:stopPropagation="true">
                                <div class="py-2">
                                    <div class="px-4 py-2 border-b" style="border-color: var(--color-divider)">
                                        <p class="text-sm font-medium" style="color: var(--color-text-primary)">@UserName</p>
                                        @if (!string.IsNullOrEmpty(UserEmail))
                                        {
                                            <p class="text-xs" style="color: var(--color-text-muted)">@UserEmail</p>
                                        }
                                    </div>
                                    @if (UserMenuItems != null)
                                    {
                                        @UserMenuItems
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</header>

@code {
    [Parameter] public string? AppName { get; set; }
    [Parameter] public RenderFragment? LogoTemplate { get; set; }
    [Parameter] public RenderFragment? CenterContent { get; set; }
    [Parameter] public RenderFragment? ActionsTemplate { get; set; }
    [Parameter] public RenderFragment? UserMenuItems { get; set; }
    
    [Parameter] public bool ShowMenuToggle { get; set; } = true;
    [Parameter] public bool ShowThemeToggle { get; set; } = true;
    [Parameter] public bool ShowAvatar { get; set; } = true;
    [Parameter] public bool Sticky { get; set; } = true;
    [Parameter] public bool Transparent { get; set; } = false;
    [Parameter] public bool Shadow { get; set; } = true;
    [Parameter] public bool Clipped { get; set; } = false;
    [Parameter] public DensityMode Density { get; set; } = DensityMode.Normal;
    
    [Parameter] public string? UserName { get; set; }
    [Parameter] public string? UserEmail { get; set; }
    [Parameter] public string? AvatarUrl { get; set; }
    
    [Parameter] public EventCallback<bool> OnMenuToggle { get; set; }
    [Parameter] public EventCallback OnThemeToggle { get; set; }
    
    [Parameter] public bool IsMenuOpen { get; set; }
    
    private bool IsUserMenuOpen { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await ThemeService.InitializeAsync();
    }

    private async Task ToggleMenu()
    {
        IsMenuOpen = !IsMenuOpen;
        if (OnMenuToggle.HasDelegate)
        {
            await OnMenuToggle.InvokeAsync(IsMenuOpen);
        }
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleModeAsync();
        if (OnThemeToggle.HasDelegate)
        {
            await OnThemeToggle.InvokeAsync();
        }
    }

    private void ToggleUserMenu()
    {
        IsUserMenuOpen = !IsUserMenuOpen;
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return name.Length > 0 ? name.Substring(0, Math.Min(2, name.Length)).ToUpper() : "??";
    }

    private string GetHeaderClasses()
    {
        var classes = new List<string> { "w-full transition-all" };
        
        // Z-index based on clipped mode
        if (Clipped)
        {
            classes.Add("z-50 relative");
        }
        else
        {
            classes.Add("z-50");
        }
        
        if (Sticky)
        {
            classes.Add("sticky top-0");
        }
        
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }

    private string GetHeaderStyle()
    {
        var styles = new List<string>();
        
        if (Transparent)
        {
            styles.Add("background-color: transparent");
        }
        else
        {
            styles.Add("background-color: var(--color-surface)");
        }
        
        if (Shadow)
        {
            styles.Add("box-shadow: var(--shadow-md)");
        }
        
        styles.Add("border-bottom: 1px solid var(--color-divider)");
        styles.Add("transition: background-color var(--transition-fast), box-shadow var(--transition-fast)");
        
        return string.Join("; ", styles);
    }

    private string GetContainerClasses()
    {
        var classes = new List<string> { "max-w-7xl mx-auto" };
        
        // Density-based padding
        if (Density == DensityMode.Compact)
        {
            classes.Add("px-2 sm:px-3");
        }
        else if (Density == DensityMode.Dense)
        {
            classes.Add("px-3 sm:px-4");
        }
        else
        {
            classes.Add("px-4 sm:px-6 lg:px-8");
        }
        
        return string.Join(" ", classes);
    }

    private string GetHeaderContentClasses()
    {
        var classes = new List<string> { "flex items-center justify-between" };
        
        // Density-based height
        if (Density == DensityMode.Compact)
        {
            classes.Add("h-12");
        }
        else if (Density == DensityMode.Dense)
        {
            classes.Add("h-14");
        }
        else
        {
            classes.Add("h-16");
        }
        
        return string.Join(" ", classes);
    }

    private string GetMenuToggleClasses()
    {
        return "inline-flex items-center justify-center p-2 rounded-lg transition-all focus:outline-none";
    }

    private string GetMenuToggleStyle()
    {
        return @"
            color: var(--color-text-secondary);
            background-color: transparent;
            border-radius: var(--radius-md);
            transition: background-color var(--transition-fast), color var(--transition-fast);
            &:hover { background-color: var(--color-surface-2); color: var(--color-text-primary); }
            &:focus { box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent); }
        ";
    }

    private string GetAppNameClasses()
    {
        if (Density == DensityMode.Compact)
        {
            return "text-lg font-bold";
        }
        else if (Density == DensityMode.Dense)
        {
            return "text-lg font-bold";
        }
        return "text-xl font-bold";
    }

    private string GetIconButtonClasses()
    {
        var classes = new List<string> { "inline-flex items-center justify-center rounded-full transition-all focus:outline-none" };
        
        if (Density == DensityMode.Compact)
        {
            classes.Add("w-8 h-8");
        }
        else if (Density == DensityMode.Dense)
        {
            classes.Add("w-9 h-9");
        }
        else
        {
            classes.Add("w-10 h-10");
        }
        
        return string.Join(" ", classes);
    }

    private string GetIconButtonStyle()
    {
        return @"
            color: var(--color-text-secondary);
            background-color: transparent;
            transition: background-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
            &:hover { background-color: var(--color-surface-2); color: var(--color-text-primary); transform: scale(1.05); }
            &:focus { box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent); }
        ";
    }

    private string GetIconSizeClasses()
    {
        if (Density == DensityMode.Compact)
        {
            return "w-4 h-4";
        }
        else if (Density == DensityMode.Dense)
        {
            return "w-5 h-5";
        }
        return "w-5 h-5";
    }

    private string GetAvatarButtonClasses()
    {
        var classes = new List<string> { "rounded-full flex items-center justify-center overflow-hidden cursor-pointer transition-all focus:outline-none" };
        
        if (Density == DensityMode.Compact)
        {
            classes.Add("w-8 h-8");
        }
        else if (Density == DensityMode.Dense)
        {
            classes.Add("w-9 h-9");
        }
        else
        {
            classes.Add("w-10 h-10");
        }
        
        return string.Join(" ", classes);
    }

    private string GetAvatarButtonStyle()
    {
        return @"
            background-color: var(--color-primary);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            &:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
            &:focus { box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent); }
        ";
    }

    private string GetDropdownStyle()
    {
        return @"
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        ";
    }
}
