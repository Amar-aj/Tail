@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Layout

<div class="@GetLayoutClasses()" style="@GetLayoutStyle()">
    <!-- Header -->
    <TailHeader 
        AppName="@AppName"
        LogoTemplate="@LogoTemplate"
        CenterContent="@HeaderCenterContent"
        ActionsTemplate="@HeaderActionsTemplate"
        UserMenuItems="@UserMenuItems"
        ShowMenuToggle="@(ShowSidebar && LayoutMode != LayoutMode.AppbarOnly ? ShowMenuToggle : false)"
        ShowThemeToggle="@ShowThemeToggle"
        ShowAvatar="@ShowAvatar"
        Sticky="@StickyHeader"
        Transparent="@TransparentHeader"
        Shadow="@HeaderShadow"
        UserName="@UserName"
        UserEmail="@UserEmail"
        AvatarUrl="@AvatarUrl"
        OnMenuToggle="HandleMenuToggle"
        IsMenuOpen="@isMenuOpen"
        Density="@Density"
        Clipped="@(LayoutMode == LayoutMode.ClippedDrawer)" />
    
    <div class="@GetContentContainerClasses()" style="@GetContentContainerStyle()">
        <!-- Sidebar/Menu -->
        @if (ShowSidebar && LayoutMode != LayoutMode.AppbarOnly)
        {
            <TailCollapsibleMenu 
                IsOpen="@isMenuOpen"
                IsOpenChanged="HandleMenuOpenChanged"
                MobileMenuTitle="@MobileMenuTitle"
                Position="@MenuPosition"
                Collapsible="@CollapsibleMenu"
                ShowOnMobile="true"
                ShowOnTablet="true"
                ShowOnDesktop="true"
                Clipped="@(LayoutMode == LayoutMode.ClippedDrawer)"
                Density="@Density">
                @SidebarContent
            </TailCollapsibleMenu>
        }
        
        <!-- Main Content -->
        <main class="@GetMainClasses()" style="@GetMainStyle()">
            @ChildContent
        </main>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? SidebarContent { get; set; }
    [Parameter] public RenderFragment? LogoTemplate { get; set; }
    [Parameter] public RenderFragment? HeaderCenterContent { get; set; }
    [Parameter] public RenderFragment? HeaderActionsTemplate { get; set; }
    [Parameter] public RenderFragment? UserMenuItems { get; set; }
    
    [Parameter] public string? AppName { get; set; }
    [Parameter] public string? UserName { get; set; }
    [Parameter] public string? UserEmail { get; set; }
    [Parameter] public string? AvatarUrl { get; set; }
    [Parameter] public string? MobileMenuTitle { get; set; }
    
    [Parameter] public bool ShowMenuToggle { get; set; } = true;
    [Parameter] public bool ShowThemeToggle { get; set; } = true;
    [Parameter] public bool ShowAvatar { get; set; } = true;
    [Parameter] public bool ShowSidebar { get; set; } = true;
    [Parameter] public bool StickyHeader { get; set; } = true;
    [Parameter] public bool TransparentHeader { get; set; } = false;
    [Parameter] public bool HeaderShadow { get; set; } = true;
    
    [Parameter] public TailCollapsibleMenu.MenuPosition MenuPosition { get; set; } = TailCollapsibleMenu.MenuPosition.Left;
    [Parameter] public bool CollapsibleMenu { get; set; } = true;
    [Parameter] public bool MenuOpenByDefault { get; set; } = true;
    [Parameter] public bool MenuOpenOnMobileByDefault { get; set; } = false;
    [Parameter] public LayoutMode LayoutMode { get; set; } = LayoutMode.DrawerLeft;
    [Parameter] public DensityMode Density { get; set; } = DensityMode.Normal;
    
    private bool isMenuOpen;

    protected override void OnInitialized()
    {
        // On mobile, menu is closed by default unless explicitly set
        // On desktop, use MenuOpenByDefault
        isMenuOpen = MenuOpenByDefault;
    }

    private Task HandleMenuToggle(bool isOpen)
    {
        isMenuOpen = isOpen;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task HandleMenuOpenChanged(bool isOpen)
    {
        isMenuOpen = isOpen;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private string GetLayoutClasses()
    {
        var classes = new List<string> { "min-h-screen flex flex-col" };
        
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }

    private string GetLayoutStyle()
    {
        return "background-color: var(--color-background);";
    }

    private string GetContentContainerClasses()
    {
        var classes = new List<string> { "flex flex-1 overflow-hidden" };
        
        // For clipped drawer mode, content starts below header
        if (LayoutMode == LayoutMode.ClippedDrawer)
        {
            classes.Add("relative");
        }
        
        return string.Join(" ", classes);
    }

    private string GetContentContainerStyle()
    {
        return string.Empty;
    }

    private string GetMainClasses()
    {
        var classes = new List<string> { "flex-1 overflow-auto transition-all duration-300" };
        
        // Handle different layout modes
        if (ShowSidebar && LayoutMode != LayoutMode.AppbarOnly)
        {
            if (LayoutMode == LayoutMode.ClippedDrawer)
            {
                // Clipped drawer: content always has margin, drawer is under header
                var drawerWidth = Density == DensityMode.Compact ? "lg:ml-56" : Density == DensityMode.Dense ? "lg:ml-60" : "lg:ml-64";
                if (isMenuOpen && CollapsibleMenu)
                {
                    classes.Add($"md:ml-0 {drawerWidth}");
                }
                else if (!CollapsibleMenu)
                {
                    classes.Add($"md:ml-0 {drawerWidth}");
                }
            }
            else // DrawerLeft mode
            {
                // Drawer left: content has margin when sidebar is open
                var drawerWidth = Density == DensityMode.Compact ? "lg:ml-56" : Density == DensityMode.Dense ? "lg:ml-60" : "lg:ml-64";
                if (isMenuOpen && CollapsibleMenu)
                {
                    classes.Add($"md:ml-0 {drawerWidth}");
                }
                else if (!CollapsibleMenu)
                {
                    classes.Add($"md:ml-0 {drawerWidth}");
                }
            }
        }
        
        // Density padding is handled in main content div, not here
        
        return string.Join(" ", classes);
    }

    private string GetMainStyle()
    {
        return @"
            background-color: var(--color-background);
            transition: background-color var(--transition-normal), margin-left var(--transition-normal);
        ";
    }
}
