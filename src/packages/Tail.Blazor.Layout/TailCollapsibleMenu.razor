@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Layout

<div class="@GetMenuClasses()" style="@GetMenuStyle()">
    <!-- Desktop/Tablet Menu -->
    <div class="@GetDesktopMenuClasses()" style="@GetDesktopMenuStyle()">
        <div class="h-full overflow-y-auto" style="@GetDesktopMenuContainerStyle()">
            @ChildContent
        </div>
    </div>
    
    <!-- Mobile Menu (Collapsible) -->
    @if (ShowMobileMenu)
    {
        <div class="@GetMobileMenuClasses()" style="@GetMobileMenuStyle()">
            <div class="@GetMobileMenuContainerClasses()" style="@GetMobileMenuContainerStyle()">
                <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid var(--color-divider)">
                    <h3 class="text-lg font-semibold" style="color: var(--color-text-primary)">
                        @(MobileMenuTitle ?? "Menu")
                    </h3>
                    <button 
                        type="button"
                        class="@GetCloseButtonClasses()"
                        style="@GetCloseButtonStyle()"
                        @onclick="CloseMobileMenu"
                        aria-label="Close menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    @ChildContent
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public bool IsOpen { get; set; } = false;
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public string? MobileMenuTitle { get; set; }
    [Parameter] public bool ShowOnMobile { get; set; } = true;
    [Parameter] public bool ShowOnTablet { get; set; } = true;
    [Parameter] public bool ShowOnDesktop { get; set; } = true;
    [Parameter] public bool Collapsible { get; set; } = true;
    [Parameter] public bool Clipped { get; set; } = false;
    [Parameter] public DensityMode Density { get; set; } = DensityMode.Normal;
    [Parameter] public MenuPosition Position { get; set; } = MenuPosition.Left;
    
    private bool ShowMobileMenu => IsOpen && ShowOnMobile;

    private async Task CloseMobileMenu()
    {
        IsOpen = false;
        if (IsOpenChanged.HasDelegate)
        {
            await IsOpenChanged.InvokeAsync(false);
        }
    }

    private string GetMenuClasses()
    {
        var classes = new List<string>();
        
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }

    private string GetMenuStyle()
    {
        return string.Empty;
    }

    private string GetDesktopMenuStyle()
    {
        return "background-color: var(--color-surface); border-right: 1px solid var(--color-divider);";
    }

    private string GetDesktopMenuContainerStyle()
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface);"
        };
        
        // Width based on density
        if (Density == DensityMode.Compact)
        {
            styles.Add("width: 14rem;");
        }
        else if (Density == DensityMode.Dense)
        {
            styles.Add("width: 15rem;");
        }
        else
        {
            styles.Add("width: 16rem;");
        }
        
        return string.Join(" ", styles);
    }

    private string GetDesktopMenuClasses()
    {
        var classes = new List<string>();
        
        // Desktop sidebar - fixed position, collapsible
        // Always hidden on mobile (below md breakpoint)
        classes.Add("hidden");
        
        if (ShowOnDesktop || ShowOnTablet)
        {
            classes.Add("fixed bottom-0 z-40 transition-all duration-300 ease-in-out");
            
            // Top position based on clipped mode
            if (Clipped)
            {
                // Clipped: drawer starts below header (64px for normal, 56px for dense, 48px for compact)
                if (Density == DensityMode.Compact)
                {
                    classes.Add("top-12");
                }
                else if (Density == DensityMode.Dense)
                {
                    classes.Add("top-14");
                }
                else
                {
                    classes.Add("top-16");
                }
            }
            else
            {
                // Normal: drawer starts from top
                classes.Add("top-0");
            }
            
            if (Position == MenuPosition.Left)
            {
                classes.Add("left-0");
                if (Collapsible)
                {
                    if (IsOpen)
                    {
                        classes.Add("translate-x-0");
                    }
                    else
                    {
                        classes.Add("-translate-x-full");
                    }
                }
                else
                {
                    classes.Add("translate-x-0");
                }
            }
            else
            {
                classes.Add("right-0");
                if (Collapsible)
                {
                    if (IsOpen)
                    {
                        classes.Add("translate-x-0");
                    }
                    else
                    {
                        classes.Add("translate-x-full");
                    }
                }
                else
                {
                    classes.Add("translate-x-0");
                }
            }
            
            // Show on tablet/desktop only (always hidden on mobile)
            if (ShowOnTablet && ShowOnDesktop)
            {
                // Show on both tablet and desktop
                classes.Add("md:block");
            }
            else if (ShowOnTablet)
            {
                // Show only on tablet, hide on desktop
                classes.Add("md:block lg:hidden");
            }
            else if (ShowOnDesktop)
            {
                // Show only on desktop, hide on tablet
                classes.Add("md:hidden lg:block");
            }
        }
        
        return string.Join(" ", classes);
    }

    private string GetMobileMenuClasses()
    {
        return "fixed inset-0 z-50 lg:hidden";
    }

    private string GetMobileMenuStyle()
    {
        return @"
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-in-out;
        ";
    }

    private string GetMobileMenuContainerClasses()
    {
        var classes = new List<string> { "relative h-full w-80 max-w-full flex flex-col" };
        
        if (Position == MenuPosition.Right)
        {
            classes.Add("ml-auto");
        }
        
        return string.Join(" ", classes);
    }

    private string GetMobileMenuContainerStyle()
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface)",
            "box-shadow: var(--shadow-lg)",
            "overflow-y: auto",
            "display: flex",
            "flex-direction: column"
        };
        
        // Ensure proper slide animation
        if (Position == MenuPosition.Right)
        {
            styles.Add("transform: translateX(0)");
        }
        else
        {
            styles.Add("transform: translateX(0)");
        }
        
        return string.Join("; ", styles);
    }

    private string GetCloseButtonClasses()
    {
        return "inline-flex items-center justify-center w-10 h-10 rounded-full transition-all focus:outline-none";
    }

    private string GetCloseButtonStyle()
    {
        return @"
            color: var(--color-text-secondary);
            background-color: transparent;
            transition: background-color var(--transition-fast), color var(--transition-fast);
            &:hover { background-color: var(--color-surface-2); color: var(--color-text-primary); }
            &:focus { box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 30%, transparent); }
        ";
    }

    public enum MenuPosition
    {
        Left,
        Right
    }
}

<style>
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideInLeft {
        from { transform: translateX(-100%); }
        to { transform: translateX(0); }
    }

    @@keyframes slideInRight {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
</style>
