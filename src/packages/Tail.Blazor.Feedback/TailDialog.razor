@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Feedback
@inject IJSRuntime JSRuntime

@if (Visible)
{
    <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @onclick="HandleBackdropClick"></div>
        
        <!-- Dialog container -->
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="@GetDialogClasses()">
                @if (ShowHeader)
                {
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title">@Title</h3>
                        @if (Closable)
                        {
                            <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" @onclick="HandleClose">
                                <span class="sr-only">Close</span>
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        }
                    </div>
                }
                <div class="@GetBodyClasses()">
                    @ChildContent
                </div>
                @if (ShowFooter)
                {
                    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                        @FooterContent
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? FooterContent { get; set; }
    [Parameter] public string? Title { get; set; }
    [Parameter] public bool Visible { get; set; }
    [Parameter] public bool Closable { get; set; } = true;
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowFooter { get; set; } = false;
    [Parameter] public DialogSize Size { get; set; } = DialogSize.Md;
    [Parameter] public bool CloseOnBackdropClick { get; set; } = true;
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public EventCallback OnClosed { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Visible && firstRender)
        {
            // Focus trap and portal logic would go here with JS interop
            await Task.CompletedTask;
        }
    }

    private string GetDialogClasses()
    {
        var classes = new List<string> 
        { 
            "relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all",
            "w-full"
        };
        
        classes.Add(Size switch
        {
            DialogSize.Sm => "sm:max-w-sm",
            DialogSize.Md => "sm:max-w-md",
            DialogSize.Lg => "sm:max-w-lg",
            DialogSize.Xl => "sm:max-w-xl",
            DialogSize.Xxl => "sm:max-w-2xl",
            DialogSize.Full => "sm:max-w-full",
            _ => "sm:max-w-md"
        });
        
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }

    private string GetBodyClasses()
    {
        return "px-6 py-4";
    }

    private async Task HandleClose()
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        if (OnClosed.HasDelegate)
        {
            await OnClosed.InvokeAsync();
        }
    }

    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            await HandleClose();
        }
    }
}

public enum DialogSize
{
    Sm,
    Md,
    Lg,
    Xl,
    Xxl,
    Full
}

