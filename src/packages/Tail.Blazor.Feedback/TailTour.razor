@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Feedback
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Active && Steps.Any() && CurrentStepIndex >= 0 && CurrentStepIndex < Steps.Count)
{
    <!-- Overlay -->
    <div class="@GetOverlayClasses()" style="@GetOverlayStyle()" @onclick="HandleOverlayClick"></div>
    
    <!-- Highlighted Element (if target exists) -->
    @if (!string.IsNullOrEmpty(CurrentStep.TargetSelector))
    {
        <div id="@highlightId" class="@GetHighlightClasses()" style="@GetHighlightStyle()"></div>
    }
    
    <!-- Tooltip -->
    <div id="@tooltipId" class="@GetTooltipClasses()" style="@GetTooltipStyle()">
        <!-- Progress Indicator -->
        @if (ShowProgress)
        {
            <div class="@GetProgressClasses()">
                <span class="text-xs" style="color: var(--color-text-muted);">
                    Step @(CurrentStepIndex + 1) of @Steps.Count
                </span>
                <div class="@GetProgressBarClasses()">
                    <div class="@GetProgressBarFillClasses()" style="@GetProgressBarFillStyle()"></div>
                </div>
            </div>
        }
        
        <!-- Content -->
        <div class="@GetContentClasses()">
            @if (!string.IsNullOrEmpty(CurrentStep.Image))
            {
                <div class="@GetImageClasses()">
                    <img src="@CurrentStep.Image" alt="@CurrentStep.Title" class="w-full h-auto rounded" />
                </div>
            }
            
            <h3 class="@GetTitleClasses()">@CurrentStep.Title</h3>
            
            @if (!string.IsNullOrEmpty(CurrentStep.Content))
            {
                <p class="@GetContentTextClasses()">@CurrentStep.Content</p>
            }
            
            @if (ContentTemplate != null)
            {
                @ContentTemplate(CurrentStep)
            }
        </div>
        
        <!-- Actions -->
        <div class="@GetActionsClasses()">
            @if (ShowSkipButton && CurrentStepIndex < Steps.Count - 1)
            {
                <button 
                    type="button"
                    class="@GetButtonClasses(true)"
                    style="@GetButtonStyle(true)"
                    @onclick="SkipTour">
                    Skip Tour
                </button>
            }
            
            <div class="flex gap-2 ml-auto">
                @if (CurrentStepIndex > 0)
                {
                    <button 
                        type="button"
                        class="@GetButtonClasses(true)"
                        style="@GetButtonStyle(true)"
                        @onclick="PreviousStep">
                        Previous
                    </button>
                }
                
                @if (CurrentStepIndex < Steps.Count - 1)
                {
                    <button 
                        type="button"
                        class="@GetButtonClasses(false)"
                        style="@GetButtonStyle(false)"
                        @onclick="NextStep">
                        Next
                    </button>
                }
                else
                {
                    <button 
                        type="button"
                        class="@GetButtonClasses(false)"
                        style="@GetButtonStyle(false)"
                        @onclick="CompleteTour">
                        Finish
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Active { get; set; }
    [Parameter] public EventCallback<bool> ActiveChanged { get; set; }
    [Parameter] public List<TourStep> Steps { get; set; } = new();
    [Parameter] public int InitialStep { get; set; } = 0;
    [Parameter] public bool ShowProgress { get; set; } = true;
    [Parameter] public bool ShowSkipButton { get; set; } = true;
    [Parameter] public bool AllowOverlayClick { get; set; } = false;
    [Parameter] public TourHighlightStyle HighlightStyle { get; set; } = TourHighlightStyle.Spotlight;
    [Parameter] public RenderFragment<TourStep>? ContentTemplate { get; set; }
    [Parameter] public EventCallback<TourStep> OnStepChanged { get; set; }
    [Parameter] public EventCallback OnTourCompleted { get; set; }
    [Parameter] public EventCallback OnTourSkipped { get; set; }

    private int CurrentStepIndex { get; set; } = -1;
    private TourStep CurrentStep => Steps[CurrentStepIndex];
    private string highlightId = $"tour-highlight-{Guid.NewGuid():N}";
    private string tooltipId = $"tour-tooltip-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private TourElementDimensions? targetDimensions;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Feedback/tour.js");
            }
            catch
            {
                // JavaScript module not available
            }
        }

        if (Active && Steps.Any() && CurrentStepIndex >= 0)
        {
            await UpdateHighlight();
            await UpdateTooltipPosition();
        }
    }

    protected override void OnParametersSet()
    {
        if (Active && Steps.Any() && CurrentStepIndex < 0)
        {
            CurrentStepIndex = Math.Max(0, Math.Min(InitialStep, Steps.Count - 1));
        }
        else if (!Active)
        {
            CurrentStepIndex = -1;
        }
    }

    private async Task UpdateHighlight()
    {
        if (string.IsNullOrEmpty(CurrentStep.TargetSelector) || jsModule == null)
            return;

        try
        {
            // Get target element dimensions
            targetDimensions = await jsModule.InvokeAsync<TourElementDimensions>("getElementDimensions", CurrentStep.TargetSelector);
            
            // Scroll element into view
            await jsModule.InvokeVoidAsync("scrollIntoView", CurrentStep.TargetSelector, true);
            
            // Update highlight position
            await jsModule.InvokeVoidAsync("updateHighlight", highlightId, targetDimensions);
            
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Element not found or error
        }
    }

    private async Task UpdateTooltipPosition()
    {
        if (string.IsNullOrEmpty(CurrentStep.TargetSelector) || jsModule == null || targetDimensions == null)
            return;

        try
        {
            var placement = CurrentStep.Placement == TourTooltipPlacement.Auto
                ? DetermineAutoPlacement()
                : CurrentStep.Placement.ToString().ToLower();

            await jsModule.InvokeVoidAsync("updateTooltipPosition", tooltipId, CurrentStep.TargetSelector, placement, targetDimensions);
        }
        catch
        {
            // Error positioning tooltip
        }
    }

    private string DetermineAutoPlacement()
    {
        if (targetDimensions == null) return "bottom";
        
        // Simple auto-placement logic
        var viewportHeight = 800; // Approximate
        var spaceBelow = viewportHeight - targetDimensions.Top - targetDimensions.Height;
        var spaceAbove = targetDimensions.Top;
        
        return spaceBelow > spaceAbove ? "bottom" : "top";
    }

    private async Task NextStep()
    {
        if (CurrentStepIndex < Steps.Count - 1)
        {
            CurrentStepIndex++;
            if (OnStepChanged.HasDelegate)
            {
                await OnStepChanged.InvokeAsync(CurrentStep);
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task PreviousStep()
    {
        if (CurrentStepIndex > 0)
        {
            CurrentStepIndex--;
            if (OnStepChanged.HasDelegate)
            {
                await OnStepChanged.InvokeAsync(CurrentStep);
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CompleteTour()
    {
        Active = false;
        CurrentStepIndex = -1;
        
        if (ActiveChanged.HasDelegate)
        {
            await ActiveChanged.InvokeAsync(false);
        }
        
        if (OnTourCompleted.HasDelegate)
        {
            await OnTourCompleted.InvokeAsync();
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task SkipTour()
    {
        Active = false;
        CurrentStepIndex = -1;
        
        if (ActiveChanged.HasDelegate)
        {
            await ActiveChanged.InvokeAsync(false);
        }
        
        if (OnTourSkipped.HasDelegate)
        {
            await OnTourSkipped.InvokeAsync();
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleOverlayClick()
    {
        if (AllowOverlayClick)
        {
            await NextStep();
        }
    }

    // Styling methods
    private string GetOverlayClasses()
    {
        return "fixed inset-0 z-40 transition-opacity duration-300";
    }

    private string GetOverlayStyle()
    {
        if (HighlightStyle == TourHighlightStyle.Spotlight)
        {
            return "background-color: color-mix(in srgb, #000 60%, transparent); backdrop-filter: blur(2px);";
        }
        return "background-color: color-mix(in srgb, var(--color-surface) 50%, transparent);";
    }

    private string GetHighlightClasses()
    {
        return "fixed z-50 pointer-events-none transition-all duration-300";
    }

    private string GetHighlightStyle()
    {
        if (targetDimensions == null)
            return "display: none;";
        
        var style = HighlightStyle switch
        {
            TourHighlightStyle.Spotlight => $"left: {targetDimensions.Left}px; top: {targetDimensions.Top}px; width: {targetDimensions.Width}px; height: {targetDimensions.Height}px; border: 3px solid var(--color-primary); border-radius: var(--radius-md); box-shadow: 0 0 0 9999px color-mix(in srgb, #000 60%, transparent), 0 0 20px var(--color-primary);",
            TourHighlightStyle.Border => $"left: {targetDimensions.Left}px; top: {targetDimensions.Top}px; width: {targetDimensions.Width}px; height: {targetDimensions.Height}px; border: 3px solid var(--color-primary); border-radius: var(--radius-md); box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-primary) 20%, transparent);",
            _ => $"left: {targetDimensions.Left}px; top: {targetDimensions.Top}px; width: {targetDimensions.Width}px; height: {targetDimensions.Height}px; background-color: color-mix(in srgb, var(--color-primary) 20%, transparent); border: 2px solid var(--color-primary); border-radius: var(--radius-md);"
        };
        
        return style;
    }

    private string GetTooltipClasses()
    {
        return "fixed z-50 w-80 max-w-sm rounded-lg shadow-xl transition-all duration-300";
    }

    private string GetTooltipStyle()
    {
        return "background-color: var(--color-surface); border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); border-radius: var(--radius-lg);";
    }

    private string GetProgressClasses()
    {
        return "px-4 pt-4 pb-2 border-b" + " " + GetBorderColor();
    }

    private string GetProgressBarClasses()
    {
        return "mt-2 h-1 rounded-full overflow-hidden";
    }

    private string GetProgressBarFillClasses()
    {
        return "h-full transition-all duration-300";
    }

    private string GetProgressBarFillStyle()
    {
        var progress = (double)(CurrentStepIndex + 1) / Steps.Count * 100;
        return $"width: {progress}%; background-color: var(--color-primary);";
    }

    private string GetContentClasses()
    {
        return "px-4 py-3";
    }

    private string GetImageClasses()
    {
        return "mb-3";
    }

    private string GetTitleClasses()
    {
        return "text-lg font-semibold mb-2";
    }

    private string GetTitleStyle()
    {
        return "color: var(--color-text-primary);";
    }

    private string GetContentTextClasses()
    {
        return "text-sm mb-2";
    }

    private string GetContentTextStyle()
    {
        return "color: var(--color-text-secondary);";
    }

    private string GetActionsClasses()
    {
        return "px-4 py-3 border-t flex items-center" + " " + GetBorderColor();
    }

    private string GetBorderColor()
    {
        return "border-gray-200 dark:border-gray-700";
    }

    private string GetButtonClasses(bool isOutline)
    {
        var baseClasses = "px-3 py-1.5 text-sm font-medium rounded transition-colors";
        return baseClasses;
    }

    private string GetButtonStyle(bool isOutline)
    {
        if (isOutline)
        {
            return "background-color: transparent; color: var(--color-text-primary); border: 1px solid var(--color-border); hover:background-color: var(--color-surface-2);";
        }
        return "background-color: var(--color-primary); color: white; border: 1px solid var(--color-primary); hover:opacity: 0.9;";
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}


