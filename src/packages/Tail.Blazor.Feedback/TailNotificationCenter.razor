@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Feedback
@using Microsoft.AspNetCore.Components.Web

@if (Visible)
{
    <div class="@GetOverlayClasses()" style="@GetOverlayStyle()" @onclick="HandleOverlayClick">
        <div class="@GetContainerClasses()" style="@GetContainerStyle()" @onclick:stopPropagation="true">
            <!-- Header -->
            <div class="@GetHeaderClasses()">
                <div class="flex items-center justify-between">
                    <h3 class="@GetTitleClasses()">Notifications</h3>
                    <div class="flex items-center gap-2">
                        @if (UnreadCount > 0)
                        {
                            <button 
                                type="button"
                                class="@GetMarkAllReadButtonClasses()"
                                @onclick="MarkAllAsRead"
                                title="Mark all as read">
                                Mark all read
                            </button>
                        }
                        <button 
                            type="button"
                            class="@GetCloseButtonClasses()"
                            @onclick="Close"
                            aria-label="Close">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                @if (ShowUnreadCount && UnreadCount > 0)
                {
                    <p class="@GetUnreadCountClasses()">@UnreadCount unread</p>
                }
            </div>

            <!-- Notifications List -->
            <div class="@GetListClasses()">
                @if (GroupByCategory && GroupedNotifications.Any())
                {
                    @foreach (var group in GroupedNotifications.OrderByDescending(g => g.Value.Max(n => n.Timestamp)))
                    {
                        <div class="@GetCategoryHeaderClasses()">
                            @group.Key
                            <span class="@GetCategoryCountClasses()">(@group.Value.Count)</span>
                        </div>
                        @foreach (var notification in group.Value.OrderByDescending(n => n.Timestamp))
                        {
                            <div class="@GetNotificationClasses(notification)" style="@GetNotificationStyle(notification)" @onclick="() => HandleNotificationClick(notification)">
                                @if (!string.IsNullOrEmpty(notification.Icon))
                                {
                                    <div class="@GetNotificationIconClasses(notification)">@notification.Icon</div>
                                }
                                <div class="flex-1 min-w-0">
                                    <div class="@GetNotificationTitleClasses()" style="@GetNotificationTitleStyle()">
                                        @notification.Title
                                        @if (!notification.IsRead)
                                        {
                                            <span class="@GetUnreadDotClasses()" style="@GetUnreadDotStyle()" title="Unread"></span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(notification.Message))
                                    {
                                        <p class="@GetNotificationMessageClasses()" style="@GetNotificationMessageStyle()">@notification.Message</p>
                                    }
                                    <p class="@GetTimestampClasses()" style="@GetTimestampStyle()">@FormatTimestamp(notification.Timestamp)</p>
                                    @if (notification.Actions.Any())
                                    {
                                        <div class="@GetActionsContainerClasses()">
                                            @foreach (var action in notification.Actions)
                                            {
                                                <button 
                                                    type="button"
                                                    class="@GetActionButtonClasses(action)"
                                                    style="@GetActionButtonStyle(action)"
                                                    @onclick="() => HandleActionClick(action, notification)"
                                                    @onclick:stopPropagation="true">
                                                    @action.Label
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>
                                @if (notification.Dismissible)
                                {
                                    <button 
                                        type="button"
                                        class="@GetDismissButtonClasses()"
                                        style="@GetDismissButtonStyle()"
                                        @onclick="() => HandleDismiss(notification)"
                                        @onclick:stopPropagation="true"
                                        aria-label="Dismiss">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                }
                            </div>
                        }
                    }
                }
                else if (CurrentNotifications.Any())
                {
                    @foreach (var notification in CurrentNotifications.OrderByDescending(n => n.Timestamp))
                    {
                        <div class="@GetNotificationClasses(notification)" style="@GetNotificationStyle(notification)" @onclick="() => HandleNotificationClick(notification)">
                            @if (!string.IsNullOrEmpty(notification.Icon))
                            {
                                <div class="@GetNotificationIconClasses(notification)">@notification.Icon</div>
                            }
                            <div class="flex-1 min-w-0">
                                <div class="@GetNotificationTitleClasses()" style="@GetNotificationTitleStyle()">
                                    @notification.Title
                                    @if (!notification.IsRead)
                                    {
                                        <span class="@GetUnreadDotClasses()" style="@GetUnreadDotStyle()" title="Unread"></span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(notification.Message))
                                {
                                    <p class="@GetNotificationMessageClasses()" style="@GetNotificationMessageStyle()">@notification.Message</p>
                                }
                                <p class="@GetTimestampClasses()" style="@GetTimestampStyle()">@FormatTimestamp(notification.Timestamp)</p>
                                @if (notification.Actions.Any())
                                {
                                    <div class="@GetActionsContainerClasses()">
                                        @foreach (var action in notification.Actions)
                                        {
                                            <button 
                                                type="button"
                                                class="@GetActionButtonClasses(action)"
                                                style="@GetActionButtonStyle(action)"
                                                @onclick="() => HandleActionClick(action, notification)"
                                                @onclick:stopPropagation="true">
                                                @action.Label
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                            @if (notification.Dismissible)
                            {
                                <button 
                                    type="button"
                                    class="@GetDismissButtonClasses()"
                                    style="@GetDismissButtonStyle()"
                                    @onclick="() => HandleDismiss(notification)"
                                    @onclick:stopPropagation="true"
                                    aria-label="Dismiss">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="@GetEmptyStateClasses()">
                        <p class="text-sm" style="color: var(--color-text-secondary);">@EmptyStateText</p>
                    </div>
                }
            </div>

            <!-- Footer Actions -->
            @if (ShowFooterActions && CurrentNotifications.Any())
            {
                <div class="@GetFooterClasses()">
                    <button 
                        type="button"
                        class="@GetFooterButtonClasses()"
                        @onclick="ClearRead">
                        Clear Read
                    </button>
                    <button 
                        type="button"
                        class="@GetFooterButtonClasses()"
                        @onclick="ClearAll">
                        Clear All
                    </button>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    [Parameter] public NotificationService? NotificationService { get; set; }
    [Parameter] public List<NotificationCenterItem>? Notifications { get; set; }
    [Parameter] public bool GroupByCategory { get; set; } = true;
    [Parameter] public bool ShowUnreadCount { get; set; } = true;
    [Parameter] public bool ShowFooterActions { get; set; } = true;
    [Parameter] public NotificationCenterPlacement Placement { get; set; } = NotificationCenterPlacement.TopRight;
    [Parameter] public string EmptyStateText { get; set; } = "No notifications";
    [Parameter] public EventCallback<NotificationCenterItem> OnNotificationClick { get; set; }
    [Parameter] public EventCallback<NotificationCenterItem> OnNotificationDismiss { get; set; }

    private List<NotificationCenterItem> _notifications = new();
    private int _unreadCount = 0;
    private Dictionary<string, List<NotificationCenterItem>> _groupedNotifications = new();

    protected override void OnParametersSet()
    {
        if (NotificationService != null)
        {
            _notifications = NotificationService.Notifications.ToList();
            _unreadCount = NotificationService.UnreadCount;
            _groupedNotifications = NotificationService.GetGroupedNotifications();
        }
        else if (Notifications != null)
        {
            _notifications = Notifications;
            _unreadCount = Notifications.Count(n => !n.IsRead);
            _groupedNotifications = Notifications
                .GroupBy(n => n.Category ?? "Other")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
    }

    protected override void OnInitialized()
    {
        if (NotificationService != null)
        {
            NotificationService.OnNotificationsChanged += HandleNotificationsChanged;
        }
    }

    private void HandleNotificationsChanged()
    {
        if (NotificationService != null)
        {
            _notifications = NotificationService.Notifications.ToList();
            _unreadCount = NotificationService.UnreadCount;
            _groupedNotifications = NotificationService.GetGroupedNotifications();
            InvokeAsync(StateHasChanged);
        }
    }


    private async Task HandleNotificationClick(NotificationCenterItem notification)
    {
        if (!notification.IsRead && NotificationService != null)
        {
            NotificationService.MarkAsRead(notification.Id);
        }
        
        if (OnNotificationClick.HasDelegate)
        {
            await OnNotificationClick.InvokeAsync(notification);
        }
    }

    private async Task HandleActionClick(NotificationAction action, NotificationCenterItem notification)
    {
        if (action.OnClick.HasDelegate)
        {
            await action.OnClick.InvokeAsync();
        }
    }

    private async Task HandleDismiss(NotificationCenterItem notification)
    {
        if (NotificationService != null)
        {
            NotificationService.RemoveNotification(notification.Id);
        }
        
        if (OnNotificationDismiss.HasDelegate)
        {
            await OnNotificationDismiss.InvokeAsync(notification);
        }
    }

    private async Task MarkAllAsRead()
    {
        if (NotificationService != null)
        {
            NotificationService.MarkAllAsRead();
        }
        await Task.CompletedTask;
    }

    private async Task ClearRead()
    {
        if (NotificationService != null)
        {
            NotificationService.ClearRead();
        }
        await Task.CompletedTask;
    }

    private async Task ClearAll()
    {
        if (NotificationService != null)
        {
            NotificationService.ClearAll();
        }
        await Task.CompletedTask;
    }

    private async Task Close()
    {
        Visible = false;
        if (VisibleChanged.HasDelegate)
        {
            await VisibleChanged.InvokeAsync(false);
        }
    }

    private async Task HandleOverlayClick()
    {
        await Close();
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        var now = DateTime.Now;
        var diff = now - timestamp;
        
        if (diff.TotalSeconds < 60)
            return "Just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        
        return timestamp.ToString("MMM dd, yyyy");
    }

    // Styling methods
    private string GetOverlayClasses()
    {
        return $"fixed inset-0 z-50 transition-opacity duration-200 {(Visible ? "opacity-100" : "opacity-0 pointer-events-none")}";
    }

    private string GetOverlayStyle()
    {
        return $"background-color: color-mix(in srgb, var(--color-surface) 80%, transparent); backdrop-filter: blur(4px);";
    }

    private string GetContainerClasses()
    {
        var placementClasses = Placement switch
        {
            NotificationCenterPlacement.TopRight => "top-4 right-4",
            NotificationCenterPlacement.TopLeft => "top-4 left-4",
            NotificationCenterPlacement.BottomRight => "bottom-4 right-4",
            NotificationCenterPlacement.BottomLeft => "bottom-4 left-4",
            _ => "top-4 right-4"
        };

        return $"absolute {placementClasses} w-full max-w-md rounded-lg shadow-xl transition-all duration-200 transform {(Visible ? "scale-100 opacity-100" : "scale-95 opacity-0")} max-h-[80vh] flex flex-col";
    }

    private string GetContainerStyle()
    {
        return $"background-color: var(--color-surface); border: 1px solid var(--color-border); box-shadow: var(--shadow-lg); border-radius: var(--radius-lg);";
    }

    private string GetHeaderClasses()
    {
        return "px-4 py-3 border-b" + " " + GetBorderColor();
    }

    private string GetTitleClasses()
    {
        return "text-lg font-semibold";
    }

    private string GetTitleStyle()
    {
        return $"color: var(--color-text-primary);";
    }

    private string GetUnreadCountClasses()
    {
        return "text-xs mt-1";
    }

    private string GetUnreadCountStyle()
    {
        return $"color: var(--color-text-secondary);";
    }

    private string GetMarkAllReadButtonClasses()
    {
        return "text-xs px-2 py-1 rounded hover:bg-opacity-10 transition-colors";
    }

    private string GetMarkAllReadButtonStyle()
    {
        return $"color: var(--color-primary); hover:background-color: var(--color-surface-2);";
    }

    private string GetCloseButtonClasses()
    {
        return "p-1 rounded hover:bg-opacity-10 transition-colors";
    }

    private string GetCloseButtonStyle()
    {
        return $"color: var(--color-text-secondary); hover:background-color: var(--color-surface-2);";
    }

    private string GetListClasses()
    {
        return "flex-1 overflow-y-auto p-2 space-y-2";
    }

    private string GetCategoryHeaderClasses()
    {
        return "px-2 py-1 text-xs font-semibold uppercase tracking-wider flex items-center gap-2";
    }

    private string GetCategoryHeaderStyle()
    {
        return $"color: var(--color-text-muted);";
    }

    private string GetCategoryCountClasses()
    {
        return "text-xs font-normal";
    }

    private string GetNotificationClasses(NotificationCenterItem notification)
    {
        var baseClasses = "flex items-start gap-3 p-3 rounded-lg cursor-pointer transition-colors";
        var unreadClasses = !notification.IsRead ? "ring-1" : "";
        return $"{baseClasses} {unreadClasses}";
    }

    private string GetNotificationStyle(NotificationCenterItem notification)
    {
        var bgColor = !notification.IsRead
            ? $"background-color: color-mix(in srgb, var(--color-primary) 5%, transparent); border-color: var(--color-primary);"
            : $"background-color: var(--color-surface-2);";
        
        return $"{bgColor} border: 1px solid var(--color-border);";
    }

    private string GetNotificationIconClasses(NotificationCenterItem notification)
    {
        return "flex-shrink-0 text-lg";
    }

    private string GetNotificationTitleClasses()
    {
        return "font-medium text-sm flex items-center gap-2";
    }

    private string GetNotificationTitleStyle()
    {
        return $"color: var(--color-text-primary);";
    }

    private string GetUnreadDotClasses()
    {
        return "w-2 h-2 rounded-full";
    }

    private string GetUnreadDotStyle()
    {
        return $"background-color: var(--color-primary);";
    }

    private string GetNotificationMessageClasses()
    {
        return "text-sm mt-1";
    }

    private string GetNotificationMessageStyle()
    {
        return $"color: var(--color-text-secondary);";
    }

    private string GetTimestampClasses()
    {
        return "text-xs mt-1";
    }

    private string GetTimestampStyle()
    {
        return $"color: var(--color-text-muted);";
    }

    private string GetActionsContainerClasses()
    {
        return "flex gap-2 mt-2";
    }

    private string GetActionButtonClasses(NotificationAction action)
    {
        return "px-2 py-1 text-xs rounded transition-colors";
    }

    private string GetActionButtonStyle(NotificationAction action)
    {
        var color = action.Variant switch
        {
            NotificationActionVariant.Primary => "var(--color-primary)",
            NotificationActionVariant.Success => "var(--color-success)",
            NotificationActionVariant.Warning => "var(--color-warning)",
            NotificationActionVariant.Danger => "var(--color-danger)",
            _ => "var(--color-text-secondary)"
        };
        
        return $"background-color: color-mix(in srgb, {color} 10%, transparent); color: {color}; border: 1px solid color-mix(in srgb, {color} 30%, transparent);";
    }

    private string GetDismissButtonClasses()
    {
        return "flex-shrink-0 p-1 rounded hover:bg-opacity-10 transition-colors";
    }

    private string GetDismissButtonStyle()
    {
        return $"color: var(--color-text-secondary); hover:background-color: var(--color-surface-2);";
    }

    private string GetFooterClasses()
    {
        return "px-4 py-3 border-t flex justify-between gap-2" + " " + GetBorderColor();
    }

    private string GetFooterButtonClasses()
    {
        return "px-3 py-1.5 text-sm rounded transition-colors";
    }

    private string GetFooterButtonStyle()
    {
        return $"background-color: var(--color-surface-2); color: var(--color-text-primary); hover:background-color: var(--color-surface-3);";
    }

    private string GetEmptyStateClasses()
    {
        return "p-8 text-center";
    }

    private string GetBorderColor()
    {
        return "border-gray-200 dark:border-gray-700";
    }

    public int UnreadCount => _unreadCount;
    public List<NotificationCenterItem> CurrentNotifications => _notifications;
    public Dictionary<string, List<NotificationCenterItem>> GroupedNotifications => _groupedNotifications;
}

