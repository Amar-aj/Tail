@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Utils
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Tail.Blazor.Utils.Models
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetContainerClasses()" style="@GetContainerStyle()" @attributes="AdditionalAttributes">
    @if (ShowThumbnails && Images.Count > 1)
    {
        <div class="@GetThumbnailsClasses()" style="@GetThumbnailsStyle()">
            @foreach (var image in Images)
            {
                <img 
                    src="@(image.ThumbnailUrl ?? image.Url)" 
                    alt="@image.Alt"
                    class="@GetThumbnailClasses()"
                    style="@GetThumbnailStyle(image)"
                    @onclick="() => OpenLightbox(image)"
                    @onkeydown="(e) => { if (e.Key == "Enter") OpenLightbox(image); }"
                    tabindex="0"
                    role="button"
                    aria-label="View @image.Title" />
            }
        </div>
    }

    @if (Images.Count == 1 || !ShowThumbnails)
    {
        <div class="@GetImageWrapperClasses()" style="@GetImageWrapperStyle()">
            <img 
                id="@imageId"
                src="@CurrentImage.Url" 
                alt="@CurrentImage.Alt"
                class="@GetImageClasses()"
                style="@GetImageStyle()"
                @onclick="() => { if (EnableLightbox) OpenLightbox(CurrentImage); }"
                @onmouseenter="() => { if (ZoomMode == ImageZoomMode.Hover) StartZoom(); }"
                @onmouseleave="() => { if (ZoomMode == ImageZoomMode.Hover) StopZoom(); }"
                @onmousemove="HandleMouseMove"
                @onwheel="HandleWheel" />
            
            @if (ZoomMode == ImageZoomMode.Always && ShowZoomControls)
            {
                <div class="@GetZoomControlsClasses()" style="@GetZoomControlsStyle()">
                    <button 
                        type="button"
                        class="@GetZoomButtonClasses()"
                        style="@GetZoomButtonStyle()"
                        @onclick="ZoomIn"
                        title="Zoom In">
                        âž•
                    </button>
                    <button 
                        type="button"
                        class="@GetZoomButtonClasses()"
                        style="@GetZoomButtonStyle()"
                        @onclick="ZoomOut"
                        title="Zoom Out">
                        âž–
                    </button>
                    <button 
                        type="button"
                        class="@GetZoomButtonClasses()"
                        style="@GetZoomButtonStyle()"
                        @onclick="ResetZoom"
                        title="Reset">
                        ðŸ”„
                    </button>
                </div>
            }
        </div>
    }

    <!-- Lightbox Modal -->
    @if (IsLightboxOpen)
    {
        <div class="@GetLightboxOverlayClasses()" 
             style="@GetLightboxOverlayStyle()"
             @onclick="CloseLightbox"
             @onkeydown="HandleLightboxKeyDown">
            <div class="@GetLightboxContainerClasses()" 
                 style="@GetLightboxContainerStyle()"
                 @onclick:stopPropagation="true">
                <!-- Close Button -->
                <button 
                    type="button"
                    class="@GetCloseButtonClasses()"
                    style="@GetCloseButtonStyle()"
                    @onclick="CloseLightbox"
                    aria-label="Close lightbox">
                    âœ•
                </button>

                <!-- Navigation Buttons -->
                @if (Images.Count > 1)
                {
                    <button 
                        type="button"
                        class="@GetNavButtonClasses()"
                        style="@GetNavButtonStyle()"
                        @onclick="PreviousImage"
                        aria-label="Previous image">
                        â€¹
                    </button>
                    <button 
                        type="button"
                        class="@GetNavButtonClasses()"
                        style="@GetNavButtonStyle()"
                        @onclick="NextImage"
                        aria-label="Next image">
                        â€º
                    </button>
                }

                <!-- Main Image -->
                <div class="@GetLightboxImageWrapperClasses()" style="@GetLightboxImageWrapperStyle()">
                    <img 
                        id="@lightboxImageId"
                        src="@CurrentLightboxImage.Url" 
                        alt="@CurrentLightboxImage.Alt"
                        class="@GetLightboxImageClasses()"
                        style="@GetLightboxImageStyle()" />
                </div>

                <!-- Image Info -->
                @if (!string.IsNullOrEmpty(CurrentLightboxImage.Title) || !string.IsNullOrEmpty(CurrentLightboxImage.Description))
                {
                    <div class="@GetImageInfoClasses()" style="@GetImageInfoStyle()">
                        @if (!string.IsNullOrEmpty(CurrentLightboxImage.Title))
                        {
                            <h3 class="@GetImageTitleClasses()" style="@GetImageTitleStyle()">@CurrentLightboxImage.Title</h3>
                        }
                        @if (!string.IsNullOrEmpty(CurrentLightboxImage.Description))
                        {
                            <p class="@GetImageDescriptionClasses()" style="@GetImageDescriptionStyle()">@CurrentLightboxImage.Description</p>
                        }
                        @if (Images.Count > 1)
                        {
                            <p class="@GetImageCounterClasses()" style="@GetImageCounterStyle()">
                                @(currentImageIndex + 1) / @Images.Count
                            </p>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public List<LightboxImage> Images { get; set; } = new();
    [Parameter] public ImageZoomMode ZoomMode { get; set; } = ImageZoomMode.Click;
    [Parameter] public bool EnableLightbox { get; set; } = true;
    [Parameter] public bool ShowThumbnails { get; set; } = true;
    [Parameter] public bool ShowZoomControls { get; set; } = true;
    [Parameter] public double MinZoom { get; set; } = 1.0;
    [Parameter] public double MaxZoom { get; set; } = 5.0;
    [Parameter] public double ZoomStep { get; set; } = 0.25;
    [Parameter] public LightboxTransition Transition { get; set; } = LightboxTransition.Fade;
    [Parameter] public EventCallback<LightboxImage> OnImageClick { get; set; }

    private string imageId = $"image-zoom-{Guid.NewGuid():N}";
    private string lightboxImageId = $"lightbox-image-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private bool IsLightboxOpen { get; set; } = false;
    private LightboxImage CurrentImage => Images.FirstOrDefault() ?? new LightboxImage();
    private LightboxImage CurrentLightboxImage => Images.ElementAtOrDefault(currentImageIndex) ?? CurrentImage;
    private int currentImageIndex = 0;
    private double currentZoom = 1.0;
    private double panX = 0;
    private double panY = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Utils/imagezoom.js");
            }
            catch { }
        }
    }

    private void OpenLightbox(LightboxImage image)
    {
        currentImageIndex = Images.IndexOf(image);
        IsLightboxOpen = true;
        currentZoom = 1.0;
        panX = 0;
        panY = 0;
        StateHasChanged();
    }

    private void CloseLightbox()
    {
        IsLightboxOpen = false;
        StateHasChanged();
    }

    private void NextImage()
    {
        if (currentImageIndex < Images.Count - 1)
        {
            currentImageIndex++;
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            StateHasChanged();
        }
    }

    private void PreviousImage()
    {
        if (currentImageIndex > 0)
        {
            currentImageIndex--;
            currentZoom = 1.0;
            panX = 0;
            panY = 0;
            StateHasChanged();
        }
    }

    private void HandleLightboxKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            CloseLightbox();
        }
        else if (e.Key == "ArrowLeft")
        {
            PreviousImage();
        }
        else if (e.Key == "ArrowRight")
        {
            NextImage();
        }
    }

    private void StartZoom()
    {
        // Zoom on hover - handled by CSS/JS
    }

    private void StopZoom()
    {
        // Reset zoom on hover end
    }

    private void HandleMouseMove(MouseEventArgs e)
    {
        // Pan image when zoomed
    }

    private void HandleWheel(WheelEventArgs e)
    {
        if (ZoomMode == ImageZoomMode.Always)
        {
            if (e.DeltaY < 0)
            {
                ZoomIn();
            }
            else
            {
                ZoomOut();
            }
        }
    }

    private void ZoomIn()
    {
        currentZoom = Math.Min(currentZoom + ZoomStep, MaxZoom);
        StateHasChanged();
    }

    private void ZoomOut()
    {
        currentZoom = Math.Max(currentZoom - ZoomStep, MinZoom);
        StateHasChanged();
    }

    private void ResetZoom()
    {
        currentZoom = 1.0;
        panX = 0;
        panY = 0;
        StateHasChanged();
    }

    // Styling methods
    private string GetContainerClasses() => "relative";
    private string GetContainerStyle() => "";

    private string GetThumbnailsClasses() => "grid grid-cols-4 gap-2 mb-4";
    private string GetThumbnailsStyle() => "";

    private string GetThumbnailClasses() => "w-full h-24 object-cover rounded-md cursor-pointer transition-transform duration-200 hover:scale-105 border";
    private string GetThumbnailStyle(LightboxImage image) => $"border-color: var(--color-border);";

    private string GetImageWrapperClasses() => "relative overflow-hidden rounded-lg";
    private string GetImageWrapperStyle() => "";

    private string GetImageClasses() => "w-full h-auto transition-transform duration-300";
    private string GetImageStyle() => $"transform: scale({currentZoom}) translate({panX}px, {panY}px); cursor: {(EnableLightbox ? "zoom-in" : "default")};";

    private string GetZoomControlsClasses() => "absolute top-4 right-4 flex gap-2 z-10";
    private string GetZoomControlsStyle() => "";

    private string GetZoomButtonClasses() => "w-10 h-10 rounded-full flex items-center justify-center shadow-lg transition-all duration-200 hover:scale-110";
    private string GetZoomButtonStyle() => "background-color: var(--color-surface); border: 1px solid var(--color-border); color: var(--color-text-primary);";

    private string GetLightboxOverlayClasses() => "fixed inset-0 z-50 flex items-center justify-center p-4";
    private string GetLightboxOverlayStyle() => "background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(4px);";

    private string GetLightboxContainerClasses() => "relative max-w-7xl max-h-full w-full h-full flex flex-col items-center justify-center";
    private string GetLightboxContainerStyle() => "";

    private string GetCloseButtonClasses() => "absolute top-4 right-4 w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold transition-all duration-200 hover:scale-110 z-20";
    private string GetCloseButtonStyle() => "background-color: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(4px);";

    private string GetNavButtonClasses() => "absolute top-1/2 -translate-y-1/2 w-12 h-12 rounded-full flex items-center justify-center text-3xl font-bold transition-all duration-200 hover:scale-110 z-20";
    private string GetNavButtonStyle() => "background-color: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(4px);";

    private string GetLightboxImageWrapperClasses() => "flex-1 flex items-center justify-center overflow-hidden p-8";
    private string GetLightboxImageWrapperStyle() => "";

    private string GetLightboxImageClasses() => "max-w-full max-h-full object-contain";
    private string GetLightboxImageStyle() => $"transform: scale({currentZoom}) translate({panX}px, {panY}px); transition: transform 0.3s ease;";

    private string GetImageInfoClasses() => "absolute bottom-0 left-0 right-0 p-6 text-center";
    private string GetImageInfoStyle() => "background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);";

    private string GetImageTitleClasses() => "text-xl font-semibold mb-2";
    private string GetImageTitleStyle() => "color: white;";

    private string GetImageDescriptionClasses() => "text-sm mb-2";
    private string GetImageDescriptionStyle() => "color: rgba(255, 255, 255, 0.9);";

    private string GetImageCounterClasses() => "text-xs";
    private string GetImageCounterStyle() => "color: rgba(255, 255, 255, 0.7);";

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

