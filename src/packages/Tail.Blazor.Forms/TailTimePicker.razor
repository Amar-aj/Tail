@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@using Microsoft.AspNetCore.Components.Web

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@Id" class="@GetLabelClasses()">
            @Label
            @if (Required)
            {
                <span class="ml-1" style="color: var(--color-danger)">*</span>
            }
        </label>
    }
    <div class="relative">
        <div class="@GetInputContainerClasses()" style="@GetInputContainerStyle()">
            <input 
                type="text"
                id="@Id"
                class="@GetInputClasses()"
                style="@GetInputStyle()"
                value="@GetDisplayValue()"
                placeholder="@Placeholder"
                readonly="true"
                @onclick="ToggleTimePicker"
                @onfocus="HandleFocus"
                disabled="@Disabled"
                @attributes="AdditionalAttributes" />
            <button 
                type="button"
                class="@GetTimeButtonClasses()"
                style="@GetTimeButtonStyle()"
                @onclick="ToggleTimePicker"
                disabled="@Disabled">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
        
        @if (ShowTimePicker && !Disabled)
        {
            <div class="@GetTimePickerClasses()" style="@GetTimePickerStyle()">
                <div class="@GetTimeDisplayClasses()">
                    <div class="@GetTimeSectionClasses()">
                        <div class="@GetTimeLabelClasses()">Hour</div>
                        <div class="@GetTimeInputContainerClasses()">
                            <button 
                                type="button"
                                class="@GetTimeNavButtonClasses()"
                                @onclick="IncrementHour"
                                @onclick:preventDefault="true">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                            <input 
                                type="number"
                                class="@GetTimeInputClasses()"
                                @bind="tempHour"
                                @bind:event="onchange"
                                @bind:after="UpdateTime"
                                min="@(Use24Hour ? 0 : 1)"
                                max="@(Use24Hour ? 23 : 12)" />
                            <button 
                                type="button"
                                class="@GetTimeNavButtonClasses()"
                                @onclick="DecrementHour"
                                @onclick:preventDefault="true">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                        </div>
                        <div class="@GetTimeSeparatorClasses()">:</div>
                        <div class="@GetTimeSectionClasses()">
                            <div class="@GetTimeLabelClasses()">Minute</div>
                            <div class="@GetTimeInputContainerClasses()">
                                <button 
                                    type="button"
                                    class="@GetTimeNavButtonClasses()"
                                    @onclick="IncrementMinute"
                                    @onclick:preventDefault="true">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                    </svg>
                                </button>
                                <input 
                                    type="number"
                                    class="@GetTimeInputClasses()"
                                    @bind="tempMinute"
                                    @bind:event="onchange"
                                    @bind:after="UpdateTime"
                                    min="0"
                                    max="59"
                                    step="@MinuteInterval" />
                                <button 
                                    type="button"
                                    class="@GetTimeNavButtonClasses()"
                                    @onclick="DecrementMinute"
                                    @onclick:preventDefault="true">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        @if (!Use24Hour)
                        {
                            <div class="@GetTimeSeparatorClasses()"></div>
                            <div class="@GetTimeSectionClasses()">
                                <div class="@GetTimeLabelClasses()">Period</div>
                                <div class="@GetTimeInputContainerClasses()">
                                    <button 
                                        type="button"
                                        class="@GetTimeNavButtonClasses()"
                                        @onclick="TogglePeriod"
                                        @onclick:preventDefault="true">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </button>
                                    <div class="@GetPeriodDisplayClasses()">@(IsAM ? "AM" : "PM")</div>
                                    <button 
                                        type="button"
                                        class="@GetTimeNavButtonClasses()"
                                        @onclick="TogglePeriod"
                                        @onclick:preventDefault="true">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                @if (ShowQuickTimes)
                {
                    <div class="@GetQuickTimesClasses()">
                        <div class="@GetQuickTimesLabelClasses()">Quick Times</div>
                        <div class="@GetQuickTimesGridClasses()">
                            @foreach (var quickTime in QuickTimes)
                            {
                                <button 
                                    type="button"
                                    class="@GetQuickTimeButtonClasses()"
                                    @onclick="() => ApplyQuickTime(quickTime)"
                                    @onclick:preventDefault="true">
                                    @quickTime
                                </button>
                            }
                        </div>
                    </div>
                }
                
                <div class="@GetFooterClasses()">
                    <button 
                        type="button"
                        class="@GetActionButtonClasses()"
                        @onclick="ClearTime"
                        @onclick:preventDefault="true">
                        Clear
                    </button>
                    <button 
                        type="button"
                        class="@GetActionButtonClasses(true)"
                        @onclick="ApplyTime"
                        @onclick:preventDefault="true">
                        Apply
                    </button>
                </div>
            </div>
        }
    </div>
    @if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-danger)">@ErrorMessage</p>
    }
    @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-text-secondary)">@HelperText</p>
    }
</div>

@code {
    [Parameter] public TimeSpan? Value { get; set; }
    [Parameter] public EventCallback<TimeSpan?> ValueChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "Select time...";
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowError { get; set; } = true;
    [Parameter] public InputSize Size { get; set; } = InputSize.Md;
    [Parameter] public bool Use24Hour { get; set; } = false;
    [Parameter] public int MinuteInterval { get; set; } = 1;
    [Parameter] public bool ShowQuickTimes { get; set; } = true;
    [Parameter] public List<string> QuickTimes { get; set; } = new();
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    private bool ShowTimePicker { get; set; }
    private int tempHour;
    private int tempMinute;
    private bool IsAM { get; set; } = true;

    protected override void OnInitialized()
    {
        if (Value.HasValue)
        {
            var time = Value.Value;
            tempHour = Use24Hour ? time.Hours : (time.Hours % 12 == 0 ? 12 : time.Hours % 12);
            tempMinute = time.Minutes;
            IsAM = time.Hours < 12;
        }
        else
        {
            tempHour = Use24Hour ? 0 : 12;
            tempMinute = 0;
        }
        
        if (QuickTimes.Count == 0 && ShowQuickTimes)
        {
            QuickTimes = new List<string>
            {
                "12:00 AM", "6:00 AM", "9:00 AM", "12:00 PM", "3:00 PM", "6:00 PM", "9:00 PM"
            };
        }
    }

    protected override void OnParametersSet()
    {
        if (Value.HasValue)
        {
            var time = Value.Value;
            tempHour = Use24Hour ? time.Hours : (time.Hours % 12 == 0 ? 12 : time.Hours % 12);
            tempMinute = time.Minutes;
            IsAM = time.Hours < 12;
        }
    }

    private void ToggleTimePicker()
    {
        if (!Disabled)
        {
            ShowTimePicker = !ShowTimePicker;
        }
    }

    private void UpdateTime()
    {
        // Ensure values are within valid range
        if (Use24Hour)
        {
            tempHour = Math.Clamp(tempHour, 0, 23);
        }
        else
        {
            tempHour = Math.Clamp(tempHour, 1, 12);
        }
        tempMinute = Math.Clamp(tempMinute, 0, 59);
        
        // Round minute to interval
        if (MinuteInterval > 1)
        {
            tempMinute = (tempMinute / MinuteInterval) * MinuteInterval;
        }
    }

    private void IncrementHour()
    {
        if (Use24Hour)
        {
            tempHour = (tempHour + 1) % 24;
        }
        else
        {
            tempHour = tempHour == 12 ? 1 : tempHour + 1;
        }
        UpdateTime();
    }

    private void DecrementHour()
    {
        if (Use24Hour)
        {
            tempHour = tempHour == 0 ? 23 : tempHour - 1;
        }
        else
        {
            tempHour = tempHour == 1 ? 12 : tempHour - 1;
        }
        UpdateTime();
    }

    private void IncrementMinute()
    {
        tempMinute = (tempMinute + MinuteInterval) % 60;
        UpdateTime();
    }

    private void DecrementMinute()
    {
        tempMinute = tempMinute == 0 ? 60 - MinuteInterval : tempMinute - MinuteInterval;
        UpdateTime();
    }

    private void TogglePeriod()
    {
        IsAM = !IsAM;
    }

    private void ApplyTime()
    {
        int hours = Use24Hour ? tempHour : (IsAM ? (tempHour == 12 ? 0 : tempHour) : (tempHour == 12 ? 12 : tempHour + 12));
        Value = new TimeSpan(hours, tempMinute, 0);
        if (ValueChanged.HasDelegate)
        {
            ValueChanged.InvokeAsync(Value);
        }
        ShowTimePicker = false;
    }

    private void ClearTime()
    {
        Value = null;
        if (ValueChanged.HasDelegate)
        {
            ValueChanged.InvokeAsync(null);
        }
        ShowTimePicker = false;
    }

    private void ApplyQuickTime(string quickTime)
    {
        if (TimeSpan.TryParse(quickTime.Replace(" AM", "").Replace(" PM", ""), out var time))
        {
            if (quickTime.Contains("PM") && time.Hours < 12)
            {
                time = time.Add(new TimeSpan(12, 0, 0));
            }
            else if (quickTime.Contains("AM") && time.Hours == 12)
            {
                time = time.Subtract(new TimeSpan(12, 0, 0));
            }
            
            Value = time;
            if (ValueChanged.HasDelegate)
            {
                ValueChanged.InvokeAsync(Value);
            }
            ShowTimePicker = false;
        }
    }

    private string GetDisplayValue()
    {
        if (!Value.HasValue) return string.Empty;
        
        var time = Value.Value;
        if (Use24Hour)
        {
            return $"{time.Hours:D2}:{time.Minutes:D2}";
        }
        else
        {
            var hours = time.Hours % 12 == 0 ? 12 : time.Hours % 12;
            var period = time.Hours < 12 ? "AM" : "PM";
            return $"{hours:D2}:{time.Minutes:D2} {period}";
        }
    }

    private void HandleFocus(FocusEventArgs e)
    {
        // Keep picker open on focus
    }

    // Styling methods using global CSS variables
    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }

    private string GetLabelClasses()
    {
        return "block text-sm font-medium mb-1";
    }

    private string GetInputContainerClasses()
    {
        return "flex items-center gap-2 rounded-lg border transition-all";
    }

    private string GetInputContainerStyle()
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface);",
            "border-color: var(--color-border);",
            "transition: border-color var(--transition-fast), box-shadow var(--transition-fast);"
        };
        
        if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
        {
            styles.Add("border-color: var(--color-danger);");
        }
        
        return string.Join(" ", styles);
    }

    private string GetInputClasses()
    {
        var classes = new List<string> { "flex-1 bg-transparent border-0 outline-none" };
        
        classes.Add(Size switch
        {
            InputSize.Sm => "px-3 py-1.5 text-sm",
            InputSize.Md => "px-4 py-2 text-base",
            InputSize.Lg => "px-5 py-2.5 text-lg",
            _ => "px-4 py-2 text-base"
        });
        
        return string.Join(" ", classes);
    }

    private string GetInputStyle()
    {
        return "color: var(--color-text-primary);";
    }

    private string GetTimeButtonClasses()
    {
        return "p-2 rounded-lg transition-all hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none";
    }

    private string GetTimeButtonStyle()
    {
        return "color: var(--color-text-secondary);";
    }

    private string GetTimePickerClasses()
    {
        return "absolute z-50 mt-1 rounded-lg shadow-lg border";
    }

    private string GetTimePickerStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            box-shadow: var(--shadow-lg);
            min-width: 280px;
        ";
    }

    private string GetTimeDisplayClasses()
    {
        return "p-4";
    }

    private string GetTimeSectionClasses()
    {
        return "flex flex-col items-center gap-1";
    }

    private string GetTimeLabelClasses()
    {
        return "text-xs font-semibold uppercase tracking-wider";
    }

    private string GetTimeInputContainerClasses()
    {
        return "flex flex-col items-center gap-1";
    }

    private string GetTimeNavButtonClasses()
    {
        return "p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors";
    }

    private string GetTimeInputClasses()
    {
        return "w-16 px-2 py-1 text-center text-lg font-semibold rounded border bg-transparent";
    }

    private string GetTimeSeparatorClasses()
    {
        return "text-2xl font-bold self-end pb-6";
    }

    private string GetPeriodDisplayClasses()
    {
        return "px-3 py-1 text-lg font-semibold";
    }

    private string GetQuickTimesClasses()
    {
        return "p-4 border-t";
    }

    private string GetQuickTimesLabelClasses()
    {
        return "text-xs font-semibold uppercase tracking-wider mb-2";
    }

    private string GetQuickTimesGridClasses()
    {
        return "grid grid-cols-2 gap-2";
    }

    private string GetQuickTimeButtonClasses()
    {
        return "px-3 py-1.5 text-sm rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-700";
    }

    private string GetFooterClasses()
    {
        return "p-4 border-t flex items-center justify-end gap-2";
    }

    private string GetActionButtonClasses(bool primary = false)
    {
        var classes = new List<string> { "px-4 py-2 rounded-lg text-sm font-medium transition-colors" };
        
        if (primary)
        {
            classes.Add("text-white");
        }
        else
        {
            classes.Add("hover:bg-gray-100 dark:hover:bg-gray-700");
        }
        
        return string.Join(" ", classes);
    }

    private string GetActionButtonStyle(bool primary = false)
    {
        if (primary)
        {
            return "background-color: var(--color-primary);";
        }
        return "color: var(--color-text-secondary);";
    }
}

