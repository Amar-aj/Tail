@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@inject IJSRuntime JSRuntime

<div class="@GetContainerClasses()">
    <label class="@GetLabelClasses()">@Label</label>
    <div class="relative">
        <input 
            type="text"
            class="@GetInputClasses()"
            value="@GetDisplayValue()"
            placeholder="@Placeholder"
            readonly
            @onclick="ToggleCalendar"
            @attributes="AdditionalAttributes" />
        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        </div>
        
        @if (IsOpen)
        {
            <div class="@GetCalendarClasses()">
                <div class="flex items-center justify-between mb-4">
                    <button 
                        type="button"
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
                        @onclick="PreviousMonth">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h3 class="text-lg font-semibold">@CurrentMonth.ToString("MMMM yyyy")</h3>
                    <button 
                        type="button"
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"
                        @onclick="NextMonth">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-7 gap-1 mb-2">
                    @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                    {
                        <div class="text-center text-xs font-medium text-gray-500 dark:text-gray-400 py-1">
                            @day
                        </div>
                    }
                </div>
                
                <div class="grid grid-cols-7 gap-1">
                    @foreach (var day in GetCalendarDays())
                    {
                        <button
                            type="button"
                            class="@GetDayClasses(day)"
                            @onclick="() => SelectDate(day)"
                            disabled="@(day == null || day.Value < MinDate || day.Value > MaxDate)">
                            @if (day.HasValue)
                            {
                                @day.Value.Day
                            }
                        </button>
                    }
                </div>
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">@HelperText</p>
    }
    @if (!string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">@ErrorText</p>
    }
</div>

@code {
    [Parameter] public DateTime? Value { get; set; }
    [Parameter] public EventCallback<DateTime?> ValueChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "Select date...";
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorText { get; set; }
    [Parameter] public DateTime MinDate { get; set; } = DateTime.MinValue;
    [Parameter] public DateTime MaxDate { get; set; } = DateTime.MaxValue;
    [Parameter] public string? Format { get; set; } = "yyyy-MM-dd";
    
    private bool IsOpen { get; set; }
    private DateTime CurrentMonth { get; set; } = DateTime.Today;
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "w-full relative" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetLabelClasses() => "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1";
    
    private string GetInputClasses()
    {
        var classes = new List<string>
        {
            "w-full px-3 py-2 border rounded-lg",
            "bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100",
            "focus:outline-none focus:ring-2 focus:ring-blue-500",
            "cursor-pointer"
        };
        
        if (!string.IsNullOrEmpty(ErrorText))
        {
            classes.Add("border-red-300 dark:border-red-700");
        }
        else
        {
            classes.Add("border-gray-300 dark:border-gray-700");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetCalendarClasses() => 
        "absolute z-50 mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-4 w-64";
    
    private string GetDayClasses(DateTime? day)
    {
        if (day == null) return "p-2 text-sm";
        
        var classes = new List<string> { "p-2 text-sm rounded hover:bg-gray-100 dark:hover:bg-gray-700" };
        
        if (day.Value.Date == DateTime.Today)
        {
            classes.Add("font-semibold text-blue-600 dark:text-blue-400");
        }
        
        if (day.Value.Date == Value?.Date)
        {
            classes.Add("bg-blue-600 text-white hover:bg-blue-700");
        }
        else
        {
            classes.Add("text-gray-700 dark:text-gray-300");
        }
        
        if (day.Value.Month != CurrentMonth.Month)
        {
            classes.Add("opacity-50");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetDisplayValue()
    {
        return Value?.ToString(Format) ?? "";
    }
    
    private List<DateTime?> GetCalendarDays()
    {
        var firstDay = new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1);
        var startDate = firstDay.AddDays(-(int)firstDay.DayOfWeek);
        var days = new List<DateTime?>();
        
        for (int i = 0; i < 42; i++)
        {
            var date = startDate.AddDays(i);
            if (date.Month == CurrentMonth.Month)
            {
                days.Add(date);
            }
            else
            {
                days.Add(null);
            }
        }
        
        return days;
    }
    
    private void ToggleCalendar()
    {
        IsOpen = !IsOpen;
        if (IsOpen && Value.HasValue)
        {
            CurrentMonth = Value.Value;
        }
    }
    
    private void PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
    }
    
    private void NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
    }
    
    private async Task SelectDate(DateTime? date)
    {
        if (date.HasValue)
        {
            Value = date.Value;
            if (ValueChanged.HasDelegate)
            {
                await ValueChanged.InvokeAsync(Value);
            }
            IsOpen = false;
        }
    }
}

