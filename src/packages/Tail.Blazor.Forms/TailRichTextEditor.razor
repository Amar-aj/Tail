@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetContainerClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@editorId" class="@GetLabelClasses()">@Label</label>
    }
    
    <!-- Toolbar -->
    @if (ShowToolbar && ToolbarItems.Any())
    {
        <div class="@GetToolbarClasses()" style="@GetToolbarStyle()">
            @foreach (var item in ToolbarItems)
            {
                @if (item.IsSeparator)
                {
                    <div class="@GetSeparatorClasses()" style="@GetSeparatorStyle()"></div>
                }
                else if (item.Command == "heading")
                {
                    <select 
                        class="@GetSelectClasses()"
                        style="@GetSelectStyle()"
                        @onchange="(e) => ExecuteCommand(item.Command, e.Value?.ToString())"
                        disabled="@item.Disabled"
                        title="@item.Tooltip">
                        <option value="">Heading</option>
                        <option value="h1">Heading 1</option>
                        <option value="h2">Heading 2</option>
                        <option value="h3">Heading 3</option>
                        <option value="h4">Heading 4</option>
                        <option value="h5">Heading 5</option>
                        <option value="h6">Heading 6</option>
                    </select>
                }
                else if (item.Command == "fontSize")
                {
                    <select 
                        class="@GetSelectClasses()"
                        style="@GetSelectStyle()"
                        @onchange="(e) => ExecuteCommand(item.Command, e.Value?.ToString())"
                        disabled="@item.Disabled"
                        title="@item.Tooltip">
                        <option value="">Size</option>
                        <option value="1">8px</option>
                        <option value="2">10px</option>
                        <option value="3">12px</option>
                        <option value="4">14px</option>
                        <option value="5">18px</option>
                        <option value="6">24px</option>
                        <option value="7">36px</option>
                    </select>
                }
                else if (item.Command == "foreColor" || item.Command == "backColor")
                {
                    <input 
                        type="color"
                        class="@GetColorInputClasses()"
                        @onchange="(e) => ExecuteCommand(item.Command, e.Value?.ToString())"
                        disabled="@item.Disabled"
                        title="@item.Tooltip" />
                }
                else
                {
                    <button
                        type="button"
                        class="@GetToolbarButtonClasses(item)"
                        style="@GetToolbarButtonStyle(item)"
                        @onclick="() => ExecuteCommand(item.Command, item.Value)"
                        disabled="@item.Disabled"
                        title="@item.Tooltip">
                        @if (!string.IsNullOrEmpty(item.Icon))
                        {
                            <span>@item.Icon</span>
                        }
                        else
                        {
                            <span>@item.Command</span>
                        }
                    </button>
                }
            }
        </div>
    }
    
    <!-- Editor -->
    <div class="@GetEditorWrapperClasses()" style="@GetEditorWrapperStyle()">
        <div 
            id="@editorId"
            class="@GetEditorClasses()"
            style="@GetEditorStyle()"
            contenteditable="true"
            @oninput="HandleInput"
            @onblur="HandleBlur"
            @onkeydown="HandleKeyDown"
            @onpaste="HandlePaste"
            @attributes="AdditionalAttributes">
            @((MarkupString)HtmlContent)
        </div>
    </div>
    
    @if (ShowError && !string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm" style="color: var(--color-danger);">@ErrorText</p>
    }
    @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm" style="color: var(--color-text-secondary);">@HelperText</p>
    }
</div>

@code {
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "Start typing...";
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorText { get; set; }
    [Parameter] public bool ShowError { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowToolbar { get; set; } = true;
    [Parameter] public List<RichTextEditorToolbarItem> ToolbarItems { get; set; } = new();
    [Parameter] public RichTextEditorSize Size { get; set; } = RichTextEditorSize.Md;
    [Parameter] public RichTextEditorVariant Variant { get; set; } = RichTextEditorVariant.Default;
    [Parameter] public int MinHeight { get; set; } = 200;
    [Parameter] public int MaxHeight { get; set; } = 0; // 0 for unlimited
    [Parameter] public EventCallback<string> OnContentChanged { get; set; }

    private string editorId = $"rte-{Guid.NewGuid():N}";
    private string HtmlContent => Value;
    private IJSObjectReference? jsModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Forms/richtexteditor.js");
            }
            catch
            {
                // JavaScript module not available
            }
        }

        if (firstRender && !string.IsNullOrEmpty(Placeholder))
        {
            await SetPlaceholder();
        }
    }

    protected override void OnParametersSet()
    {
        if (ToolbarItems == null || !ToolbarItems.Any())
        {
            ToolbarItems = GetDefaultToolbarItems();
        }
    }

    private List<RichTextEditorToolbarItem> GetDefaultToolbarItems()
    {
        return new List<RichTextEditorToolbarItem>
        {
            new() { Command = "bold", Icon = "B", Tooltip = "Bold (Ctrl+B)" },
            new() { Command = "italic", Icon = "I", Tooltip = "Italic (Ctrl+I)" },
            new() { Command = "underline", Icon = "U", Tooltip = "Underline (Ctrl+U)" },
            new() { IsSeparator = true },
            new() { Command = "heading", Icon = "H", Tooltip = "Heading" },
            new() { Command = "fontSize", Icon = "A", Tooltip = "Font Size" },
            new() { IsSeparator = true },
            new() { Command = "foreColor", Icon = "üé®", Tooltip = "Text Color" },
            new() { Command = "backColor", Icon = "üñçÔ∏è", Tooltip = "Background Color" },
            new() { IsSeparator = true },
            new() { Command = "justifyLeft", Icon = "‚¨Ö", Tooltip = "Align Left" },
            new() { Command = "justifyCenter", Icon = "‚Üî", Tooltip = "Align Center" },
            new() { Command = "justifyRight", Icon = "‚û°", Tooltip = "Align Right" },
            new() { IsSeparator = true },
            new() { Command = "insertUnorderedList", Icon = "‚Ä¢", Tooltip = "Bullet List" },
            new() { Command = "insertOrderedList", Icon = "1.", Tooltip = "Numbered List" },
            new() { IsSeparator = true },
            new() { Command = "createLink", Icon = "üîó", Tooltip = "Insert Link" },
            new() { Command = "insertImage", Icon = "üñºÔ∏è", Tooltip = "Insert Image" },
            new() { IsSeparator = true },
            new() { Command = "removeFormat", Icon = "üßπ", Tooltip = "Clear Formatting" },
            new() { Command = "undo", Icon = "‚Ü∂", Tooltip = "Undo (Ctrl+Z)" },
            new() { Command = "redo", Icon = "‚Ü∑", Tooltip = "Redo (Ctrl+Y)" }
        };
    }

    private async Task ExecuteCommand(string command, string? value = null)
    {
        if (jsModule == null || Disabled) return;

        try
        {
            if (command == "createLink")
            {
                var url = await jsModule.InvokeAsync<string>("prompt", "Enter URL:");
                if (!string.IsNullOrEmpty(url))
                {
                    await jsModule.InvokeVoidAsync("execCommand", editorId, command, false, null, url);
                }
            }
            else if (command == "insertImage")
            {
                var url = await jsModule.InvokeAsync<string>("prompt", "Enter image URL:");
                if (!string.IsNullOrEmpty(url))
                {
                    await jsModule.InvokeVoidAsync("execCommand", editorId, command, false, null, url);
                }
            }
            else if (command == "heading" && !string.IsNullOrEmpty(value))
            {
                await jsModule.InvokeVoidAsync("execCommand", editorId, "formatBlock", false, null, value);
            }
            else if (command == "fontSize" && !string.IsNullOrEmpty(value))
            {
                await jsModule.InvokeVoidAsync("execCommand", editorId, "fontSize", false, null, value);
            }
            else
            {
                await jsModule.InvokeVoidAsync("execCommand", editorId, command, false, null, value);
            }
            
            await UpdateValue();
        }
        catch
        {
            // Error executing command
        }
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        await UpdateValue();
    }

    private async Task HandleBlur(FocusEventArgs e)
    {
        await UpdateValue();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Handle keyboard shortcuts
        if ((e.CtrlKey || e.MetaKey) && (e.Key == "b" || e.Key == "B" || e.Key == "i" || e.Key == "I" || e.Key == "u" || e.Key == "U"))
        {
            var command = e.Key.ToLower() switch
            {
                "b" => "bold",
                "i" => "italic",
                "u" => "underline",
                _ => null
            };
            
            if (command != null)
            {
                await ExecuteCommand(command);
            }
        }
    }

    private async Task HandlePaste(ClipboardEventArgs e)
    {
        // Allow paste, then clean up HTML
        await Task.Delay(10); // Small delay to let paste complete
        await UpdateValue();
    }

    private async Task UpdateValue()
    {
        if (jsModule == null) return;

        try
        {
            var html = await jsModule.InvokeAsync<string>("getEditorContent", editorId);
            Value = html ?? string.Empty;
            
            if (ValueChanged.HasDelegate)
            {
                await ValueChanged.InvokeAsync(Value);
            }
            
            if (OnContentChanged.HasDelegate)
            {
                await OnContentChanged.InvokeAsync(Value);
            }
        }
        catch
        {
            // Error getting content
        }
    }

    private async Task SetPlaceholder()
    {
        if (jsModule == null) return;

        try
        {
            await jsModule.InvokeVoidAsync("setPlaceholder", editorId, Placeholder);
        }
        catch { }
    }


    // Styling methods
    private string GetContainerClasses()
    {
        return "w-full";
    }

    private string GetLabelClasses()
    {
        return "block text-sm font-medium mb-2";
    }

    private string GetLabelStyle()
    {
        return $"color: var(--color-text-primary);";
    }

    private string GetToolbarClasses()
    {
        return "flex flex-wrap items-center gap-1 p-2 border-b rounded-t-lg";
    }

    private string GetToolbarStyle()
    {
        return $"background-color: var(--color-surface-2); border-color: var(--color-border); border-radius: var(--radius-md) var(--radius-md) 0 0;";
    }

    private string GetSeparatorClasses()
    {
        return "w-px h-6";
    }

    private string GetSeparatorStyle()
    {
        return $"background-color: var(--color-border);";
    }

    private string GetToolbarButtonClasses(RichTextEditorToolbarItem item)
    {
        var baseClasses = "px-2 py-1.5 text-sm rounded transition-colors min-w-[32px] flex items-center justify-center";
        var disabledClasses = item.Disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer hover:bg-opacity-10";
        return $"{baseClasses} {disabledClasses}";
    }

    private string GetToolbarButtonStyle(RichTextEditorToolbarItem item)
    {
        if (item.Disabled)
        {
            return $"background-color: transparent; color: var(--color-text-muted);";
        }
        return $"background-color: transparent; color: var(--color-text-primary); hover:background-color: var(--color-surface-3);";
    }

    private string GetSelectClasses()
    {
        return "px-2 py-1.5 text-sm rounded border transition-colors";
    }

    private string GetSelectStyle()
    {
        return $"background-color: var(--color-surface); border-color: var(--color-border); color: var(--color-text-primary);";
    }

    private string GetColorInputClasses()
    {
        return "w-8 h-8 rounded border cursor-pointer";
    }

    private string GetEditorWrapperClasses()
    {
        return "relative border rounded-b-lg overflow-hidden";
    }

    private string GetEditorWrapperStyle()
    {
        var variantStyle = Variant switch
        {
            RichTextEditorVariant.Outline => $"border-color: var(--color-border);",
            RichTextEditorVariant.Filled => $"background-color: var(--color-surface-2); border-color: var(--color-border);",
            _ => $"border-color: var(--color-border);"
        };
        
        return $"{variantStyle} border-radius: 0 0 var(--radius-md) var(--radius-md);";
    }

    private string GetEditorClasses()
    {
        var sizeClasses = Size switch
        {
            RichTextEditorSize.Sm => "text-sm p-2",
            RichTextEditorSize.Lg => "text-lg p-4",
            _ => "text-base p-3"
        };
        
        return $"{sizeClasses} min-h-[{MinHeight}px] outline-none overflow-y-auto";
    }

    private string GetEditorStyle()
    {
        var maxHeightStyle = MaxHeight > 0 ? $"max-height: {MaxHeight}px;" : "";
        return $"background-color: var(--color-surface); color: var(--color-text-primary); {maxHeightStyle}";
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

