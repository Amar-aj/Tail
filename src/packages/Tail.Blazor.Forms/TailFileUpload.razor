@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms

<div class="@GetContainerClasses()">
    <label class="@GetLabelClasses()">@Label</label>
    <div class="@GetUploadAreaClasses()" @ondragover="HandleDragOver" @ondrop="HandleDrop" @ondragleave="HandleDragLeave">
        <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <div class="mt-4">
                <label class="cursor-pointer">
                    <span class="mt-2 block text-sm font-medium text-gray-900 dark:text-gray-100">
                        @if (IsDragging)
                        {
                            <span>Drop files here</span>
                        }
                        else
                        {
                            <span>Drag and drop files here, or <span class="text-blue-600 dark:text-blue-400">browse</span></span>
                        }
                    </span>
                    <InputFile 
                        class="hidden" 
                        @ref="fileInputComponent" 
                        OnChange="@HandleFileChange" 
                        accept="@Accept" 
                        multiple="@Multiple"
                        disabled="@Disabled" />
                </label>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">@HelperText</p>
            </div>
        </div>
    </div>
    
    @if (UploadedFiles.Any())
    {
        <div class="mt-4 space-y-2">
            @foreach (var file in UploadedFiles)
            {
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100">@file.Name</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">@FormatFileSize(file.Size)</p>
                        </div>
                    </div>
                    @if (ShowRemoveButton)
                    {
                        <button 
                            type="button"
                            class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                            @onclick="() => RemoveFile(file)">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    }
                </div>
            }
        </div>
    }
    
    @if (!string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">@ErrorText</p>
    }
</div>

@code {
    [Parameter] public List<IBrowserFile> UploadedFiles { get; set; } = new();
    [Parameter] public EventCallback<List<IBrowserFile>> UploadedFilesChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? HelperText { get; set; } = "PNG, JPG, GIF up to 10MB";
    [Parameter] public string? ErrorText { get; set; }
    [Parameter] public string? Accept { get; set; }
    [Parameter] public bool Multiple { get; set; } = false;
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowRemoveButton { get; set; } = true;
    [Parameter] public long MaxFileSize { get; set; } = 10485760; // 10MB
    
    private InputFile? fileInputComponent;
    private bool IsDragging { get; set; }
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetLabelClasses() => "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1";
    
    private string GetUploadAreaClasses()
    {
        var classes = new List<string>
        {
            "mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed rounded-lg",
            "transition-colors"
        };
        
        if (IsDragging)
        {
            classes.Add("border-blue-400 bg-blue-50 dark:bg-blue-900/20");
        }
        else if (!string.IsNullOrEmpty(ErrorText))
        {
            classes.Add("border-red-300 dark:border-red-700");
        }
        else
        {
            classes.Add("border-gray-300 dark:border-gray-700");
        }
        
        if (Disabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }
        else
        {
            classes.Add("cursor-pointer hover:border-gray-400 dark:hover:border-gray-600");
        }
        
        return string.Join(" ", classes);
    }
    
    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        if (Disabled) return;
        
        var files = new List<IBrowserFile>();
        foreach (var file in e.GetMultipleFiles(Multiple ? int.MaxValue : 1))
        {
            if (file.Size <= MaxFileSize)
            {
                files.Add(file);
            }
        }
        
        if (Multiple)
        {
            UploadedFiles.AddRange(files);
        }
        else
        {
            UploadedFiles = files;
        }
        
        if (UploadedFilesChanged.HasDelegate)
        {
            await UploadedFilesChanged.InvokeAsync(UploadedFiles);
        }
    }
    
    private void HandleDragOver(DragEventArgs e)
    {
        if (Disabled) return;
        IsDragging = true;
    }
    
    private void HandleDragLeave()
    {
        IsDragging = false;
    }
    
    private async Task HandleDrop(DragEventArgs e)
    {
        if (Disabled) return;
        IsDragging = false;
        // File drop handling would require JS interop
    }
    
    private async Task RemoveFile(IBrowserFile file)
    {
        UploadedFiles.Remove(file);
        if (UploadedFilesChanged.HasDelegate)
        {
            await UploadedFilesChanged.InvokeAsync(UploadedFiles);
        }
    }
    
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}

