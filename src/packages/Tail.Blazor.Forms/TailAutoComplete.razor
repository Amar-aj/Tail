@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms

<div class="@GetContainerClasses()">
    <label class="@GetLabelClasses()">@Label</label>
    <div class="relative">
        <input 
            type="text"
            class="@GetInputClasses()"
            @bind="inputValue"
            @bind:event="oninput"
            @onfocus="ShowSuggestions"
            @onblur="HideSuggestions"
            placeholder="@Placeholder"
            disabled="@Disabled"
            @attributes="AdditionalAttributes" />
        
        @if (IsOpen && FilteredSuggestions.Any())
        {
            <div class="@GetDropdownClasses()">
                @foreach (var (suggestion, index) in FilteredSuggestions.Take(MaxSuggestions).Select((s, i) => (s, i)))
                {
                    <div 
                        class="@GetSuggestionClasses(index)"
                        @onclick="() => SelectSuggestion(suggestion)"
                        @onmouseenter="() => HighlightedIndex = index">
                        @if (SuggestionTemplate != null)
                        {
                            @SuggestionTemplate(suggestion)
                        }
                        else
                        {
                            @GetSuggestionText(suggestion)
                        }
                    </div>
                }
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">@HelperText</p>
    }
    @if (!string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">@ErrorText</p>
    }
</div>

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public List<object> Suggestions { get; set; } = new();
    [Parameter] public Func<object, string>? TextSelector { get; set; }
    [Parameter] public Func<object, string>? ValueSelector { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorText { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public int MaxSuggestions { get; set; } = 10;
    [Parameter] public RenderFragment<object>? SuggestionTemplate { get; set; }
    [Parameter] public bool CaseSensitive { get; set; } = false;
    
    private string inputValue = "";
    private bool IsOpen { get; set; }
    private int HighlightedIndex { get; set; } = -1;
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (inputValue != Value)
        {
            inputValue = Value ?? "";
        }
    }
    
    private IEnumerable<object> FilteredSuggestions
    {
        get
        {
            if (string.IsNullOrWhiteSpace(inputValue))
                return Suggestions;
            
            var comparison = CaseSensitive ? StringComparison.Ordinal : StringComparison.OrdinalIgnoreCase;
            return Suggestions.Where(s => GetSuggestionText(s).Contains(inputValue, comparison));
        }
    }
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "w-full relative" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetLabelClasses() => "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1";
    
    private string GetInputClasses()
    {
        var classes = new List<string>
        {
            "w-full px-3 py-2 border rounded-lg",
            "bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100",
            "focus:outline-none focus:ring-2 focus:ring-blue-500"
        };
        
        if (Disabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }
        else if (!string.IsNullOrEmpty(ErrorText))
        {
            classes.Add("border-red-300 dark:border-red-700");
        }
        else
        {
            classes.Add("border-gray-300 dark:border-gray-700");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetDropdownClasses() => 
        "absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-60 overflow-y-auto";
    
    private string GetSuggestionClasses(int index)
    {
        var classes = new List<string>
        {
            "px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700"
        };
        
        if (index == HighlightedIndex)
        {
            classes.Add("bg-gray-100 dark:bg-gray-700");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetSuggestionText(object suggestion)
    {
        if (TextSelector != null)
        {
            return TextSelector(suggestion);
        }
        return suggestion.ToString() ?? "";
    }
    
    private async Task ShowSuggestions()
    {
        if (!Disabled && FilteredSuggestions.Any())
        {
            IsOpen = true;
        }
    }
    
    private void HideSuggestions()
    {
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() => IsOpen = false));
    }
    
    private async Task SelectSuggestion(object suggestion)
    {
        var value = ValueSelector != null ? ValueSelector(suggestion) : GetSuggestionText(suggestion);
        inputValue = value;
        Value = value;
        
        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(Value);
        }
        
        IsOpen = false;
    }
}

