@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@using Microsoft.AspNetCore.Components.Web

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@Id" class="@GetLabelClasses()">
            @Label
            @if (Required)
            {
                <span class="ml-1" style="color: var(--color-danger)">*</span>
            }
        </label>
    }
    <div class="relative">
        <div class="@GetInputContainerClasses()" style="@GetInputContainerStyle()">
            <div class="flex items-center gap-2 flex-1">
                @if (!string.IsNullOrEmpty(IconStart))
                {
                    <span class="text-base" style="color: var(--color-text-muted)">@IconStart</span>
                }
                <input 
                    type="text"
                    id="@Id"
                    class="@GetInputClasses()"
                    style="@GetInputStyle()"
                    value="@GetDisplayValue()"
                    placeholder="@Placeholder"
                    readonly="true"
                    @onclick="ToggleCalendar"
                    @onfocus="HandleFocus"
                    @onblur="HandleBlur"
                    disabled="@Disabled"
                    @attributes="AdditionalAttributes" />
            </div>
            <button 
                type="button"
                class="@GetCalendarButtonClasses()"
                style="@GetCalendarButtonStyle()"
                @onclick="ToggleCalendar"
                disabled="@Disabled">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </button>
        </div>
        
        @if (ShowCalendar && !Disabled)
        {
            <div class="@GetCalendarClasses()" style="@GetCalendarStyle()">
                <div class="@GetCalendarHeaderClasses()">
                    <button type="button" class="@GetNavButtonClasses()" @onclick="PreviousMonth" @onclick:preventDefault="true">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <select class="@GetMonthSelectClasses()" @bind="currentMonth" @bind:after="UpdateCalendar">
                            @for (int i = 1; i <= 12; i++)
                            {
                                <option value="@i">@GetMonthName(i)</option>
                            }
                        </select>
                        <select class="@GetYearSelectClasses()" @bind="currentYear" @bind:after="UpdateCalendar">
                            @for (int year = MinYear; year <= MaxYear; year++)
                            {
                                <option value="@year">@year</option>
                            }
                        </select>
                    </div>
                    <button type="button" class="@GetNavButtonClasses()" @onclick="NextMonth" @onclick:preventDefault="true">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                
                <div class="@GetPresetsClasses()">
                    @foreach (var preset in Presets)
                    {
                        <button 
                            type="button"
                            class="@GetPresetButtonClasses()"
                            @onclick="() => ApplyPreset(preset)"
                            @onclick:preventDefault="true">
                            @preset.Label
                        </button>
                    }
                </div>
                
                <div class="@GetCalendarGridClasses()">
                    <div class="@GetWeekdayHeaderClasses()">
                        @foreach (var day in weekdays)
                        {
                            <div class="@GetWeekdayClasses()">@day</div>
                        }
                    </div>
                    <div class="@GetDaysGridClasses()">
                        @foreach (var day in calendarDays)
                        {
                            <button 
                                type="button"
                                class="@GetDayButtonClasses(day)"
                                style="@GetDayButtonStyle(day)"
                                @onclick="() => SelectDay(day)"
                                @onclick:preventDefault="true"
                                disabled="@(day.IsDisabled || day.IsOtherMonth)">
                                @day.Day
                            </button>
                        }
                    </div>
                </div>
                
                <div class="@GetFooterClasses()">
                    <div class="flex items-center gap-2 text-sm" style="color: var(--color-text-secondary);">
                        <span>Start: @(StartDate?.ToString("MMM dd, yyyy") ?? "Not selected")</span>
                        <span>â†’</span>
                        <span>End: @(EndDate?.ToString("MMM dd, yyyy") ?? "Not selected")</span>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            type="button"
                            class="@GetActionButtonClasses()"
                            @onclick="ClearSelection"
                            @onclick:preventDefault="true">
                            Clear
                        </button>
                        <button 
                            type="button"
                            class="@GetActionButtonClasses(true)"
                            @onclick="ApplySelection"
                            @onclick:preventDefault="true">
                            Apply
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
    @if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-danger)">@ErrorMessage</p>
    }
    @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-text-secondary)">@HelperText</p>
    }
</div>

@code {
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public EventCallback<DateTime?> StartDateChanged { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    [Parameter] public EventCallback<DateTime?> EndDateChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public string? IconStart { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowError { get; set; } = true;
    [Parameter] public InputSize Size { get; set; } = InputSize.Md;
    [Parameter] public DateTime? MinDate { get; set; }
    [Parameter] public DateTime? MaxDate { get; set; }
    [Parameter] public List<DateRangePreset> Presets { get; set; } = new();
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    private bool ShowCalendar { get; set; }
    private DateTime? tempStartDate;
    private DateTime? tempEndDate;
    private DateTime currentDate;
    private int currentMonth;
    private int currentYear;
    private List<CalendarDay> calendarDays = new();
    private readonly string[] weekdays = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private int MinYear => MinDate?.Year ?? DateTime.Now.Year - 10;
    private int MaxYear => MaxDate?.Year ?? DateTime.Now.Year + 10;

    protected override void OnInitialized()
    {
        currentDate = DateTime.Now;
        currentMonth = currentDate.Month;
        currentYear = currentDate.Year;
        tempStartDate = StartDate;
        tempEndDate = EndDate;
        
        // Default presets
        if (Presets.Count == 0)
        {
            Presets = new List<DateRangePreset>
            {
                new DateRangePreset { Label = "Today", GetRange = () => (DateTime.Today, DateTime.Today) },
                new DateRangePreset { Label = "Last 7 Days", GetRange = () => (DateTime.Today.AddDays(-6), DateTime.Today) },
                new DateRangePreset { Label = "Last 30 Days", GetRange = () => (DateTime.Today.AddDays(-29), DateTime.Today) },
                new DateRangePreset { Label = "This Month", GetRange = () => (new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1), DateTime.Today) },
                new DateRangePreset { Label = "Last Month", GetRange = () => {
                    var firstDay = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1).AddMonths(-1);
                    var lastDay = firstDay.AddMonths(1).AddDays(-1);
                    return (firstDay, lastDay);
                }},
                new DateRangePreset { Label = "This Year", GetRange = () => (new DateTime(DateTime.Today.Year, 1, 1), DateTime.Today) }
            };
        }
        
        UpdateCalendar();
    }

    protected override void OnParametersSet()
    {
        if (tempStartDate != StartDate || tempEndDate != EndDate)
        {
            tempStartDate = StartDate;
            tempEndDate = EndDate;
        }
    }

    private void UpdateCalendar()
    {
        calendarDays.Clear();
        var firstDay = new DateTime(currentYear, currentMonth, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);
        var startDay = firstDay.DayOfWeek;
        
        // Add days from previous month
        var prevMonth = firstDay.AddMonths(-1);
        var daysInPrevMonth = DateTime.DaysInMonth(prevMonth.Year, prevMonth.Month);
        for (int i = (int)startDay - 1; i >= 0; i--)
        {
            var day = daysInPrevMonth - i;
            calendarDays.Add(new CalendarDay 
            { 
                Day = day, 
                Date = new DateTime(prevMonth.Year, prevMonth.Month, day),
                IsOtherMonth = true 
            });
        }
        
        // Add days from current month
        for (int day = 1; day <= lastDay.Day; day++)
        {
            var date = new DateTime(currentYear, currentMonth, day);
            calendarDays.Add(new CalendarDay 
            { 
                Day = day, 
                Date = date,
                IsDisabled = (MinDate.HasValue && date < MinDate.Value) || (MaxDate.HasValue && date > MaxDate.Value)
            });
        }
        
        // Add days from next month to fill the grid
        var remainingDays = 42 - calendarDays.Count;
        for (int day = 1; day <= remainingDays; day++)
        {
            var nextMonth = firstDay.AddMonths(1);
            calendarDays.Add(new CalendarDay 
            { 
                Day = day, 
                Date = new DateTime(nextMonth.Year, nextMonth.Month, day),
                IsOtherMonth = true 
            });
        }
    }

    private void ToggleCalendar()
    {
        if (!Disabled)
        {
            ShowCalendar = !ShowCalendar;
            if (ShowCalendar)
            {
                tempStartDate = StartDate;
                tempEndDate = EndDate;
            }
        }
    }

    private void SelectDay(CalendarDay day)
    {
        if (day.IsDisabled || day.IsOtherMonth) return;
        
        if (!tempStartDate.HasValue || (tempStartDate.HasValue && tempEndDate.HasValue))
        {
            // Start new selection
            tempStartDate = day.Date;
            tempEndDate = null;
        }
        else if (tempStartDate.HasValue && !tempEndDate.HasValue)
        {
            // Complete selection
            if (day.Date >= tempStartDate.Value)
            {
                tempEndDate = day.Date;
            }
            else
            {
                tempEndDate = tempStartDate.Value;
                tempStartDate = day.Date;
            }
        }
    }

    private void ApplySelection()
    {
        StartDate = tempStartDate;
        EndDate = tempEndDate;
        if (StartDateChanged.HasDelegate)
        {
            StartDateChanged.InvokeAsync(StartDate);
        }
        if (EndDateChanged.HasDelegate)
        {
            EndDateChanged.InvokeAsync(EndDate);
        }
        ShowCalendar = false;
    }

    private void ClearSelection()
    {
        tempStartDate = null;
        tempEndDate = null;
        StartDate = null;
        EndDate = null;
        if (StartDateChanged.HasDelegate)
        {
            StartDateChanged.InvokeAsync(null);
        }
        if (EndDateChanged.HasDelegate)
        {
            EndDateChanged.InvokeAsync(null);
        }
    }

    private void ApplyPreset(DateRangePreset preset)
    {
        var (start, end) = preset.GetRange();
        tempStartDate = start;
        tempEndDate = end;
        ApplySelection();
    }

    private void PreviousMonth()
    {
        if (currentMonth == 1)
        {
            currentMonth = 12;
            currentYear--;
        }
        else
        {
            currentMonth--;
        }
        UpdateCalendar();
    }

    private void NextMonth()
    {
        if (currentMonth == 12)
        {
            currentMonth = 1;
            currentYear++;
        }
        else
        {
            currentMonth++;
        }
        UpdateCalendar();
    }

    private string GetDisplayValue()
    {
        if (StartDate.HasValue && EndDate.HasValue)
        {
            return $"{StartDate.Value:MMM dd, yyyy} - {EndDate.Value:MMM dd, yyyy}";
        }
        else if (StartDate.HasValue)
        {
            return $"{StartDate.Value:MMM dd, yyyy} - ...";
        }
        return string.Empty;
    }

    private string GetMonthName(int month)
    {
        return new DateTime(2000, month, 1).ToString("MMMM");
    }

    private void HandleFocus(FocusEventArgs e)
    {
        // Keep calendar open on focus
    }

    private void HandleBlur(FocusEventArgs e)
    {
        // Close calendar after a delay to allow clicks
        Task.Delay(200).ContinueWith(_ => InvokeAsync(() => { ShowCalendar = false; StateHasChanged(); }));
    }

    // Styling methods using global CSS variables
    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }

    private string GetLabelClasses()
    {
        return "block text-sm font-medium mb-1";
    }

    private string GetInputContainerClasses()
    {
        return "flex items-center gap-2 rounded-lg border transition-all";
    }

    private string GetInputContainerStyle()
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface);",
            "border-color: var(--color-border);",
            "transition: border-color var(--transition-fast), box-shadow var(--transition-fast);"
        };
        
        if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
        {
            styles.Add("border-color: var(--color-danger);");
        }
        
        return string.Join(" ", styles);
    }

    private string GetInputClasses()
    {
        var classes = new List<string> { "flex-1 bg-transparent border-0 outline-none" };
        
        classes.Add(Size switch
        {
            InputSize.Sm => "px-3 py-1.5 text-sm",
            InputSize.Md => "px-4 py-2 text-base",
            InputSize.Lg => "px-5 py-2.5 text-lg",
            _ => "px-4 py-2 text-base"
        });
        
        return string.Join(" ", classes);
    }

    private string GetInputStyle()
    {
        return "color: var(--color-text-primary);";
    }

    private string GetCalendarButtonClasses()
    {
        return "p-2 rounded-lg transition-all hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none";
    }

    private string GetCalendarButtonStyle()
    {
        return "color: var(--color-text-secondary);";
    }

    private string GetCalendarClasses()
    {
        return "absolute z-50 mt-1 rounded-lg shadow-lg border";
    }

    private string GetCalendarStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            box-shadow: var(--shadow-lg);
            min-width: 320px;
        ";
    }

    private string GetCalendarHeaderClasses()
    {
        return "flex items-center justify-between p-4 border-b";
    }

    private string GetNavButtonClasses()
    {
        return "p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors";
    }

    private string GetMonthSelectClasses()
    {
        return "px-2 py-1 rounded border text-sm bg-transparent";
    }

    private string GetYearSelectClasses()
    {
        return "px-2 py-1 rounded border text-sm bg-transparent";
    }

    private string GetPresetsClasses()
    {
        return "p-2 border-b flex flex-wrap gap-2";
    }

    private string GetPresetButtonClasses()
    {
        return "px-3 py-1 text-xs rounded-lg transition-colors hover:bg-gray-100 dark:hover:bg-gray-700";
    }

    private string GetCalendarGridClasses()
    {
        return "p-4";
    }

    private string GetWeekdayHeaderClasses()
    {
        return "grid grid-cols-7 gap-1 mb-2";
    }

    private string GetWeekdayClasses()
    {
        return "text-center text-xs font-semibold py-1";
    }

    private string GetDaysGridClasses()
    {
        return "grid grid-cols-7 gap-1";
    }

    private string GetDayButtonClasses(CalendarDay day)
    {
        var classes = new List<string> { "w-9 h-9 rounded-lg text-sm transition-all" };
        
        if (day.IsOtherMonth)
        {
            classes.Add("opacity-30");
        }
        
        if (day.IsDisabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }
        else
        {
            classes.Add("hover:bg-gray-100 dark:hover:bg-gray-700");
        }
        
        return string.Join(" ", classes);
    }

    private string GetDayButtonStyle(CalendarDay day)
    {
        var styles = new List<string>();
        
        if (IsInRange(day.Date))
        {
            styles.Add("background-color: color-mix(in srgb, var(--color-primary) 20%, transparent);");
            styles.Add("color: var(--color-primary);");
        }
        else if (IsStartDate(day.Date) || IsEndDate(day.Date))
        {
            styles.Add("background-color: var(--color-primary);");
            styles.Add("color: white;");
        }
        else
        {
            styles.Add("color: var(--color-text-primary);");
        }
        
        return string.Join(" ", styles);
    }

    private bool IsInRange(DateTime date)
    {
        if (!tempStartDate.HasValue || !tempEndDate.HasValue) return false;
        return date >= tempStartDate.Value && date <= tempEndDate.Value;
    }

    private bool IsStartDate(DateTime date)
    {
        return tempStartDate.HasValue && date.Date == tempStartDate.Value.Date;
    }

    private bool IsEndDate(DateTime date)
    {
        return tempEndDate.HasValue && date.Date == tempEndDate.Value.Date;
    }

    private string GetFooterClasses()
    {
        return "p-4 border-t flex items-center justify-between";
    }

    private string GetActionButtonClasses(bool primary = false)
    {
        var classes = new List<string> { "px-4 py-2 rounded-lg text-sm font-medium transition-colors" };
        
        if (primary)
        {
            classes.Add("text-white");
        }
        else
        {
            classes.Add("hover:bg-gray-100 dark:hover:bg-gray-700");
        }
        
        return string.Join(" ", classes);
    }

    private string GetActionButtonStyle(bool primary = false)
    {
        if (primary)
        {
            return "background-color: var(--color-primary);";
        }
        return "color: var(--color-text-secondary);";
    }

    private class CalendarDay
    {
        public int Day { get; set; }
        public DateTime Date { get; set; }
        public bool IsOtherMonth { get; set; }
        public bool IsDisabled { get; set; }
    }
}

