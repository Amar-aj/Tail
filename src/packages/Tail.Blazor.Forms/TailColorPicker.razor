@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms

<div class="@GetContainerClasses()">
    <label class="@GetLabelClasses()">@Label</label>
    <div class="relative">
        <div class="flex items-center space-x-2">
            <div 
                class="@GetColorBoxClasses()"
                style="background-color: @SelectedColor;"
                @onclick="TogglePicker">
            </div>
            <input 
                type="text"
                class="@GetInputClasses()"
                @bind="colorHex"
                @bind:event="oninput"
                placeholder="#000000"
                disabled="@Disabled" />
        </div>
        
        @if (IsOpen)
        {
            <div class="@GetPickerClasses()">
                <div class="grid grid-cols-8 gap-1 mb-4">
                    @foreach (var color in PresetColors)
                    {
                        <button
                            type="button"
                            class="@GetPresetColorClasses(color)"
                            style="background-color: @color;"
                            @onclick="() => SelectColor(color)"
                            title="@color">
                        </button>
                    }
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Red</label>
                    <input 
                        type="range" 
                        min="0" 
                        max="255" 
                        @bind="r"
                        @bind:event="oninput"
                        class="w-full" />
                    <span class="text-sm text-gray-500 dark:text-gray-400">@r</span>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Green</label>
                    <input 
                        type="range" 
                        min="0" 
                        max="255" 
                        @bind="g"
                        @bind:event="oninput"
                        class="w-full" />
                    <span class="text-sm text-gray-500 dark:text-gray-400">@g</span>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Blue</label>
                    <input 
                        type="range" 
                        min="0" 
                        max="255" 
                        @bind="b"
                        @bind:event="oninput"
                        class="w-full" />
                    <span class="text-sm text-gray-500 dark:text-gray-400">@b</span>
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button 
                        type="button"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700"
                        @onclick="ClosePicker">
                        Cancel
                    </button>
                    <button 
                        type="button"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
                        @onclick="ApplyColor">
                        Apply
                    </button>
                </div>
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">@HelperText</p>
    }
    @if (!string.IsNullOrEmpty(ErrorText))
    {
        <p class="mt-1 text-sm text-red-600 dark:text-red-400">@ErrorText</p>
    }
</div>

@code {
    [Parameter] public string Value { get; set; } = "#000000";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorText { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public List<string> PresetColors { get; set; } = new()
    {
        "#000000", "#FFFFFF", "#FF0000", "#00FF00", "#0000FF",
        "#FFFF00", "#FF00FF", "#00FFFF", "#808080", "#800000",
        "#008000", "#000080", "#808000", "#800080", "#008080"
    };
    
    private bool IsOpen { get; set; }
    private string colorHex = "#000000";
    private int r = 0, g = 0, b = 0;
    private string SelectedColor => $"#{r:X2}{g:X2}{b:X2}";
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (colorHex != Value)
        {
            colorHex = Value;
            ParseColor(Value);
        }
    }
    
    private string GetContainerClasses()
    {
        var classes = new List<string> { "w-full relative" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }
    
    private string GetLabelClasses() => "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1";
    
    private string GetColorBoxClasses() => 
        "w-12 h-12 border-2 border-gray-300 dark:border-gray-700 rounded cursor-pointer hover:border-gray-400 dark:hover:border-gray-600";
    
    private string GetInputClasses()
    {
        var classes = new List<string>
        {
            "flex-1 px-3 py-2 border rounded-lg",
            "bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100",
            "focus:outline-none focus:ring-2 focus:ring-blue-500"
        };
        
        if (Disabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }
        else if (!string.IsNullOrEmpty(ErrorText))
        {
            classes.Add("border-red-300 dark:border-red-700");
        }
        else
        {
            classes.Add("border-gray-300 dark:border-gray-700");
        }
        
        return string.Join(" ", classes);
    }
    
    private string GetPickerClasses() => 
        "absolute z-50 mt-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg p-4 w-64";
    
    private string GetPresetColorClasses(string color) => 
        "w-8 h-8 border border-gray-300 dark:border-gray-700 rounded cursor-pointer hover:scale-110 transition-transform";
    
    private void TogglePicker()
    {
        if (!Disabled)
        {
            IsOpen = !IsOpen;
        }
    }
    
    private void ClosePicker()
    {
        IsOpen = false;
        ParseColor(Value);
    }
    
    private async Task ApplyColor()
    {
        Value = SelectedColor;
        colorHex = Value;
        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(Value);
        }
        IsOpen = false;
    }
    
    private void SelectColor(string color)
    {
        ParseColor(color);
    }
    
    private void ParseColor(string hex)
    {
        if (string.IsNullOrEmpty(hex) || !hex.StartsWith("#")) return;
        
        try
        {
            hex = hex.TrimStart('#');
            if (hex.Length == 6)
            {
                r = Convert.ToInt32(hex.Substring(0, 2), 16);
                g = Convert.ToInt32(hex.Substring(2, 2), 16);
                b = Convert.ToInt32(hex.Substring(4, 2), 16);
            }
        }
        catch
        {
            // Invalid color format
        }
    }
}

