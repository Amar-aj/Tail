@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@using Microsoft.AspNetCore.Components.Web

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@Id" class="@GetLabelClasses()">
            @Label
            @if (Required)
            {
                <span class="ml-1" style="color: var(--color-danger)">*</span>
            }
        </label>
    }
    <div class="@GetContainerClasses()" style="@GetContainerStyle()">
        <div class="@GetTagsContainerClasses()">
            @foreach (var tag in Tags)
            {
                <span class="@GetTagClasses()" style="@GetTagStyle()">
                    @tag
                    @if (!Disabled)
                    {
                        <button 
                            type="button"
                            class="@GetRemoveButtonClasses()"
                            style="@GetRemoveButtonStyle()"
                            @onclick="() => RemoveTag(tag)"
                            @onclick:preventDefault="true"
                            aria-label="Remove @tag">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    }
                </span>
            }
            @if (Tags.Count < MaxTags || MaxTags == 0)
            {
                <input 
                    type="text"
                    id="@Id"
                    class="@GetInputClasses()"
                    style="@GetInputStyle()"
                    value="@currentInput"
                    placeholder="@(Tags.Count == 0 ? Placeholder : "")"
                    @oninput="HandleInput"
                    @onkeydown="HandleKeyDown"
                    @onblur="HandleBlur"
                    disabled="@Disabled"
                    @attributes="AdditionalAttributes" />
            }
        </div>
        @if (ShowSuggestions && Suggestions.Any() && showSuggestionsList)
        {
            <div class="@GetSuggestionsClasses()" style="@GetSuggestionsStyle()">
                @foreach (var suggestion in filteredSuggestions)
                {
                    <button 
                        type="button"
                        class="@GetSuggestionButtonClasses()"
                        @onclick="() => AddTag(suggestion)"
                        @onclick:preventDefault="true">
                        @suggestion
                    </button>
                }
            </div>
        }
    </div>
    @if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-danger)">@ErrorMessage</p>
    }
    @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-text-secondary)">@HelperText</p>
    }
</div>

@code {
    [Parameter] public List<string> Tags { get; set; } = new();
    [Parameter] public EventCallback<List<string>> TagsChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Placeholder { get; set; } = "Add tags...";
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowError { get; set; } = true;
    [Parameter] public InputSize Size { get; set; } = InputSize.Md;
    [Parameter] public int MaxTags { get; set; } = 0; // 0 = unlimited
    [Parameter] public List<string> Suggestions { get; set; } = new();
    [Parameter] public bool ShowSuggestions { get; set; } = true;
    [Parameter] public bool AllowDuplicates { get; set; } = false;
    [Parameter] public Func<string, bool>? Validator { get; set; }
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    private string currentInput = string.Empty;
    private bool showSuggestionsList = false;
    private List<string> filteredSuggestions = new();

    private void HandleInput(ChangeEventArgs e)
    {
        currentInput = e.Value?.ToString() ?? string.Empty;
        
        if (ShowSuggestions && Suggestions.Any())
        {
            filteredSuggestions = Suggestions
                .Where(s => s.Contains(currentInput, StringComparison.OrdinalIgnoreCase) && 
                           !Tags.Contains(s))
                .Take(5)
                .ToList();
            showSuggestionsList = !string.IsNullOrEmpty(currentInput) && filteredSuggestions.Any();
        }
        
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == "Comma")
        {
            if (!string.IsNullOrWhiteSpace(currentInput))
            {
                await AddTagFromInput();
            }
        }
        else if (e.Key == "Backspace" && string.IsNullOrEmpty(currentInput) && Tags.Any())
        {
            // Remove last tag on backspace when input is empty
            await RemoveTag(Tags.Last());
        }
    }

    private async Task HandleBlur(FocusEventArgs e)
    {
        // Add tag on blur if input has value
        if (!string.IsNullOrWhiteSpace(currentInput))
        {
            await AddTagFromInput();
        }
        showSuggestionsList = false;
    }

    private async Task AddTagFromInput()
    {
        var tag = currentInput.Trim();
        if (string.IsNullOrWhiteSpace(tag)) return;
        
        // Validate
        if (Validator != null && !Validator(tag))
        {
            return;
        }
        
        await AddTag(tag);
        currentInput = string.Empty;
        showSuggestionsList = false;
    }

    private async Task AddTag(string tag)
    {
        if (string.IsNullOrWhiteSpace(tag)) return;
        
        // Check duplicates
        if (!AllowDuplicates && Tags.Contains(tag))
        {
            return;
        }
        
        // Check max tags
        if (MaxTags > 0 && Tags.Count >= MaxTags)
        {
            return;
        }
        
        Tags.Add(tag);
        if (TagsChanged.HasDelegate)
        {
            await TagsChanged.InvokeAsync(Tags);
        }
        currentInput = string.Empty;
        showSuggestionsList = false;
    }

    private async Task RemoveTag(string tag)
    {
        if (Tags.Remove(tag))
        {
            if (TagsChanged.HasDelegate)
            {
                await TagsChanged.InvokeAsync(Tags);
            }
        }
    }

    // Styling methods using global CSS variables
    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }

    private string GetLabelClasses()
    {
        return "block text-sm font-medium mb-1";
    }

    private string GetContainerClasses()
    {
        return "relative";
    }

    private string GetContainerStyle()
    {
        return string.Empty;
    }

    private string GetTagsContainerClasses()
    {
        return "flex flex-wrap items-center gap-2 p-2 rounded-lg border min-h-[2.5rem]";
    }

    private string GetTagsContainerStyle()
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface);",
            "border-color: var(--color-border);",
            "transition: border-color var(--transition-fast), box-shadow var(--transition-fast);"
        };
        
        if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
        {
            styles.Add("border-color: var(--color-danger);");
        }
        
        return string.Join(" ", styles);
    }

    private string GetTagClasses()
    {
        var classes = new List<string>
        {
            "inline-flex items-center gap-1 px-2 py-1 rounded-lg text-sm font-medium"
        };
        
        classes.Add(Size switch
        {
            InputSize.Sm => "px-1.5 py-0.5 text-xs",
            InputSize.Md => "px-2 py-1 text-sm",
            InputSize.Lg => "px-3 py-1.5 text-base",
            _ => "px-2 py-1 text-sm"
        });
        
        return string.Join(" ", classes);
    }

    private string GetTagStyle()
    {
        return @"
            background-color: color-mix(in srgb, var(--color-primary) 20%, transparent);
            color: var(--color-primary);
        ";
    }

    private string GetRemoveButtonClasses()
    {
        return "inline-flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors";
    }

    private string GetRemoveButtonStyle()
    {
        return "color: var(--color-text-secondary);";
    }

    private string GetInputClasses()
    {
        var classes = new List<string> { "flex-1 min-w-[120px] bg-transparent border-0 outline-none" };
        
        classes.Add(Size switch
        {
            InputSize.Sm => "px-1 py-0.5 text-sm",
            InputSize.Md => "px-2 py-1 text-base",
            InputSize.Lg => "px-3 py-1.5 text-lg",
            _ => "px-2 py-1 text-base"
        });
        
        return string.Join(" ", classes);
    }

    private string GetInputStyle()
    {
        return "color: var(--color-text-primary);";
    }

    private string GetSuggestionsClasses()
    {
        return "absolute z-50 mt-1 rounded-lg border shadow-lg max-h-48 overflow-y-auto";
    }

    private string GetSuggestionsStyle()
    {
        return @"
            background-color: var(--color-surface);
            border-color: var(--color-border);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
        ";
    }

    private string GetSuggestionButtonClasses()
    {
        return "w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors";
    }
}


