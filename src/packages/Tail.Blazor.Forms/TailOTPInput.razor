@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Forms
@using Microsoft.AspNetCore.Components.Web

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="@GetLabelClasses()">
            @Label
            @if (Required)
            {
                <span class="ml-1" style="color: var(--color-danger)">*</span>
            }
        </label>
    }
    <div class="@GetContainerClasses()" style="@GetContainerStyle()">
        @for (int i = 0; i < Length; i++)
        {
            var index = i;
            <input 
                type="text"
                class="@GetInputClasses(index)"
                style="@GetInputStyle(index)"
                value="@(index < otpValues.Length && otpValues[index] != '\0' ? otpValues[index].ToString() : "")"
                maxlength="1"
                @oninput="@((ChangeEventArgs e) => HandleInput(index, e))"
                @onkeydown="@((KeyboardEventArgs e) => HandleKeyDown(index, e))"
                @onpaste="@((ClipboardEventArgs e) => HandlePaste(e))"
                @onfocus="HandleFocus"
                disabled="@Disabled"
                @attributes="GetInputAttributes(index)" />
        }
    </div>
    @if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-danger)">@ErrorMessage</p>
    }
    @if (!string.IsNullOrEmpty(HelperText) && string.IsNullOrEmpty(ErrorMessage))
    {
        <p class="mt-1 text-sm" style="color: var(--color-text-secondary)">@HelperText</p>
    }
    @if (ShowVerificationStatus && !string.IsNullOrEmpty(VerificationStatus))
    {
        <p class="mt-1 text-sm flex items-center gap-1" style="color: @GetVerificationStatusColor()">
            @if (VerificationStatus == "Verified")
            {
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            }
            @VerificationStatus
        </p>
    }
</div>

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public string? VerificationStatus { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool ShowError { get; set; } = true;
    [Parameter] public bool ShowVerificationStatus { get; set; } = true;
    [Parameter] public bool AutoFocus { get; set; } = true;
    [Parameter] public bool NumericOnly { get; set; } = true;
    [Parameter] public int Length { get; set; } = 6;
    [Parameter] public InputSize Size { get; set; } = InputSize.Md;
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    private char[] otpValues = Array.Empty<char>();
    private List<ElementReference> inputRefs = new();

    protected override void OnInitialized()
    {
        otpValues = new char[Length];
        inputRefs = new List<ElementReference>(Length);
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Value) && Value.Length == Length)
        {
            otpValues = Value.ToCharArray();
        }
        else if (string.IsNullOrEmpty(Value))
        {
            otpValues = new char[Length];
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Auto-focus will be handled by browser default behavior
        await Task.CompletedTask;
    }

    private async Task HandleInput(int index, ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        if (string.IsNullOrEmpty(input)) return;

        var charValue = input.Last();
        
        // Validate input
        if (NumericOnly && !char.IsDigit(charValue))
        {
            return;
        }

        otpValues[index] = charValue;
        UpdateValue();

        // Move to next input
        if (index < Length - 1)
        {
            await FocusInput(index + 1);
        }
        else
        {
            // All inputs filled, trigger verification if callback exists
            if (OnComplete.HasDelegate)
            {
                await OnComplete.InvokeAsync(GetCurrentValue());
            }
        }
    }

    private async Task HandleKeyDown(int index, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && string.IsNullOrEmpty(otpValues[index].ToString()))
        {
            // Move to previous input
            if (index > 0)
            {
                otpValues[index - 1] = '\0';
                await FocusInput(index - 1);
                UpdateValue();
            }
        }
        else if (e.Key == "ArrowLeft" && index > 0)
        {
            await FocusInput(index - 1);
        }
        else if (e.Key == "ArrowRight" && index < Length - 1)
        {
            await FocusInput(index + 1);
        }
    }

    private async Task HandlePaste(ClipboardEventArgs e)
    {
        // Paste handling - the browser will paste into the focused input
        // We can process it after the paste event
        await Task.CompletedTask;
    }

    private async Task HandleFocus(FocusEventArgs e)
    {
        // Select all text when focused
        // This is handled by the browser
    }

    private async Task FocusInput(int index)
    {
        if (index >= 0 && index < Length)
        {
            try
            {
                // Focus will be handled by JavaScript or we can use a ref
                await InvokeAsync(StateHasChanged);
            }
            catch { }
        }
    }

    private void UpdateValue()
    {
        var newValue = new string(otpValues).TrimEnd('\0');
        if (newValue.Length == Length)
        {
            Value = newValue;
            if (ValueChanged.HasDelegate)
            {
                ValueChanged.InvokeAsync(Value);
            }
        }
        else
        {
            Value = newValue.Length > 0 ? newValue : null;
            if (ValueChanged.HasDelegate)
            {
                ValueChanged.InvokeAsync(Value);
            }
        }
    }

    private string GetCurrentValue()
    {
        return new string(otpValues).TrimEnd('\0');
    }

    private Dictionary<string, object> GetInputAttributes(int index)
    {
        var attrs = new Dictionary<string, object>();
        attrs["id"] = $"{Id}_input_{index}";
        attrs["autocomplete"] = "off";
        attrs["inputmode"] = NumericOnly ? "numeric" : "text";
        attrs["pattern"] = NumericOnly ? "[0-9]" : null;
        return attrs;
    }

    private string GetVerificationStatusColor()
    {
        return VerificationStatus switch
        {
            "Verified" => "var(--color-success)",
            "Invalid" => "var(--color-danger)",
            "Verifying" => "var(--color-warning)",
            _ => "var(--color-text-secondary)"
        };
    }

    // Styling methods using global CSS variables
    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(CssClass))
        {
            classes.Add(CssClass);
        }
        return string.Join(" ", classes);
    }

    private string GetLabelClasses()
    {
        return "block text-sm font-medium mb-2";
    }

    private string GetContainerClasses()
    {
        return "flex items-center justify-center gap-2";
    }

    private string GetContainerStyle()
    {
        return string.Empty;
    }

    private string GetInputClasses(int index)
    {
        var classes = new List<string>
        {
            "text-center font-semibold rounded-lg border transition-all",
            "focus:outline-none focus:ring-2 focus:ring-offset-2"
        };
        
        classes.Add(Size switch
        {
            InputSize.Sm => "w-10 h-10 text-sm",
            InputSize.Md => "w-12 h-12 text-base",
            InputSize.Lg => "w-14 h-14 text-lg",
            _ => "w-12 h-12 text-base"
        });
        
        if (ShowError && !string.IsNullOrEmpty(ErrorMessage))
        {
            classes.Add("border-red-300 dark:border-red-700 focus:ring-red-500");
        }
        else
        {
            classes.Add("border-gray-300 dark:border-gray-700 focus:ring-blue-500");
        }
        
        return string.Join(" ", classes);
    }

    private string GetInputStyle(int index)
    {
        var styles = new List<string>
        {
            "background-color: var(--color-surface);",
            "color: var(--color-text-primary);",
            "transition: border-color var(--transition-fast), box-shadow var(--transition-fast);"
        };
        
        if (!string.IsNullOrEmpty(otpValues[index].ToString()) && otpValues[index] != '\0')
        {
            styles.Add("border-color: var(--color-primary);");
            styles.Add("box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary) 20%, transparent);");
        }
        
        return string.Join(" ", styles);
    }

    [Parameter] public EventCallback<string> OnComplete { get; set; }
}

