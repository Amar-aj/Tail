@inherits Tail.Blazor.Core.TailComponentBase
@namespace Tail.Blazor.Visualization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Tail.Blazor.Visualization.Models
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetContainerClasses()" style="@GetContainerStyle()" id="@flowchartId" @attributes="AdditionalAttributes">
    <!-- Toolbar -->
    @if (ShowToolbar)
    {
        <div class="@GetToolbarClasses()" style="@GetToolbarStyle()">
            <button 
                type="button"
                class="@GetToolbarButtonClasses()"
                style="@GetToolbarButtonStyle()"
                @onclick="AddNode"
                title="Add Node">
                âž• Add Node
            </button>
            <button 
                type="button"
                class="@GetToolbarButtonClasses()"
                style="@GetToolbarButtonStyle()"
                @onclick="AutoLayout"
                title="Auto Layout">
                ðŸ”„ Auto Layout
            </button>
            <button 
                type="button"
                class="@GetToolbarButtonClasses()"
                style="@GetToolbarButtonStyle()"
                @onclick="ExportDiagram"
                title="Export">
                ðŸ“¥ Export
            </button>
            @if (AllowZoom)
            {
                <div class="flex items-center gap-2">
                    <button 
                        type="button"
                        class="@GetToolbarButtonClasses()"
                        style="@GetToolbarButtonStyle()"
                        @onclick="ZoomOut"
                        title="Zoom Out">
                        âž–
                    </button>
                    <span class="@GetZoomLabelClasses()" style="@GetZoomLabelStyle()">@((int)(zoomLevel * 100))%</span>
                    <button 
                        type="button"
                        class="@GetToolbarButtonClasses()"
                        style="@GetToolbarButtonStyle()"
                        @onclick="ZoomIn"
                        title="Zoom In">
                        âž•
                    </button>
                </div>
            }
        </div>
    }

    <!-- Canvas Area -->
    <div class="@GetCanvasAreaClasses()" style="@GetCanvasAreaStyle()" @onwheel="HandleWheel">
        <svg class="@GetSvgClasses()" style="@GetSvgStyle()" id="@svgId">
            <!-- Edges/Lines -->
            @foreach (var edge in Edges)
            {
                @RenderEdge(edge)
            }

            <!-- Nodes -->
            @foreach (var node in Nodes)
            {
                @RenderNode(node)
            }
        </svg>
    </div>
</div>

@code {
    [Parameter] public List<FlowchartNode> Nodes { get; set; } = new();
    [Parameter] public List<FlowchartEdge> Edges { get; set; } = new();
    [Parameter] public FlowchartLayout Layout { get; set; } = FlowchartLayout.Manual;
    [Parameter] public bool ShowToolbar { get; set; } = true;
    [Parameter] public bool AllowDragDrop { get; set; } = true;
    [Parameter] public bool AllowZoom { get; set; } = true;
    [Parameter] public bool AllowAutoRouting { get; set; } = true;
    [Parameter] public double ZoomLevel { get; set; } = 1.0;
    [Parameter] public EventCallback<FlowchartNode> OnNodeClick { get; set; }
    [Parameter] public EventCallback<FlowchartEdge> OnEdgeClick { get; set; }
    [Parameter] public EventCallback<FlowchartNode> OnNodeAdded { get; set; }

    private string flowchartId = $"flowchart-{Guid.NewGuid():N}";
    private string svgId = $"flowchart-svg-{Guid.NewGuid():N}";
    private IJSObjectReference? jsModule;
    private double zoomLevel = 1.0;
    private double panX = 0;
    private double panY = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./_content/Tail.Blazor.Visualization/flowchart.js");
                await jsModule.InvokeVoidAsync("initializeFlowchart", flowchartId, svgId, DotNetObjectReference.Create(this), AllowDragDrop);
            }
            catch { }
        }

        if (jsModule != null && AllowAutoRouting)
        {
            await UpdateEdgeRouting();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        zoomLevel = ZoomLevel;
        if (jsModule != null && AllowAutoRouting)
        {
            await UpdateEdgeRouting();
        }
    }

    private async Task UpdateEdgeRouting()
    {
        if (jsModule == null) return;
        await jsModule.InvokeVoidAsync("updateEdgeRouting", svgId, Nodes, Edges);
    }

    private RenderFragment RenderNode(FlowchartNode node)
    {
        return builder =>
        {
            builder.OpenElement(0, "g");
            builder.AddAttribute(1, "class", "flowchart-node cursor-pointer");
            builder.AddAttribute(2, "data-node-id", node.Id);
            builder.AddAttribute(3, "transform", $"translate({node.X}, {node.Y})");
            builder.AddAttribute(4, "onclick", EventCallback.Factory.Create(this, () => HandleNodeClick(node)));

            // Node shape based on type
            var nodeType = node.Type ?? "rectangle";
            if (nodeType == "circle")
            {
                builder.OpenElement(5, "circle");
                builder.AddAttribute(6, "r", node.Width / 2);
                builder.AddAttribute(7, "fill", node.Color ?? "var(--color-primary)");
                builder.AddAttribute(8, "stroke", "var(--color-border)");
                builder.AddAttribute(9, "stroke-width", "2");
                builder.CloseElement();
            }
            else if (nodeType == "diamond")
            {
                var points = $"{node.Width / 2},0 {node.Width},{node.Height / 2} {node.Width / 2},{node.Height} 0,{node.Height / 2}";
                builder.OpenElement(10, "polygon");
                builder.AddAttribute(11, "points", points);
                builder.AddAttribute(12, "fill", node.Color ?? "var(--color-primary)");
                builder.AddAttribute(13, "stroke", "var(--color-border)");
                builder.AddAttribute(14, "stroke-width", "2");
                builder.CloseElement();
            }
            else // rectangle or default
            {
                var rx = nodeType == "roundedRectangle" ? 8 : 0;
                builder.OpenElement(15, "rect");
                builder.AddAttribute(16, "width", node.Width);
                builder.AddAttribute(17, "height", node.Height);
                builder.AddAttribute(18, "rx", rx);
                builder.AddAttribute(19, "fill", node.Color ?? "var(--color-surface-2)");
                builder.AddAttribute(20, "stroke", "var(--color-border)");
                builder.AddAttribute(21, "stroke-width", "2");
                builder.CloseElement();
            }

            // Node label/content
            builder.OpenElement(22, "text");
            builder.AddAttribute(23, "x", node.Width / 2);
            builder.AddAttribute(24, "y", node.Height / 2);
            builder.AddAttribute(25, "text-anchor", "middle");
            builder.AddAttribute(26, "dominant-baseline", "middle");
            builder.AddAttribute(27, "fill", "var(--color-text-primary)");
            builder.AddAttribute(28, "font-size", "14");
            builder.AddAttribute(29, "font-weight", "500");
            if (!string.IsNullOrEmpty(node.Icon))
            {
                builder.AddContent(30, node.Icon + " ");
            }
            builder.AddContent(31, node.Label);
            builder.CloseElement();

            builder.CloseElement();
        };
    }

    private RenderFragment RenderEdge(FlowchartEdge edge)
    {
        return builder =>
        {
            var sourceNode = Nodes.FirstOrDefault(n => n.Id == edge.SourceNodeId);
            var targetNode = Nodes.FirstOrDefault(n => n.Id == edge.TargetNodeId);
            if (sourceNode == null || targetNode == null) return;

            // Calculate edge start and end points
            var startX = sourceNode.X + sourceNode.Width / 2;
            var startY = sourceNode.Y + sourceNode.Height / 2;
            var endX = targetNode.X + targetNode.Width / 2;
            var endY = targetNode.Y + targetNode.Height / 2;

            builder.OpenElement(0, "g");
            builder.AddAttribute(1, "class", "flowchart-edge");
            builder.AddAttribute(2, "data-edge-id", edge.Id);
            builder.AddAttribute(3, "onclick", EventCallback.Factory.Create(this, () => HandleEdgeClick(edge)));

            // Edge line
            var strokeDashArray = edge.Style switch
            {
                "dashed" => "5,5",
                "dotted" => "2,2",
                _ => "none"
            };

            builder.OpenElement(4, "line");
            builder.AddAttribute(5, "x1", startX);
            builder.AddAttribute(6, "y1", startY);
            builder.AddAttribute(7, "x2", endX);
            builder.AddAttribute(8, "y2", endY);
            builder.AddAttribute(9, "stroke", edge.Color ?? "var(--color-border)");
            builder.AddAttribute(10, "stroke-width", "2");
            builder.AddAttribute(11, "stroke-dasharray", strokeDashArray);
            builder.AddAttribute(12, "marker-end", edge.Directed ? "url(#arrowhead)" : "");
            builder.CloseElement();

            // Edge label
            if (!string.IsNullOrEmpty(edge.Label))
            {
                var labelX = (startX + endX) / 2;
                var labelY = (startY + endY) / 2 - 10;
                builder.OpenElement(13, "text");
                builder.AddAttribute(14, "x", labelX);
                builder.AddAttribute(15, "y", labelY);
                builder.AddAttribute(16, "text-anchor", "middle");
                builder.AddAttribute(17, "fill", "var(--color-text-primary)");
                builder.AddAttribute(18, "font-size", "12");
                builder.AddAttribute(19, "pointer-events", "none");
                builder.AddContent(20, edge.Label);
                builder.CloseElement();
            }

            builder.CloseElement();
        };
    }


    private async Task HandleNodeClick(FlowchartNode node)
    {
        if (OnNodeClick.HasDelegate)
        {
            await OnNodeClick.InvokeAsync(node);
        }
    }

    private async Task HandleEdgeClick(FlowchartEdge edge)
    {
        if (OnEdgeClick.HasDelegate)
        {
            await OnEdgeClick.InvokeAsync(edge);
        }
    }

    private async Task AddNode()
    {
        var newNode = new FlowchartNode
        {
            Label = $"Node {Nodes.Count + 1}",
            X = 100 + (Nodes.Count * 150),
            Y = 100,
            Type = "rectangle"
        };
        Nodes.Add(newNode);
        if (OnNodeAdded.HasDelegate)
        {
            await OnNodeAdded.InvokeAsync(newNode);
        }
        StateHasChanged();
    }

    private async Task AutoLayout()
    {
        if (jsModule == null) return;
        await jsModule.InvokeVoidAsync("applyAutoLayout", svgId, Nodes, Layout.ToString());
        StateHasChanged();
    }

    private async Task ExportDiagram()
    {
        if (jsModule == null) return;
        await jsModule.InvokeVoidAsync("exportFlowchart", svgId);
    }

    private void ZoomIn()
    {
        zoomLevel = Math.Min(zoomLevel + 0.1, 3.0);
        ZoomLevel = zoomLevel;
        StateHasChanged();
    }

    private void ZoomOut()
    {
        zoomLevel = Math.Max(zoomLevel - 0.1, 0.5);
        ZoomLevel = zoomLevel;
        StateHasChanged();
    }

    private void HandleWheel(WheelEventArgs e)
    {
        if (!AllowZoom) return;
        
        if (e.DeltaY < 0)
        {
            ZoomIn();
        }
        else
        {
            ZoomOut();
        }
    }

    // Styling methods
    private string GetContainerClasses() => "w-full h-full border rounded-lg overflow-hidden";
    private string GetContainerStyle() => "border-color: var(--color-border); background-color: var(--color-surface);";

    private string GetToolbarClasses() => "flex items-center justify-between gap-2 p-3 border-b flex-wrap";
    private string GetToolbarStyle() => "border-color: var(--color-border); background-color: var(--color-surface-2);";

    private string GetToolbarButtonClasses() => "px-3 py-1 rounded-md border text-sm transition-colors duration-150";
    private string GetToolbarButtonStyle() => "background-color: var(--color-surface); border-color: var(--color-border); color: var(--color-text-primary); hover:bg-gray-100 dark:hover:bg-gray-800;";

    private string GetZoomLabelClasses() => "text-sm font-medium min-w-[50px] text-center";
    private string GetZoomLabelStyle() => "color: var(--color-text-primary);";

    private string GetCanvasAreaClasses() => "relative w-full overflow-auto";
    private string GetCanvasAreaStyle() => "height: 600px; background-color: var(--color-surface-2);";

    private string GetSvgClasses() => "w-full h-full";
    private string GetSvgStyle() => $"transform: scale({zoomLevel}); transform-origin: top left;";

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            try
            {
                await jsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

