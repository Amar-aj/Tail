@inherits TailComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Tail.Blazor.AudioRecorder

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium mb-1" style="color: var(--color-text-primary);">
            @Label
        </label>
    }
    <div class="border border-gray-300 rounded-lg p-4 transition-all duration-200" style="border-color: var(--color-border, #d1d5db); background-color: var(--color-surface);">
        <div class="flex items-center justify-center gap-4 mb-4">
            @if (IsRecording)
            {
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-sm" style="color: var(--color-text-primary);">Recording... @RecordingTime</span>
                </div>
                @if (MaxRecordingTime > 0)
                {
                    <div class="w-full bg-gray-200 rounded-full h-2" style="background-color: var(--color-border);">
                        <div class="h-2 rounded-full transition-all duration-200" 
                             style="width: @GetProgressWidth()%; background-color: var(--color-primary);"></div>
                    </div>
                }
            }
            else if (AudioData != null)
            {
                <audio controls src="@AudioData" class="max-w-md"></audio>
            }
            else
            {
                <p class="text-sm" style="color: var(--color-text-secondary);">No recording yet</p>
            }
        </div>
        <div class="flex justify-center gap-2">
            @if (!IsRecording && AudioData == null)
            {
                <button 
                    type="button"
                    class="@GetButtonClasses()"
                    @onclick="StartRecording"
                    disabled="@Disabled"
                    aria-label="@(AriaLabel ?? "Start recording")"
                    title="@(Tooltip ?? "Start recording")">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg>
                    Start Recording
                </button>
            }
            else if (IsRecording)
            {
                <button 
                    type="button"
                    class="@GetButtonClasses()"
                    @onclick="StopRecording"
                    disabled="@Disabled"
                    aria-label="@(AriaLabel ?? "Stop recording")"
                    title="@(Tooltip ?? "Stop recording")">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    Stop Recording
                </button>
            }
            else
            {
                <button 
                    type="button"
                    class="@GetButtonClasses()"
                    @onclick="StartRecording"
                    disabled="@Disabled"
                    aria-label="@(AriaLabel ?? "Record again")"
                    title="@(Tooltip ?? "Record again")">
                    Record Again
                </button>
                <button 
                    type="button"
                    class="@GetButtonClasses()"
                    @onclick="ClearRecording"
                    disabled="@Disabled"
                    aria-label="@(AriaLabel ?? "Clear recording")"
                    title="@(Tooltip ?? "Clear recording")">
                    Clear
                </button>
            }
        </div>
    </div>
</div>

@code {
    private bool IsRecording { get; set; }
    private string? AudioData { get; set; }
    private string RecordingTime { get; set; } = "00:00";
    private System.Threading.Timer? recordingTimer;
    private int recordingSeconds = 0;

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public AudioRecorderSize Size { get; set; } = AudioRecorderSize.Md;
    [Parameter] public string? Label { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public int MaxRecordingTime { get; set; } = 300; // 5 minutes default
    [Parameter] public AudioQuality Quality { get; set; } = AudioQuality.Medium;
    [Parameter] public string? AriaLabel { get; set; }
    [Parameter] public string? Tooltip { get; set; }
    [Parameter] public EventCallback OnRecordingStart { get; set; }
    [Parameter] public EventCallback OnRecordingStop { get; set; }
    [Parameter] public EventCallback OnRecordingClear { get; set; }

    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }
        return string.Join(" ", classes);
    }

    private string GetButtonClasses()
    {
        var classes = new List<string> { "inline-flex", "items-center", "gap-2", "px-4", "py-2", "rounded-lg", "font-medium", "transition-all", "duration-200", "focus:outline-none", "focus:ring-2", "focus:ring-offset-2", "hover:scale-105" };

        classes.Add(Size switch
        {
            AudioRecorderSize.Xs => "text-xs",
            AudioRecorderSize.Sm => "text-sm",
            AudioRecorderSize.Md => "text-base",
            AudioRecorderSize.Lg => "text-lg",
            AudioRecorderSize.Xl => "text-xl",
            _ => "text-base"
        });

        if (Disabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }
        else
        {
            classes.Add("hover:shadow-md");
            classes.Add($"bg-primary text-on-primary hover:bg-primary/90 focus:ring-primary");
        }

        return string.Join(" ", classes);
    }

    private string GetProgressWidth()
    {
        if (MaxRecordingTime <= 0) return "0";
        return Math.Min(100, (recordingSeconds * 100) / MaxRecordingTime).ToString();
    }

    private void StartRecording()
    {
        if (Disabled) return;
        IsRecording = true;
        recordingSeconds = 0;
        RecordingTime = "00:00";
        recordingTimer = new System.Threading.Timer(_ =>
        {
            recordingSeconds++;
            RecordingTime = $"{recordingSeconds / 60:D2}:{recordingSeconds % 60:D2}";
            if (recordingSeconds >= MaxRecordingTime && MaxRecordingTime > 0)
            {
                StopRecording();
            }
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
        OnRecordingStart.InvokeAsync();
    }

    private async Task StopRecording()
    {
        IsRecording = false;
        recordingTimer?.Dispose();
        recordingTimer = null;
        // Placeholder for actual audio data
        AudioData = $"data:audio/wav;base64,{Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes("placeholder"))}";
        Value = AudioData;
        await ValueChanged.InvokeAsync(Value);
        await OnRecordingStop.InvokeAsync();
    }

    private async Task ClearRecording()
    {
        AudioData = null;
        Value = null;
        RecordingTime = "00:00";
        recordingSeconds = 0;
        await ValueChanged.InvokeAsync(Value);
        await OnRecordingClear.InvokeAsync();
    }
}

