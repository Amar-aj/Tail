@inherits TailComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Tail.Blazor.FileUpload

<div class="@GetWrapperClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label class="block text-sm font-medium mb-1">
            @Label
            @if (Required)
            {
                <span class="text-red-500">*</span>
            }
        </label>
    }
    <div 
        class="@GetDropZoneClasses()"
        @ondrop="HandleDrop"
        @ondragover="HandleDragOver"
        @ondragleave="HandleDragLeave"
        style="@GetDropZoneStyles()">
        <input 
            type="file"
            class="hidden"
            id="@FileInputId"
            @ref="fileInput"
            @onchange="HandleFileChange"
            multiple="@Multiple"
            accept="@Accept"
            disabled="@Disabled" />
        <label for="@FileInputId" class="cursor-pointer">
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-2 text-sm text-gray-600">
                    <span class="font-semibold">Click to upload</span> or drag and drop
                </p>
                @if (!string.IsNullOrEmpty(Accept))
                {
                    <p class="text-xs text-gray-500 mt-1">@Accept</p>
                }
            </div>
        </label>
    </div>
    @if (SelectedFiles != null && SelectedFiles.Any())
    {
        <div class="mt-2 space-y-1">
            @foreach (var file in SelectedFiles)
            {
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span class="text-sm">@file.Name</span>
                    <button type="button" @onclick="() => RemoveFile(file)" class="text-red-500 hover:text-red-700">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            }
        </div>
    }
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="text-sm text-red-600 mt-1">
            @ErrorMessage
        </div>
    }
</div>

@code {
    private string FileInputId { get; set; } = Guid.NewGuid().ToString();
    private ElementReference fileInput;
    private bool IsDragOver { get; set; }
    private List<IBrowserFile> SelectedFiles { get; set; } = new();

    [Parameter] public EventCallback<IBrowserFile[]> FilesChanged { get; set; }
    [Parameter] public FileUploadSize Size { get; set; } = FileUploadSize.Md;
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Accept { get; set; }
    [Parameter] public bool Multiple { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string? Style { get; set; }

    private string GetWrapperClasses()
    {
        var classes = new List<string> { "w-full" };
        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }
        return string.Join(" ", classes);
    }

    private string GetDropZoneClasses()
    {
        var classes = new List<string> { "border-2", "border-dashed", "rounded-lg", "p-6", "text-center", "transition-colors" };

        if (IsDragOver)
        {
            classes.Add("border-primary bg-primary bg-opacity-10");
        }
        else
        {
            classes.Add("border-gray-300");
        }

        if (Disabled)
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }

        return string.Join(" ", classes);
    }

    private string GetDropZoneStyles()
    {
        var styles = new List<string>();
        styles.Add($"border-color: var(--color-border, #d1d5db)");
        if (IsDragOver)
        {
            styles.Add($"border-color: var(--color-primary)");
            styles.Add($"background-color: rgba(var(--color-primary-rgb), 0.1)");
        }
        if (!string.IsNullOrEmpty(Style))
        {
            styles.Add(Style);
        }
        return string.Join("; ", styles);
    }

    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        if (Multiple)
        {
            SelectedFiles = e.GetMultipleFiles(int.MaxValue).ToList();
        }
        else
        {
            SelectedFiles = new List<IBrowserFile> { e.File };
        }
        await FilesChanged.InvokeAsync(SelectedFiles.ToArray());
    }

    private void HandleDragOver(DragEventArgs e)
    {
        if (!Disabled)
        {
            IsDragOver = true;
        }
    }

    private void HandleDragLeave()
    {
        IsDragOver = false;
    }

    private async Task HandleDrop(DragEventArgs e)
    {
        IsDragOver = false;
        // File drop handling would require JavaScript interop
    }

    private async Task RemoveFile(IBrowserFile file)
    {
        SelectedFiles.Remove(file);
        await FilesChanged.InvokeAsync(SelectedFiles.ToArray());
    }
}

