@inherits TailComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Tail.Blazor.NotificationCenter

<div class="@GetContainerClasses()" style="@GetContainerStyles()">
    <div class="flex items-center justify-between mb-4 pb-4 border-b" style="border-color: var(--color-border, #e5e7eb);">
        <h3 class="text-lg font-semibold" style="color: var(--color-text-primary);">Notifications</h3>
        @if (Notifications.Any(n => !n.IsRead))
        {
            <button 
                type="button"
                class="text-sm text-primary hover:underline"
                @onclick="MarkAllAsRead"
                style="color: var(--color-primary);">
                Mark all as read
            </button>
        }
    </div>
    <div class="space-y-2 max-h-96 overflow-y-auto">
        @foreach (var notification in Notifications)
        {
            <div 
                class="@GetNotificationClasses(notification)"
                @onclick="() => HandleNotificationClick(notification)"
                style="@GetNotificationStyles(notification)">
                <div class="flex items-start">
                    @if (!string.IsNullOrEmpty(notification.Icon))
                    {
                        <div class="flex-shrink-0 mr-3 text-lg">@notification.Icon</div>
                    }
                    <div class="flex-1">
                        <div class="font-semibold mb-1">@notification.Title</div>
                        @if (!string.IsNullOrEmpty(notification.Message))
                        {
                            <div class="text-sm opacity-75">@notification.Message</div>
                        }
                        <div class="text-xs opacity-50 mt-1">@notification.Timestamp.ToString("g")</div>
                    </div>
                    @if (notification.Dismissible)
                    {
                        <button 
                            type="button"
                            class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600"
                            @onclick:stopPropagation="true"
                            @onclick="() => RemoveNotification(notification)">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    }
                </div>
            </div>
        }
        @if (!Notifications.Any())
        {
            <div class="text-center py-8 text-gray-500">No notifications</div>
        }
    </div>
</div>

@code {
    [Parameter] public List<NotificationItem> Notifications { get; set; } = new();
    [Parameter] public NotificationCenterPlacement Placement { get; set; } = NotificationCenterPlacement.TopRight;
    [Parameter] public EventCallback<NotificationItem> OnNotificationClick { get; set; }
    [Parameter] public string? Style { get; set; }

    private string GetContainerClasses()
    {
        var classes = new List<string> { "bg-white", "rounded-lg", "shadow-xl", "border", "p-4", "w-80" };

        classes.Add(Placement switch
        {
            NotificationCenterPlacement.TopRight => "fixed top-4 right-4 z-50",
            NotificationCenterPlacement.TopLeft => "fixed top-4 left-4 z-50",
            NotificationCenterPlacement.BottomRight => "fixed bottom-4 right-4 z-50",
            NotificationCenterPlacement.BottomLeft => "fixed bottom-4 left-4 z-50",
            _ => "fixed top-4 right-4 z-50"
        });

        return string.Join(" ", classes);
    }

    private string GetContainerStyles()
    {
        var styles = new List<string>();
        styles.Add($"background-color: var(--color-surface, white)");
        styles.Add($"border-color: var(--color-border, #e5e7eb)");
        if (!string.IsNullOrEmpty(Style))
        {
            styles.Add(Style);
        }
        return string.Join("; ", styles);
    }

    private string GetNotificationClasses(NotificationItem notification)
    {
        var classes = new List<string> { "p-3", "rounded-lg", "border", "cursor-pointer", "transition-colors", "hover:bg-gray-50" };

        if (!notification.IsRead)
        {
            classes.Add("bg-blue-50 border-blue-200");
        }
        else
        {
            classes.Add("bg-gray-50 border-gray-200");
        }

        return string.Join(" ", classes);
    }

    private string GetNotificationStyles(NotificationItem notification)
    {
        var styles = new List<string>();
        if (!notification.IsRead)
        {
            styles.Add($"background-color: rgba(var(--color-info-rgb), 0.1)");
            styles.Add($"border-color: var(--color-info)");
        }
        return string.Join("; ", styles);
    }

    private async Task HandleNotificationClick(NotificationItem notification)
    {
        notification.IsRead = true;
        await OnNotificationClick.InvokeAsync(notification);
    }

    private void RemoveNotification(NotificationItem notification)
    {
        Notifications.Remove(notification);
    }

    private void MarkAllAsRead()
    {
        foreach (var notification in Notifications)
        {
            notification.IsRead = true;
        }
    }
}

@code {
    public class NotificationItem
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Title { get; set; } = string.Empty;
        public string? Message { get; set; }
        public ToastVariant Variant { get; set; } = ToastVariant.Info;
        public string? Icon { get; set; }
        public DateTime Timestamp { get; set; } = DateTime.Now;
        public bool IsRead { get; set; }
        public bool Dismissible { get; set; } = true;
    }

    public enum ToastVariant
    {
        Success,
        Warning,
        Error,
        Info
    }
}

