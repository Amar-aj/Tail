@inherits TailComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Tail.Blazor.ToastContainer

<div class="@GetContainerClasses()" style="@GetContainerStyles()">
    @foreach (var toast in Toasts)
    {
        <div class="@GetToastClasses(toast)" style="@GetToastStyles(toast)">
            <div class="flex items-start">
                @if (!string.IsNullOrEmpty(toast.Title))
                {
                    <div class="font-semibold mb-1">@toast.Title</div>
                }
                <div>@toast.Message</div>
                @if (toast.Dismissible)
                {
                    <button 
                        type="button"
                        class="flex-shrink-0 ml-3 text-current opacity-50 hover:opacity-100 focus:outline-none"
                        @onclick="() => RemoveToast(toast)"
                        aria-label="Dismiss">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    private List<ToastItem> Toasts { get; set; } = new();

    [Parameter] public ToastPosition Position { get; set; } = ToastPosition.TopRight;
    [Parameter] public int MaxToasts { get; set; } = 5;
    [Parameter] public string? Style { get; set; }

    private string GetContainerClasses()
    {
        var classes = new List<string> { "fixed", "z-50", "space-y-2" };

        if (Position == ToastPosition.TopLeft || Position == ToastPosition.TopRight || Position == ToastPosition.TopCenter)
        {
            classes.Add("top-4");
        }
        else
        {
            classes.Add("bottom-4");
        }

        if (Position == ToastPosition.TopLeft || Position == ToastPosition.BottomLeft)
        {
            classes.Add("left-4");
        }
        else if (Position == ToastPosition.TopRight || Position == ToastPosition.BottomRight)
        {
            classes.Add("right-4");
        }
        else
        {
            classes.Add("left-1/2 transform -translate-x-1/2");
        }

        return string.Join(" ", classes);
    }

    private string GetContainerStyles()
    {
        var styles = new List<string>();
        styles.Add($"max-width: 400px");
        if (!string.IsNullOrEmpty(Style))
        {
            styles.Add(Style);
        }
        return string.Join("; ", styles);
    }

    public void ShowToast(string message, string? title = null, ToastVariant variant = ToastVariant.Info, int? autoDismissAfter = 5000)
    {
        if (Toasts.Count >= MaxToasts)
        {
            Toasts.RemoveAt(0);
        }

        Toasts.Add(new ToastItem
        {
            Message = message,
            Title = title,
            Variant = variant,
            AutoDismissAfter = autoDismissAfter,
            Dismissible = true
        });

        StateHasChanged();
    }

    private void RemoveToast(ToastItem toast)
    {
        Toasts.Remove(toast);
        StateHasChanged();
    }

    private string GetToastClasses(ToastItem toast)
    {
        var classes = new List<string> { "rounded-lg", "p-4", "shadow-lg", "border", "mb-2", "transition-all" };

        classes.Add(toast.Variant switch
        {
            ToastVariant.Success => "bg-green-50 border-green-200 text-green-800",
            ToastVariant.Warning => "bg-yellow-50 border-yellow-200 text-yellow-800",
            ToastVariant.Error => "bg-red-50 border-red-200 text-red-800",
            ToastVariant.Info => "bg-blue-50 border-blue-200 text-blue-800",
            _ => "bg-gray-50 border-gray-200 text-gray-800"
        });

        return string.Join(" ", classes);
    }

    private string GetToastStyles(ToastItem toast)
    {
        var styles = new List<string>();

        if (toast.Variant == ToastVariant.Success)
        {
            styles.Add($"background-color: rgba(var(--color-success-rgb), 0.1)");
            styles.Add($"border-color: var(--color-success)");
            styles.Add($"color: var(--color-success)");
        }
        else if (toast.Variant == ToastVariant.Warning)
        {
            styles.Add($"background-color: rgba(var(--color-warning-rgb), 0.1)");
            styles.Add($"border-color: var(--color-warning)");
            styles.Add($"color: var(--color-warning)");
        }
        else if (toast.Variant == ToastVariant.Error)
        {
            styles.Add($"background-color: rgba(var(--color-danger-rgb), 0.1)");
            styles.Add($"border-color: var(--color-danger)");
            styles.Add($"color: var(--color-danger)");
        }
        else
        {
            styles.Add($"background-color: rgba(var(--color-info-rgb), 0.1)");
            styles.Add($"border-color: var(--color-info)");
            styles.Add($"color: var(--color-info)");
        }

        return string.Join("; ", styles);
    }
}

@code {
    public class ToastItem
    {
        public string Message { get; set; } = string.Empty;
        public string? Title { get; set; }
        public ToastVariant Variant { get; set; } = ToastVariant.Info;
        public bool Dismissible { get; set; } = true;
        public int? AutoDismissAfter { get; set; } = 5000;
    }
}

