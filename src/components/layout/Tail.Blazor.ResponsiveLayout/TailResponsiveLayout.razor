@inherits TailComponentBase
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.JSInterop
@using Tail.Blazor.ResponsiveLayout
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<div class="@GetLayoutClasses()" style="@GetLayoutStyles()" id="@_layoutId">
    @if (ShowSidebar && LayoutMode != LayoutMode.FullWidth)
    {
        <!-- Sidebar Overlay (Mobile) -->
        @if (LayoutMode == LayoutMode.DrawerLeft || LayoutMode == LayoutMode.DrawerRight)
        {
            <div class="@GetOverlayClasses()" 
                 style="@GetOverlayStyles()"
                 @onclick="ToggleSidebar"
                 @onclick:stopPropagation="true"></div>
        }

        <!-- Sidebar -->
        <aside class="@GetSidebarClasses()" 
               style="@GetSidebarStyles()"
               id="@_sidebarId">
            @if (!string.IsNullOrEmpty(MobileMenuTitle))
            {
                <div class="p-4 border-b flex items-center justify-between flex-shrink-0" style="border-color: var(--color-border);">
                    <span class="font-semibold" style="color: var(--color-text-primary);">@MobileMenuTitle</span>
                    @if (ShowMenuToggle)
                    {
                        <TailButton Variant="ButtonVariant.Ghost" Size="ButtonSize.Sm" OnClick="ToggleSidebar" class="md:hidden">
                            ✕
                        </TailButton>
                    }
                </div>
            }
            <div class="@GetSidebarScrollAreaClasses()">
                @SidebarContent
            </div>
        </aside>
    }

    <!-- Main Content Area -->
    <div class="@GetMainContentClasses()" style="@GetMainContentStyles()">
        <!-- Header -->
        @if (ShowHeader)
        {
            <header class="@GetHeaderClasses()" 
                    style="@GetHeaderStyles()"
                    id="@_headerId">
                <div class="flex items-center justify-between w-full">
                    <div class="flex items-center gap-4">
                        @if (ShowMenuToggle && ShowSidebar)
                        {
                            <TailButton Variant="ButtonVariant.Ghost" Size="ButtonSize.Sm" OnClick="ToggleSidebar">
                                ☰
                            </TailButton>
                        }
                        @if (LogoTemplate != null)
                        {
                            <div class="flex items-center">
                                @LogoTemplate
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(AppName))
                        {
                            <h1 class="text-xl font-bold" style="color: var(--color-text-primary);" tabindex="-1">@AppName</h1>
                        }
                    </div>
                    <div class="flex items-center gap-2">
                        @if (ShowThemeToggle)
                        {
                            <TailThemeToggle />
                        }
                        @if (ShowAvatar && AvatarContent != null)
                        {
                            @AvatarContent
                        }
                    </div>
                </div>
            </header>
        }

        <!-- Page Content -->
        <main class="@GetContentClasses()" style="@GetContentStyles()">
            @ChildContent
        </main>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? LogoTemplate { get; set; }
    [Parameter] public RenderFragment? SidebarContent { get; set; }
    [Parameter] public RenderFragment? AvatarContent { get; set; }
    
    [Parameter] public string? AppName { get; set; }
    [Parameter] public bool ShowMenuToggle { get; set; } = true;
    [Parameter] public bool ShowThemeToggle { get; set; } = true;
    [Parameter] public bool ShowAvatar { get; set; } = false;
    [Parameter] public bool ShowSidebar { get; set; } = true;
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool StickyHeader { get; set; } = true;
    [Parameter] public bool HeaderShadow { get; set; } = true;
    [Parameter] public bool MenuOpenByDefault { get; set; } = true;
    [Parameter] public bool MenuOpenOnMobileByDefault { get; set; } = false;
    [Parameter] public bool AutoHideOnMobileAfterNavigation { get; set; } = true;
    [Parameter] public LayoutMode LayoutMode { get; set; } = LayoutMode.DrawerLeft;
    [Parameter] public DensityMode Density { get; set; } = DensityMode.Normal;
    [Parameter] public string? MobileMenuTitle { get; set; }
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool HideScrollbars { get; set; } = true;

    private string _layoutId = $"responsive-layout-{Guid.NewGuid():N}";
    private string _sidebarId = $"sidebar-{Guid.NewGuid():N}";
    private string _headerId = $"header-{Guid.NewGuid():N}";
    private bool _sidebarOpen = true;
    private bool _isMobile = false;
    private bool _mobileStateInitialized = false;

    protected override void OnInitialized()
    {
        // Initialize sidebar state: assume mobile initially if MenuOpenOnMobileByDefault is false
        // This ensures mobile users don't see the sidebar flash open on initial load
        if (!MenuOpenOnMobileByDefault)
        {
            // Assume mobile initially, so start closed
            _sidebarOpen = false;
        }
        else
        {
            _sidebarOpen = MenuOpenByDefault;
        }
        
        // Subscribe to navigation changes if auto-hide is enabled
        if (AutoHideOnMobileAfterNavigation)
        {
            Navigation.LocationChanged += OnLocationChanged;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateMobileState();
        }
    }

    private async Task UpdateMobileState()
    {
        try
        {
            var isMobile = await JSRuntime.InvokeAsync<bool>("eval", "window.innerWidth < 768");
            
            if (!_mobileStateInitialized || isMobile != _isMobile)
            {
                _isMobile = isMobile;
                _mobileStateInitialized = true;
                
                // Update sidebar state based on screen size
                if (_isMobile)
                {
                    // On mobile, use MenuOpenOnMobileByDefault
                    _sidebarOpen = MenuOpenOnMobileByDefault;
                }
                else
                {
                    // On desktop, use MenuOpenByDefault
                    _sidebarOpen = MenuOpenByDefault;
                }
                
                StateHasChanged();
            }
        }
        catch
        {
            // Ignore JS errors during SSR
        }
    }

    private void ToggleSidebar()
    {
        _sidebarOpen = !_sidebarOpen;
        StateHasChanged();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Auto-hide sidebar on mobile after navigation
        if (AutoHideOnMobileAfterNavigation && _isMobile && _sidebarOpen)
        {
            _sidebarOpen = false;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (AutoHideOnMobileAfterNavigation)
        {
            Navigation.LocationChanged -= OnLocationChanged;
        }
    }

    private string GetLayoutClasses()
    {
        var classes = new List<string> { "w-full", "h-screen", "flex", "overflow-hidden" };
        
        if (LayoutMode == LayoutMode.DrawerLeft || LayoutMode == LayoutMode.DrawerRight)
        {
            classes.Add("relative");
        }

        if (!string.IsNullOrEmpty(Class))
        {
            classes.Add(Class);
        }

        return string.Join(" ", classes);
    }

    private string GetLayoutStyles()
    {
        var styles = new List<string>();
        styles.Add("background-color: var(--color-background, #ffffff)");
        
        if (!string.IsNullOrEmpty(Style))
        {
            styles.Add(Style);
        }
        
        return string.Join("; ", styles);
    }

    private string GetSidebarClasses()
    {
        var classes = new List<string>();
        
        // Base width and layout classes
        classes.Add("w-64 flex-shrink-0 flex flex-col");
        classes.Add("border-r");
        
        if (LayoutMode == LayoutMode.DrawerLeft || LayoutMode == LayoutMode.DrawerRight)
        {
            // Drawer mode: fixed positioning on mobile, relative on desktop
            classes.Add("fixed top-0 h-full z-50 transform transition-transform duration-300 ease-in-out");
            
            // Position (left or right)
            if (LayoutMode == LayoutMode.DrawerLeft)
            {
                classes.Add("left-0");
                // Transform based on open state
                classes.Add(_sidebarOpen ? "translate-x-0" : "-translate-x-full");
            }
            else // DrawerRight
            {
                classes.Add("right-0");
                // Transform based on open state
                classes.Add(_sidebarOpen ? "translate-x-0" : "translate-x-full");
            }
            
            // On desktop (md and up), make it fixed and respect open state
            classes.Add("md:fixed md:top-0 md:h-full md:z-50");
        }
        else if (LayoutMode == LayoutMode.FixedLeft || LayoutMode == LayoutMode.FixedRight)
        {
            // Fixed mode: always visible, relative positioning
            classes.Add("relative");
            if (LayoutMode == LayoutMode.FixedLeft)
            {
                classes.Add("left-0");
            }
            else
            {
                classes.Add("right-0");
            }
        }
        else
        {
            // FullWidth or other modes
            classes.Add("relative");
        }

        return string.Join(" ", classes);
    }

    private string GetSidebarStyles()
    {
        var styles = new List<string>();
        styles.Add("background-color: var(--color-surface, #ffffff)");
        styles.Add("border-color: var(--color-border, #e5e7eb)");
        return string.Join("; ", styles);
    }

    private string GetOverlayClasses()
    {
        var classes = new List<string> { "fixed", "inset-0", "bg-black", "bg-opacity-50", "z-40", "md:hidden" };
        
        if (!_sidebarOpen)
        {
            classes.Add("hidden");
        }

        return string.Join(" ", classes);
    }

    private string GetOverlayStyles()
    {
        return "transition-opacity duration-300";
    }

    private string GetMainContentClasses()
    {
        var classes = new List<string> { "flex-1", "flex", "flex-col", "min-w-0", "overflow-hidden" };
        
        // Add margin for drawer mode on desktop when sidebar is open
        if ((LayoutMode == LayoutMode.DrawerLeft || LayoutMode == LayoutMode.DrawerRight) && !_isMobile && _sidebarOpen)
        {
            if (LayoutMode == LayoutMode.DrawerLeft)
            {
                classes.Add("md:ml-64");
            }
            else
            {
                classes.Add("md:mr-64");
            }
        }
        
        return string.Join(" ", classes);
    }

    private string GetMainContentStyles()
    {
        return "background-color: var(--color-background, #ffffff)";
    }

    private string GetHeaderClasses()
    {
        var classes = new List<string> { "w-full", "border-b", "p-4" };
        
        if (StickyHeader)
        {
            classes.Add("sticky top-0 z-30");
        }
        
        if (HeaderShadow)
        {
            classes.Add("shadow-sm");
        }

        return string.Join(" ", classes);
    }

    private string GetHeaderStyles()
    {
        var styles = new List<string>();
        styles.Add("background-color: var(--color-surface, #ffffff)");
        styles.Add("border-color: var(--color-border, #e5e7eb)");
        return string.Join("; ", styles);
    }

    private string GetContentClasses()
    {
        var classes = new List<string> { "flex-1", "overflow-y-auto" };
        
        classes.Add(Density switch
        {
            DensityMode.Compact => "md:p-2",
            DensityMode.Comfortable => "md:p-8",
            _ => "md:p-6"
        });

        if (HideScrollbars)
        {
            // Tailwind-only approach to visually hide scrollbars while keeping scroll
            classes.AddRange(new[] { "scroll-smooth", "pr-4", "-mr-4", "[scrollbar-width:none]", "[-ms-overflow-style:none]" });
            // Note: The pr/-mr trick moves the scrollbar out of view in WebKit-based browsers
        }
        else
        {
            // Ensure scrollbars are visible when HideScrollbars is false
            classes.AddRange(new[] { "scroll-smooth", "[scrollbar-width:auto]", "[-ms-overflow-style:auto]" });
        }

        return string.Join(" ", classes);
    }

    private string GetContentStyles()
    {
        return "background-color: var(--color-background, #ffffff)";
    }

    private string GetSidebarScrollAreaClasses()
    {
        var classes = new List<string> { "flex-1", "overflow-y-auto", "min-h-0" };
        if (HideScrollbars)
        {
            classes.AddRange(new[] { "scroll-smooth", "pr-4", "-mr-4", "[scrollbar-width:none]", "[-ms-overflow-style:none]" });
        }
        else
        {
            // Ensure scrollbars are visible when HideScrollbars is false
            classes.AddRange(new[] { "scroll-smooth", "[scrollbar-width:auto]", "[-ms-overflow-style:auto]" });
        }
        return string.Join(" ", classes);
    }
}
